<!-- src/app/features/traslados/pages/inventario-dashboard/inventario-dashboard.component.html -->
<div class="ux-page" [attr.aria-busy]="isLoading() ? 'true' : null">
  <!-- Sidebar -->
  <app-sidebar class="ux-sidebar"></app-sidebar>

  <!-- Main -->
  <div class="ux-main">
    <!-- Header -->
    <header class="ux-header">
      <div class="ux-header__title">
        <h1>üêî Inventario de Aves</h1>
        <p class="ux-header__subtitle">Gesti√≥n y control de inventarios de aves por lote</p>
      </div>
      <div class="ux-header__actions">
        <div class="traslado-type-selector" *ngIf="tieneLoteSeleccionadoCompleto">
          <button type="button"
                  class="btn btn--primary"
                  [class.btn--outline]="tipoTrasladoSeleccionado() !== 'lote'"
                  [title]="'Trasladar el lote completo a otra granja'"
                  (click)="abrirModalTrasladoLote()">
            üì¶ Traslado de Lote
          </button>
          <button type="button"
                  class="btn btn--primary"
                  [class.btn--outline]="tipoTrasladoSeleccionado() !== 'aves'"
                  [title]="'Registrar traslado o retiro de aves'"
                  (click)="abrirModalTrasladoRetiro('aves')">
            üêî Traslado de Aves
          </button>
          <button type="button"
                  class="btn btn--primary"
                  [class.btn--outline]="tipoTrasladoSeleccionado() !== 'huevos'"
                  [title]="'Registrar traslado o retiro de huevos'"
                  (click)="abrirModalTrasladoRetiro('huevos')">
            ü•ö Traslado de Huevos
          </button>
        </div>
        <button type="button"
                class="btn btn--outline"
                *ngIf="!tieneLoteSeleccionadoCompleto"
                disabled
                title="Primero selecciona un lote completo en los filtros">
          Selecciona un lote para trasladar
        </button>
      </div>
    </header>

    <!-- Resumen -->
    <section class="dashboard-summary" *ngIf="resumen()">
      <div class="summary-grid">
        <div class="summary-card summary-card--primary">
          <div class="summary-card__icon">üì¶</div>
          <div class="summary-card__content">
            <h3 class="summary-card__title">Total Lotes</h3>
            <p class="summary-card__value">{{ formatearNumero(resumen()!.totalLotes) }}</p>
          </div>
        </div>

        <div class="summary-card summary-card--success">
          <div class="summary-card__icon">üêî</div>
          <div class="summary-card__content">
            <h3 class="summary-card__title">Total Hembras</h3>
            <p class="summary-card__value">{{ formatearNumero(resumen()!.totalHembras) }}</p>
          </div>
        </div>

        <div class="summary-card summary-card--info">
          <div class="summary-card__icon">üêì</div>
          <div class="summary-card__content">
            <h3 class="summary-card__title">Total Machos</h3>
            <p class="summary-card__value">{{ formatearNumero(resumen()!.totalMachos) }}</p>
          </div>
        </div>

        <div class="summary-card summary-card--warning">
          <div class="summary-card__icon">üê•</div>
          <div class="summary-card__content">
            <h3 class="summary-card__title">Total Aves</h3>
            <p class="summary-card__value">{{ formatearNumero(resumen()!.totalAves) }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== FILTROS (ARRIBA) ========== -->
    <section class="filters-section">
      <header class="filters-header">
        <h3>üîç Filtros de B√∫squeda</h3>
        <button type="button" class="btn btn--ghost btn--sm" (click)="resetFilters()">
          üóëÔ∏è Limpiar
        </button>
      </header>

      <div class="filters-content">
        <div class="filter-row">
          <!-- Granja -->
          <div class="filter-group">
            <label for="f-farm" class="filter-label">üè† Granja <span class="text-red-500">*</span></label>
            <select id="f-farm" class="filter-control"
                    [(ngModel)]="selectedFarmId"
                    (ngModelChange)="onFarmChange($event)">
              <option [ngValue]="null">Todas las granjas</option>
              <option *ngFor="let f of farmsFiltered" [ngValue]="f.id">{{ f.name }}</option>
            </select>
          </div>

          <!-- N√∫cleo -->
          <div class="filter-group">
            <label for="f-nucleo" class="filter-label">üèóÔ∏è N√∫cleo</label>
            <select id="f-nucleo" class="filter-control"
                    [(ngModel)]="selectedNucleoId"
                    (ngModelChange)="onNucleoChange($event)"
                    [disabled]="!selectedFarmId">
              <option [ngValue]="null">Todos</option>
              <option *ngFor="let n of nucleosFiltered" [ngValue]="n.nucleoId">{{ n.nucleoNombre }}</option>
            </select>
          </div>

          <!-- Galp√≥n -->
          <div class="filter-group">
            <label for="f-galpon" class="filter-label">üêî Galp√≥n</label>
            <select id="f-galpon" class="filter-control"
                    [(ngModel)]="selectedGalponId"
                    (ngModelChange)="onGalponChange($event)"
                    [disabled]="!selectedFarmId">
              <option [ngValue]="null">Todos</option>
              <option *ngFor="let g of galponesFiltered" [ngValue]="g.galponId">{{ g.galponNombre }}</option>
            </select>
          </div>

          <!-- Lote (filtrado por galp√≥n seleccionado) -->
          <div class="filter-group">
            <label for="f-lote" class="filter-label">
              üìã Lote
              <small *ngIf="selectedGalponId && !lotesLoading()">
                ({{ lotesForGalpon().length }} encontrado{{ lotesForGalpon().length === 1 ? '' : 's' }})
              </small>
            </label>

            <select
              id="f-lote"
              class="filter-control"
              [disabled]="!selectedGalponId || lotesLoading() || lotesForGalpon().length === 0"
              [ngModel]="selectedLoteId"
              (ngModelChange)="onLoteSelectChange($event)">
              <option [ngValue]="null">Todos</option>
              <option *ngFor="let l of lotesForGalpon()" [ngValue]="l.id">
                {{ l.label }}
              </option>
            </select>

            <div class="text-muted text-xs mt-1" *ngIf="selectedGalponId && lotesLoading()">Cargando lotes‚Ä¶</div>
            <div class="text-muted text-xs mt-1" *ngIf="selectedGalponId && !lotesLoading() && lotesForGalpon().length === 0">
              No hay lotes para este galp√≥n.
            </div>
          </div>

          <!-- B√∫squeda -->
          <div class="filter-group">
            <label for="f-search" class="filter-label">üîç Buscar</label>
            <input id="f-search" type="text" class="filter-control"
                   placeholder="Buscar por lote, n√∫cleo, granja‚Ä¶"
                   [(ngModel)]="filtro" (ngModelChange)="recomputeList()" />
          </div>

          <!-- Ordenar por -->
          <div class="filter-group">
            <label for="f-sort-key" class="filter-label">üìä Ordenar por</label>
            <select id="f-sort-key" class="filter-control"
                    [ngModel]="sortKey" (ngModelChange)="onSortKeyChange($event)">
              <option [ngValue]="'edad'">Edad (d√≠as desde √∫ltimo conteo)</option>
              <option [ngValue]="'fecha'">Fecha de √∫ltimo conteo</option>
            </select>
          </div>

          <!-- Direcci√≥n -->
          <div class="filter-group">
            <label for="f-sort-dir" class="filter-label">‚ÜïÔ∏è Direcci√≥n</label>
            <select id="f-sort-dir" class="filter-control"
                    [ngModel]="sortDir" (ngModelChange)="onSortDirChange($event)">
              <option [ngValue]="'desc'">Descendente</option>
              <option [ngValue]="'asc'">Ascendente</option>
            </select>
          </div>
        </div>

        <!-- Chips Filtros -->
        <div class="filters-applied" *ngIf="tieneFiltrosAplicados()">
          <h4>Filtros Aplicados:</h4>
          <div class="filter-chips">
            <span class="filter-chip" *ngIf="selectedFarmId">
              Granja: {{ obtenerNombreGranja(selectedFarmId) }}
              <button type="button" (click)="onFarmChange(null)" aria-label="Quitar filtro granja">√ó</button>
            </span>
            <span class="filter-chip" *ngIf="selectedNucleoId">
              N√∫cleo: {{ nucleoMap[selectedNucleoId] }}
              <button type="button" (click)="onNucleoChange(null)" aria-label="Quitar filtro n√∫cleo">√ó</button>
            </span>
            <span class="filter-chip" *ngIf="selectedGalponId">
              Galp√≥n: {{ galponMap[selectedGalponId] }}
              <button type="button" (click)="onGalponChange(null)" aria-label="Quitar filtro galp√≥n">√ó</button>
            </span>
            <span class="filter-chip" *ngIf="selectedLoteId">
              Lote: {{ selectedLoteId }}
              <button type="button" (click)="onLoteSelectChange(null)" aria-label="Quitar filtro lote">√ó</button>
            </span>
            <span class="filter-chip" *ngIf="filtro">
              B√∫squeda: "{{ filtro }}"
              <button type="button" (click)="filtro=''; recomputeList()" aria-label="Limpiar b√∫squeda">√ó</button>
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== MENSAJE: Selecciona un lote ========== -->
    <section class="ux-card" *ngIf="!loteSeleccionado()">
      <div class="empty-state">
        <div class="empty-icon">üìã</div>
        <h3>Selecciona un Lote</h3>
        <p>Usa los filtros de arriba para seleccionar un lote y ver sus registros de traslados.</p>
        <p class="text-muted">Los registros se mostrar√°n organizados por tipo: Huevos, Aves y Lotes.</p>
      </div>
    </section>

    <!-- ========== REGISTROS DE TRASLADOS (solo cuando hay lote seleccionado) ========== -->
    <section class="ux-card" *ngIf="loteSeleccionado()">
      <header class="ux-card__header">
        <h2>üìä Registros de Traslados - Lote #{{ loteSeleccionado()?.loteId }}</h2>
        <button type="button" class="btn btn--ghost btn--sm" (click)="seleccionarLote(null)">
          ‚úï Cerrar
        </button>
      </header>

      <div class="ux-card__content">
        <!-- Tabs de Registros (solo cuando hay lote seleccionado) -->
        <div class="registros-tabs-section">
          <div class="registros-tabs">
            <button
              type="button"
              class="registros-tab"
              [class.active]="tabRegistrosActivo() === 'huevos'"
              (click)="tabRegistrosActivo.set('huevos')">
              ü•ö Huevos
              <span class="tab-badge" *ngIf="trasladosHuevosLote().length > 0">
                {{ trasladosHuevosLote().length }}
              </span>
            </button>
            <button
              type="button"
              class="registros-tab"
              [class.active]="tabRegistrosActivo() === 'aves'"
              (click)="tabRegistrosActivo.set('aves')">
              üêî Aves
              <span class="tab-badge" *ngIf="movimientosAvesLote().length > 0">
                {{ movimientosAvesLote().length }}
              </span>
            </button>
            <button
              type="button"
              class="registros-tab"
              [class.active]="tabRegistrosActivo() === 'lotes'"
              (click)="tabRegistrosActivo.set('lotes')">
              üì¶ Lotes
              <span class="tab-badge" *ngIf="historialTrasladosLote().length > 0">
                {{ historialTrasladosLote().length }}
              </span>
            </button>
          </div>

          <!-- Tab Panel: Huevos -->
          <div class="registros-tab-panel" *ngIf="tabRegistrosActivo() === 'huevos'">
            <!-- Loading state -->
            <div class="loading-state" *ngIf="loadingTrasladosHuevos()">
              <div class="spinner"></div>
              <p>Cargando registros de huevos...</p>
            </div>

            <!-- Table -->
            <div class="table-container" *ngIf="!loadingTrasladosHuevos()">
              <table class="ux-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>N¬∞ Traslado</th>
                    <th>Operaci√≥n</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Total Huevos</th>
                    <th>Detalle</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let traslado of trasladosHuevosLote()" class="ux-row">
                    <td>{{ formatearFecha(traslado.fechaTraslado) }}</td>
                    <td><strong>{{ traslado.numeroTraslado }}</strong></td>
                    <td>
                      <span class="badge" [class.badge--primary]="traslado.tipoOperacion === 'Traslado'"
                            [class.badge--warning]="traslado.tipoOperacion === 'Venta'">
                        {{ traslado.tipoOperacion }}
                      </span>
                    </td>
                    <td>{{ traslado.granjaOrigenNombre || '‚Äî' }}</td>
                    <td>{{ traslado.granjaDestinoNombre || traslado.tipoDestino || '‚Äî' }}</td>
                    <td class="number-cell primary">{{ formatearNumero(traslado.totalHuevos) }}</td>
                    <td class="text-sm">
                      <span *ngIf="traslado.cantidadLimpio > 0">L: {{ traslado.cantidadLimpio }}</span>
                      <span *ngIf="traslado.cantidadTratado > 0">T: {{ traslado.cantidadTratado }}</span>
                      <span *ngIf="traslado.cantidadSucio > 0">S: {{ traslado.cantidadSucio }}</span>
                    </td>
                    <td>
                      <span class="badge" [class.badge--success]="traslado.estado === 'Completado'"
                            [class.badge--warning]="traslado.estado === 'Pendiente'"
                            [class.badge--error]="traslado.estado === 'Cancelado'">
                        {{ traslado.estado }}
                      </span>
                    </td>
                  </tr>
                  <tr *ngIf="!loadingTrasladosHuevos() && trasladosHuevosLote().length === 0">
                    <td colspan="8" class="empty-state">
                      <div class="empty-illustration">ü•ö</div>
                      <p>No hay registros de traslado de huevos para este lote.</p>
                      <p class="text-muted text-sm">Total registros: {{ trasladosHuevosLote().length }}</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tab Panel: Aves -->
          <div class="registros-tab-panel" *ngIf="tabRegistrosActivo() === 'aves'">
            <!-- Loading state -->
            <div class="loading-state" *ngIf="loadingMovimientos()">
              <div class="spinner"></div>
              <p>Cargando registros de aves...</p>
            </div>

            <!-- Table -->
            <div class="table-container" *ngIf="!loadingMovimientos()">
              <table class="ux-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>N¬∞ Traslado</th>
                    <th>Tipo</th>
                    <th>Operaci√≥n</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Cantidad</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let movimiento of movimientosAvesLote()" class="ux-row">
                    <td>{{ formatearFecha(movimiento.fechaTraslado) }}</td>
                    <td><strong>{{ movimiento.numeroTraslado }}</strong></td>
                    <td>
                      <span class="badge badge--info">Aves</span>
                    </td>
                    <td>
                      <span class="badge" [class.badge--primary]="movimiento.tipoOperacion === 'Traslado'"
                            [class.badge--warning]="movimiento.tipoOperacion === 'Venta'"
                            [class.badge--error]="movimiento.tipoOperacion === 'Retiro'">
                        {{ movimiento.tipoOperacion }}
                      </span>
                    </td>
                    <td>{{ movimiento.granjaOrigenNombre || '‚Äî' }}</td>
                    <td>{{ movimiento.granjaDestinoNombre || movimiento.tipoDestino || '‚Äî' }}</td>
                    <td class="number-cell">
                      <span *ngIf="(movimiento.cantidadHembras ?? 0) > 0">H: {{ formatearNumero(movimiento.cantidadHembras ?? 0) }}</span>
                      <span *ngIf="(movimiento.cantidadMachos ?? 0) > 0">M: {{ formatearNumero(movimiento.cantidadMachos ?? 0) }}</span>
                      <span *ngIf="(movimiento.cantidadHembras ?? 0) === 0 && (movimiento.cantidadMachos ?? 0) === 0">‚Äî</span>
                    </td>
                    <td>
                      <span class="badge" [class.badge--success]="movimiento.estado === 'Completado'"
                            [class.badge--warning]="movimiento.estado === 'Pendiente'"
                            [class.badge--error]="movimiento.estado === 'Cancelado'">
                        {{ movimiento.estado }}
                      </span>
                    </td>
                  </tr>
                  <tr *ngIf="!loadingMovimientos() && movimientosAvesLote().length === 0">
                    <td colspan="8" class="empty-state">
                      <div class="empty-illustration">üêî</div>
                      <p>No hay registros de traslado de aves para este lote.</p>
                      <p class="text-muted text-sm">Total registros: {{ movimientosAvesLote().length }}</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tab Panel: Lotes -->
          <div class="registros-tab-panel" *ngIf="tabRegistrosActivo() === 'lotes'">
            <!-- Loading state -->
            <div class="loading-state" *ngIf="loadingHistorialLotes()">
              <div class="spinner"></div>
              <p>Cargando registros de lotes...</p>
            </div>

            <!-- Table -->
            <div class="table-container" *ngIf="!loadingHistorialLotes()">
              <table class="ux-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Lote Origen</th>
                    <th>Lote Destino</th>
                    <th>Granja Origen</th>
                    <th>Granja Destino</th>
                    <th>Usuario</th>
                    <th>Observaciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let historial of historialTrasladosLote()" class="ux-row">
                    <td>{{ formatearFecha(historial.fechaTraslado) }}</td>
                    <td><strong>#{{ historial.loteOriginalId }}</strong></td>
                    <td><strong>#{{ historial.loteNuevoId }}</strong></td>
                    <td>{{ historial.granjaOrigenNombre || '‚Äî' }}</td>
                    <td>{{ historial.granjaDestinoNombre || '‚Äî' }}</td>
                    <td>{{ historial.usuarioNombre || '‚Äî' }}</td>
                    <td class="text-sm">{{ historial.observaciones || '‚Äî' }}</td>
                  </tr>
                  <tr *ngIf="!loadingHistorialLotes() && historialTrasladosLote().length === 0">
                    <td colspan="7" class="empty-state">
                      <div class="empty-illustration">üì¶</div>
                      <p>No hay registros de traslado de lotes para este lote.</p>
                      <p class="text-muted text-sm">Total registros: {{ historialTrasladosLote().length }}</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== DETALLES DEL LOTE SELECCIONADO (ABAJO) ========== -->
    <section class="lote-details-section" *ngIf="loteSeleccionado()">
      <div class="ux-card">
        <header class="ux-card__header">
          <div class="flex items-center justify-between w-full">
            <div>
              <h2>üìã Detalles del Lote #{{ loteSeleccionado()?.loteId }}</h2>
              <p class="text-sm text-muted mt-1">
                {{ obtenerNombreGranja(loteSeleccionado()?.granjaId) }}
                <span *ngIf="nucleoMap[loteSeleccionado()?.nucleoId || '']">
                  ‚Ä¢ {{ nucleoMap[loteSeleccionado()?.nucleoId || ''] }}
                </span>
                <span *ngIf="galponMap[loteSeleccionado()?.galponId || '']">
                  ‚Ä¢ {{ galponMap[loteSeleccionado()?.galponId || ''] }}
                </span>
              </p>
            </div>
            <button type="button" class="btn btn--ghost btn--sm" (click)="seleccionarLote(null)">
              ‚úï Cerrar
            </button>
          </div>
        </header>

        <div class="ux-card__content">
          <!-- Informaci√≥n del Lote -->
          <div class="lote-info-grid" *ngIf="loteCompleto()">
            <div class="info-card">
              <h4 class="info-card__title">üêî Cantidad Actual de Aves</h4>
              <div class="info-card__content">
                <div class="stat-item">
                  <span class="stat-label">Hembras:</span>
                  <span class="stat-value success">{{ formatearNumero(loteSeleccionado()?.cantidadHembras || 0) }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Machos:</span>
                  <span class="stat-value info">{{ formatearNumero(loteSeleccionado()?.cantidadMachos || 0) }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Total:</span>
                  <span class="stat-value primary">
                    <strong>{{ formatearNumero(calcularTotalAves(loteSeleccionado()!)) }}</strong>
                  </span>
                </div>
              </div>
            </div>

            <div class="info-card">
              <h4 class="info-card__title">üìÖ Informaci√≥n del Lote</h4>
              <div class="info-card__content">
                <div class="info-row">
                  <span class="info-label">Nombre:</span>
                  <span class="info-value">{{ loteCompleto()?.loteNombre || '‚Äî' }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Raza:</span>
                  <span class="info-value">{{ loteCompleto()?.raza || '‚Äî' }}</span>
                </div>
                <div class="info-row" *ngIf="loteCompleto()?.fechaEncaset">
                  <span class="info-label">Fecha Encaset:</span>
                  <span class="info-value">{{ loteCompleto()?.fechaEncaset ? formatearFecha(loteCompleto()!.fechaEncaset!) : '‚Äî' }}</span>
                </div>
                <div class="info-row" *ngIf="loteCompleto()?.fechaEncaset">
                  <span class="info-label">Edad:</span>
                  <span class="info-value">{{ loteCompleto()?.fechaEncaset ? calcularEdadDias(loteCompleto()!.fechaEncaset) : 0 }} d√≠as</span>
                </div>
                <div class="info-row" *ngIf="loteCompleto()?.fechaEncaset">
                  <span class="info-label">Fase:</span>
                  <span class="info-value">{{ loteCompleto()?.fechaEncaset ? (calcularEdadDias(loteCompleto()!.fechaEncaset) < 175 ? 'Levante' : 'Producci√≥n') : '‚Äî' }}</span>
                </div>
              </div>
            </div>

            <div class="info-card">
              <h4 class="info-card__title">üìç Ubicaci√≥n</h4>
              <div class="info-card__content">
                <div class="info-row">
                  <span class="info-label">Granja:</span>
                  <span class="info-value">{{ obtenerNombreGranja(loteSeleccionado()?.granjaId) }}</span>
                </div>
                <div class="info-row" *ngIf="nucleoMap[loteSeleccionado()?.nucleoId || '']">
                  <span class="info-label">N√∫cleo:</span>
                  <span class="info-value">{{ nucleoMap[loteSeleccionado()?.nucleoId || ''] }}</span>
                </div>
                <div class="info-row" *ngIf="galponMap[loteSeleccionado()?.galponId || '']">
                  <span class="info-label">Galp√≥n:</span>
                  <span class="info-value">{{ galponMap[loteSeleccionado()?.galponId || ''] }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">√öltimo Conteo:</span>
                  <span class="info-value">{{ loteSeleccionado()?.fechaUltimoConteo ? formatearFecha(loteSeleccionado()!.fechaUltimoConteo!) : '‚Äî' }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabs de Hist√≥rico -->
          <div class="historial-tabs-section">
            <div class="historial-tabs">
              <button
                type="button"
                class="historial-tab"
                [class.active]="tabHistorialActivo() === 'lotes'"
                (click)="tabHistorialActivo.set('lotes')">
                üì¶ Lotes
                <span class="tab-badge" *ngIf="historialTrasladosLote().length > 0">
                  {{ historialTrasladosLote().length }}
                </span>
              </button>
              <button
                type="button"
                class="historial-tab"
                [class.active]="tabHistorialActivo() === 'aves'"
                (click)="tabHistorialActivo.set('aves')">
                üêî Aves
                <span class="tab-badge" *ngIf="movimientosAvesLote().length > 0">
                  {{ movimientosAvesLote().length }}
                </span>
              </button>
              <button
                type="button"
                class="historial-tab"
                [class.active]="tabHistorialActivo() === 'huevos'"
                (click)="tabHistorialActivo.set('huevos')">
                ü•ö Huevos
                <span class="tab-badge" *ngIf="trasladosHuevosLote().length > 0">
                  {{ trasladosHuevosLote().length }}
                </span>
              </button>
            </div>

            <!-- Tab Panel: Lotes -->
            <div class="historial-tab-panel" *ngIf="tabHistorialActivo() === 'lotes'">
              <div class="loading-state" *ngIf="loadingHistorialLotes()">
                <div class="spinner"></div>
                <p>Cargando historial de traslados de lotes...</p>
              </div>

              <div class="movimientos-table-container" *ngIf="!loadingHistorialLotes()">
                <table class="movimientos-table" *ngIf="historialTrasladosLote().length > 0">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Lote Origen</th>
                      <th>Lote Destino</th>
                      <th>Granja Origen</th>
                      <th>Granja Destino</th>
                      <th>Usuario</th>
                      <th>Observaciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let traslado of historialTrasladosLote()">
                      <td class="date-cell">{{ formatearFecha(traslado.fechaTraslado) }}</td>
                      <td><strong>#{{ traslado.loteOriginalId }}</strong></td>
                      <td><strong>#{{ traslado.loteNuevoId }}</strong></td>
                      <td>{{ traslado.granjaOrigenNombre || 'N/A' }}</td>
                      <td>{{ traslado.granjaDestinoNombre || 'N/A' }}</td>
                      <td>{{ traslado.usuarioNombre || 'N/A' }}</td>
                      <td class="motivo-cell">{{ traslado.observaciones || '‚Äî' }}</td>
                    </tr>
                  </tbody>
                </table>

                <div class="empty-state" *ngIf="historialTrasladosLote().length === 0">
                  <div class="empty-illustration">üì¶</div>
                  <p>No hay traslados de lotes registrados para este lote.</p>
                </div>
              </div>
            </div>

            <!-- Tab Panel: Aves -->
            <div class="historial-tab-panel" *ngIf="tabHistorialActivo() === 'aves'">
              <div class="loading-state" *ngIf="loadingMovimientos()">
                <div class="spinner"></div>
                <p>Cargando movimientos de aves...</p>
              </div>

              <div class="movimientos-table-container" *ngIf="!loadingMovimientos()">
                <table class="movimientos-table" *ngIf="movimientosAvesLote().length > 0">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>N¬∞ Traslado</th>
                      <th>Tipo</th>
                      <th>Operaci√≥n</th>
                      <th>Origen</th>
                      <th>Destino</th>
                      <th>Cantidad</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let mov of movimientosAvesLote()">
                      <td class="date-cell">{{ formatearFecha(mov.fechaTraslado) }}</td>
                      <td><code class="mov-number">{{ mov.numeroTraslado }}</code></td>
                      <td>
                        <span class="badge badge--info">üêî Aves</span>
                      </td>
                      <td>
                        <span class="badge" [class]="obtenerTipoMovimientoClass(mov.tipoOperacion)">
                          {{ mov.tipoOperacion }}
                        </span>
                      </td>
                      <td class="ubicacion-cell">
                        <div>
                          <strong>Lote {{ mov.loteIdOrigen }}</strong>
                          <small *ngIf="mov.granjaOrigenNombre"> ‚Ä¢ {{ mov.granjaOrigenNombre }}</small>
                        </div>
                      </td>
                      <td class="ubicacion-cell">
                        <div *ngIf="mov.loteIdDestino || mov.granjaDestinoNombre">
                          <strong *ngIf="mov.loteIdDestino">Lote {{ mov.loteIdDestino }}</strong>
                          <small *ngIf="mov.granjaDestinoNombre"> ‚Ä¢ {{ mov.granjaDestinoNombre }}</small>
                        </div>
                        <span *ngIf="!mov.loteIdDestino && !mov.granjaDestinoNombre" class="text-muted">‚Äî</span>
                      </td>
                      <td class="number-cell">
                        <div *ngIf="mov.cantidadHembras || mov.cantidadMachos">
                          <span *ngIf="mov.cantidadHembras">H: {{ formatearNumero(mov.cantidadHembras) }}</span>
                          <span *ngIf="mov.cantidadHembras && mov.cantidadMachos"> / </span>
                          <span *ngIf="mov.cantidadMachos">M: {{ formatearNumero(mov.cantidadMachos) }}</span>
                        </div>
                      </td>
                      <td>
                        <span class="badge" [class]="obtenerEstadoClass(mov.estado)">
                          {{ mov.estado }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>

                <div class="empty-state" *ngIf="movimientosAvesLote().length === 0">
                  <div class="empty-illustration">üêî</div>
                  <p>No hay movimientos de aves registrados para este lote.</p>
                </div>
              </div>
            </div>

            <!-- Tab Panel: Huevos -->
            <div class="historial-tab-panel" *ngIf="tabHistorialActivo() === 'huevos'">
              <div class="loading-state" *ngIf="loadingTrasladosHuevos()">
                <div class="spinner"></div>
                <p>Cargando traslados de huevos...</p>
              </div>

              <div class="movimientos-table-container" *ngIf="!loadingTrasladosHuevos()">
                <table class="movimientos-table" *ngIf="trasladosHuevosLote().length > 0">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>N¬∞ Traslado</th>
                      <th>Operaci√≥n</th>
                      <th>Origen</th>
                      <th>Destino</th>
                      <th>Total Huevos</th>
                      <th>Detalle</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let traslado of trasladosHuevosLote()">
                      <td class="date-cell">{{ formatearFecha(traslado.fechaTraslado) }}</td>
                      <td><code class="mov-number">{{ traslado.numeroTraslado }}</code></td>
                      <td>
                        <span class="badge" [class]="obtenerTipoMovimientoClass(traslado.tipoOperacion)">
                          {{ traslado.tipoOperacion }}
                        </span>
                      </td>
                      <td class="ubicacion-cell">
                        <div>
                          <strong>Lote {{ traslado.loteId }}</strong>
                          <small *ngIf="traslado.granjaOrigenNombre"> ‚Ä¢ {{ traslado.granjaOrigenNombre }}</small>
                        </div>
                      </td>
                      <td class="ubicacion-cell">
                        <div *ngIf="traslado.loteDestinoId || traslado.granjaDestinoNombre">
                          <strong *ngIf="traslado.loteDestinoId">Lote {{ traslado.loteDestinoId }}</strong>
                          <small *ngIf="traslado.granjaDestinoNombre"> ‚Ä¢ {{ traslado.granjaDestinoNombre }}</small>
                        </div>
                        <span *ngIf="!traslado.loteDestinoId && !traslado.granjaDestinoNombre" class="text-muted">‚Äî</span>
                      </td>
                      <td class="number-cell">
                        <strong>{{ formatearNumero(traslado.totalHuevos) }}</strong>
                      </td>
                      <td class="text-xs">
                        <div *ngIf="traslado.cantidadLimpio > 0">Limpio: {{ traslado.cantidadLimpio }}</div>
                        <div *ngIf="traslado.cantidadTratado > 0">Tratado: {{ traslado.cantidadTratado }}</div>
                        <div *ngIf="traslado.cantidadSucio > 0">Sucio: {{ traslado.cantidadSucio }}</div>
                      </td>
                      <td>
                        <span class="badge" [class]="obtenerEstadoClass(traslado.estado)">
                          {{ traslado.estado }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>

                <div class="empty-state" *ngIf="trasladosHuevosLote().length === 0">
                  <div class="empty-illustration">ü•ö</div>
                  <p>No hay traslados de huevos registrados para este lote.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Movimientos del Lote (mantener por compatibilidad) -->
          <div class="movimientos-section" style="display: none;">
            <h3 class="movimientos-title">
              üìä Registros de Movimiento del Lote
              <span class="badge badge--default" *ngIf="movimientosLote().length > 0">
                {{ movimientosLote().length }}
              </span>
            </h3>

            <div class="loading-state" *ngIf="loadingMovimientos()">
              <div class="spinner"></div>
              <p>Cargando movimientos...</p>
            </div>

            <div class="movimientos-table-container" *ngIf="!loadingMovimientos()">
              <table class="movimientos-table" *ngIf="movimientosLote().length > 0">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>N¬∞ Traslado</th>
                    <th>Tipo</th>
                    <th>Operaci√≥n</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Cantidad</th>
                    <th>Estado</th>
                    <th>Fase</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let mov of movimientosLote()">
                    <td class="date-cell">{{ formatearFecha(mov.fechaTraslado) }}</td>
                    <td><code class="mov-number">{{ mov.numeroTraslado }}</code></td>
                    <td>
                      <span class="badge" [class]="mov.tipoTraslado === 'Aves' ? 'badge--info' : 'badge--warning'">
                        {{ mov.tipoTraslado === 'Aves' ? 'üêî Aves' : 'ü•ö Huevos' }}
                      </span>
                    </td>
                    <td>
                      <span class="badge" [class]="obtenerTipoMovimientoClass(mov.tipoOperacion)">
                        {{ mov.tipoOperacion }}
                      </span>
                    </td>
                    <td class="ubicacion-cell">
                      <div>
                        <strong>Lote {{ mov.loteIdOrigen }}</strong>
                        <small *ngIf="mov.granjaOrigenNombre"> ‚Ä¢ {{ mov.granjaOrigenNombre }}</small>
                      </div>
                    </td>
                    <td class="ubicacion-cell">
                      <div *ngIf="mov.loteIdDestino || mov.granjaDestinoNombre">
                        <strong *ngIf="mov.loteIdDestino">Lote {{ mov.loteIdDestino }}</strong>
                        <small *ngIf="mov.granjaDestinoNombre"> ‚Ä¢ {{ mov.granjaDestinoNombre }}</small>
                        <small *ngIf="mov.tipoDestino"> ({{ mov.tipoDestino }})</small>
                      </div>
                      <span *ngIf="!mov.loteIdDestino && !mov.granjaDestinoNombre" class="text-muted">‚Äî</span>
                    </td>
                    <td class="number-cell">
                      <div *ngIf="mov.tipoTraslado === 'Aves'">
                        <div *ngIf="mov.cantidadHembras || mov.cantidadMachos">
                          <span *ngIf="mov.cantidadHembras">H: {{ formatearNumero(mov.cantidadHembras) }}</span>
                          <span *ngIf="mov.cantidadHembras && mov.cantidadMachos"> / </span>
                          <span *ngIf="mov.cantidadMachos">M: {{ formatearNumero(mov.cantidadMachos) }}</span>
                        </div>
                        <div *ngIf="mov.totalAves && (!mov.cantidadHembras && !mov.cantidadMachos)">
                          Total: {{ formatearNumero(mov.totalAves) }}
                        </div>
                      </div>
                      <div *ngIf="mov.tipoTraslado === 'Huevos'">
                        <div><strong>Total: {{ formatearNumero(mov.totalHuevos || 0) }}</strong></div>
                        <div class="text-xs text-muted" *ngIf="mov.cantidadLimpio || mov.cantidadTratado">
                          <span *ngIf="mov.cantidadLimpio">Limpio: {{ mov.cantidadLimpio }}</span>
                          <span *ngIf="mov.cantidadLimpio && mov.cantidadTratado"> / </span>
                          <span *ngIf="mov.cantidadTratado">Tratado: {{ mov.cantidadTratado }}</span>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="badge" [class]="obtenerEstadoClass(mov.estado)">
                        {{ mov.estado }}
                      </span>
                    </td>
                    <td>
                      <span class="badge badge--default" *ngIf="mov.faseLote">
                        {{ mov.faseLote }}
                      </span>
                      <span *ngIf="!mov.faseLote" class="text-muted">‚Äî</span>
                    </td>
                  </tr>
                </tbody>
              </table>

              <div class="empty-state" *ngIf="movimientosLote().length === 0">
                <div class="empty-illustration">üì≠</div>
                <p>No hay movimientos registrados para este lote.</p>
                <p class="text-muted text-sm mt-2">
                  Los traslados, retiros, ventas y otros movimientos aparecer√°n aqu√≠.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== MODAL TRASLADO (sin cambios) ========== -->
    <div class="modal-overlay" *ngIf="modalTrasladoAbierto()"
         (click)="cerrarModalTraslado()" role="dialog" aria-modal="true" aria-labelledby="traslado-title">
      <div class="modal-container" (click)="$event.stopPropagation()" tabindex="-1">
        <div class="modal-header">
          <h2 id="traslado-title">üöö Registro de Salida / Traslado</h2>
          <button type="button" class="modal-close" (click)="cerrarModalTraslado()" aria-label="Cerrar modal">‚úï</button>
        </div>

        <div class="modal-body">
          <!-- Contenido del modal de traslado (mantener igual) -->
          <!-- Paso 1 -->
          <div class="step-section">
            <div class="step-header">
              <div class="step-number">1</div>
              <h3 class="step-title">üîç Selecci√≥n de Lotes</h3>
            </div>
            <p class="step-description">
              Selecciona el <strong>lote origen</strong> (sale) y el <strong>lote destino</strong> (recibe)
            </p>

            <div class="lote-selection-grid">
              <!-- Origen -->
              <div class="lote-filter-section">
                <div class="filter-header">
                  <h4 class="filter-title">üì§ Lote Origen</h4>
                  <div class="filter-status" [class.selected]="loteOrigenSeleccionado()">
                    {{ loteOrigenSeleccionado() ? '‚úÖ Seleccionado' : '‚è≥ Pendiente' }}
                  </div>
                </div>
                <app-hierarchical-filter
                  [showLoteSelection]="true"
                  [showChips]="true"
                  [filterLabel]="'Filtros para Lote Origen'"
                  [placeholder]="'Buscar lote origen...'"
                  (loteSelected)="onLoteOrigenSeleccionado($event)">
                </app-hierarchical-filter>
              </div>

              <!-- Destino -->
              <div class="lote-filter-section">
                <div class="filter-header">
                  <h4 class="filter-title">üì• Lote Destino</h4>
                  <div class="filter-status" [class.selected]="loteDestinoSeleccionado()">
                    {{ loteDestinoSeleccionado() ? '‚úÖ Seleccionado' : '‚è≥ Pendiente' }}
                  </div>
                </div>
                <app-hierarchical-filter
                  [showLoteSelection]="true"
                  [showChips]="true"
                  [filterLabel]="'Filtros para Lote Destino'"
                  [placeholder]="'Buscar lote destino...'"
                  (loteSelected)="onLoteDestinoSeleccionado($event)">
                </app-hierarchical-filter>
              </div>
            </div>

            <!-- Resumen inventarios -->
            <div class="lotes-summary" *ngIf="loteOrigenSeleccionado() && loteDestinoSeleccionado()">
              <div class="lote-summary-card origen">
                <div class="card-header">
                  <h4>üì§ Origen</h4>
                  <span class="lote-id">{{ loteOrigenSeleccionado()?.loteId }}</span>
                </div>
                <div class="card-body" *ngIf="inventarioOrigen()">
                  <div class="inventory-info">
                    <div class="inventory-item hembras"><span class="count">{{ inventarioOrigen()?.cantidadHembras || 0 }}</span><span class="type">‚ôÄ Hembras</span></div>
                    <div class="inventory-item machos"><span class="count">{{ inventarioOrigen()?.cantidadMachos || 0 }}</span><span class="type">‚ôÇ Machos</span></div>
                    <div class="inventory-item total"><span class="count">{{ (inventarioOrigen()?.cantidadHembras || 0) + (inventarioOrigen()?.cantidadMachos || 0) }}</span><span class="type">Total</span></div>
                  </div>
                </div>
              </div>

              <div class="transfer-arrow">
                <div class="arrow-icon">‚Üí</div>
                <div class="arrow-label">Traslado</div>
              </div>

              <div class="lote-summary-card destino">
                <div class="card-header">
                  <h4>üì• Destino</h4>
                  <span class="lote-id">{{ loteDestinoSeleccionado()?.loteId }}</span>
                </div>
                <div class="card-body" *ngIf="inventarioDestino()">
                  <div class="inventory-info">
                    <div class="inventory-item hembras"><span class="count">{{ inventarioDestino()?.cantidadHembras || 0 }}</span><span class="type">‚ôÄ Hembras</span></div>
                    <div class="inventory-item machos"><span class="count">{{ inventarioDestino()?.cantidadMachos || 0 }}</span><span class="type">‚ôÇ Machos</span></div>
                    <div class="inventory-item total"><span class="count">{{ (inventarioDestino()?.cantidadHembras || 0) + (inventarioDestino()?.cantidadMachos || 0) }}</span><span class="type">Total</span></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Paso 2 -->
          <div class="step-section" *ngIf="loteOrigenSeleccionado() && loteDestinoSeleccionado()">
            <div class="step-header">
              <div class="step-number">2</div>
              <h3 class="step-title">üßæ Datos del Movimiento</h3>
            </div>
            <p class="step-description">Completa la informaci√≥n obligatoria del registro de salida</p>

            <form [formGroup]="trasladoForm" class="traslado-form" (ngSubmit)="procesarTraslado()">
              <!-- Usuarios + Fecha -->
              <div class="grid grid-3">
                <div class="form-field">
                  <label class="ux-label" for="user-realiza">üë§ Usuario que realiza <span class="required">*</span></label>
                  <input id="user-realiza" type="number" class="ux-input"
                         formControlName="usuarioRealizaId" placeholder="ID usuario que realiza" />
                  <small class="text-danger" *ngIf="trasladoForm.get('usuarioRealizaId')?.touched && trasladoForm.get('usuarioRealizaId')?.invalid">Requerido.</small>
                </div>

                <div class="form-field">
                  <label class="ux-label" for="user-recibe">ü§ù Usuario que recibe <span class="required">*</span></label>
                  <input id="user-recibe" type="number" class="ux-input"
                         formControlName="usuarioRecibeId" placeholder="ID usuario que recibe" />
                  <small class="text-danger" *ngIf="trasladoForm.get('usuarioRecibeId')?.touched && trasladoForm.get('usuarioRecibeId')?.invalid">Requerido.</small>
                </div>

                <div class="form-field">
                  <label class="ux-label" for="fecha-mov">üìÖ Fecha del movimiento <span class="required">*</span></label>
                  <input id="fecha-mov" type="date" class="ux-input" formControlName="fechaMovimiento" />
                  <small class="text-danger" *ngIf="trasladoForm.get('fechaMovimiento')?.touched && trasladoForm.get('fechaMovimiento')?.invalid">Requerido.</small>
                </div>
              </div>

              <!-- Tipo + Observaciones -->
              <div class="grid grid-2">
                <div class="form-field">
                  <label class="ux-label" for="tipo-mov">üè∑Ô∏è Tipo de movimiento</label>
                  <select id="tipo-mov" class="ux-select" formControlName="tipoMovimiento">
                    <option value="TRASLADO">TRASLADO</option>
                    <option value="SALIDA">SALIDA</option>
                  </select>
                </div>

                <div class="form-field">
                  <label class="ux-label" for="obs">üìù Observaciones</label>
                  <textarea id="obs" class="ux-textarea" rows="2" formControlName="observaciones" placeholder="Notas, motivo, etc."></textarea>
                </div>
              </div>

              <!-- Cantidades -->
              <div class="step-subtitle">üî¢ Cantidades a Trasladar</div>
              <div class="quantities-grid">
                <div class="quantity-field hembras">
                  <label class="quantity-label" for="q-hembras"><span class="icon">‚ôÄ</span><span class="text">Hembras</span></label>
                  <div class="input-with-max">
                    <input id="q-hembras" type="number" class="ux-input quantity-input"
                           formControlName="cantidadHembras" min="0"
                           [attr.max]="inventarioOrigen()?.cantidadHembras ?? null" placeholder="0" />
                    <span class="max-indicator">/ {{ inventarioOrigen()?.cantidadHembras ?? '‚Äî' }} disp.</span>
                    <button type="button" class="btn btn--ghost btn--xs" (click)="trasladarTodasLasHembras()">Usar m√°x</button>
                  </div>
                  <small class="text-danger" *ngIf="trasladoForm.get('cantidadHembras')?.errors?.['exceedsAvailable']">
                    M√°ximo: {{ trasladoForm.get('cantidadHembras')?.errors?.['exceedsAvailable']?.max | number : '1.0-0' }}
                  </small>
                </div>

                <div class="quantity-field machos">
                  <label class="quantity-label" for="q-machos"><span class="icon">‚ôÇ</span><span class="text">Machos</span></label>
                  <div class="input-with-max">
                    <input id="q-machos" type="number" class="ux-input quantity-input"
                           formControlName="cantidadMachos" min="0"
                           [attr.max]="inventarioOrigen()?.cantidadMachos ?? null" placeholder="0" />
                    <span class="max-indicator">/ {{ inventarioOrigen()?.cantidadMachos ?? '‚Äî' }} disp.</span>
                    <button type="button" class="btn btn--ghost btn--xs" (click)="trasladarTodosLosMachos()">Usar m√°x</button>
                  </div>
                  <small class="text-danger" *ngIf="trasladoForm.get('cantidadMachos')?.errors?.['exceedsAvailable']">
                    M√°ximo: {{ trasladoForm.get('cantidadMachos')?.errors?.['exceedsAvailable']?.max | number : '1.0-0' }}
                  </small>
                </div>
              </div>

              <!-- Resumen -->
              <div class="transfer-summary" *ngIf="getTotalAves() > 0">
                <div class="summary-card">
                  <div class="summary-header"><h4>üìä Resumen</h4></div>
                  <div class="summary-body">
                    <div class="summary-item"><span class="label">Total:</span><span class="value total">{{ getTotalAves() }} aves</span></div>
                    <div class="summary-breakdown">
                      <span class="breakdown-item hembras" *ngIf="trasladoForm.get('cantidadHembras')?.value > 0">
                        {{ trasladoForm.get('cantidadHembras')?.value }}‚ôÄ
                      </span>
                      <span class="breakdown-item machos" *ngIf="trasladoForm.get('cantidadMachos')?.value > 0">
                        {{ trasladoForm.get('cantidadMachos')?.value }}‚ôÇ
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Estados -->
              <div class="modal-states">
                <div class="alert alert--danger" *ngIf="errorTraslado()">
                  <div class="alert__icon">‚ö†Ô∏è</div>
                  <div class="alert__content"><strong>Error:</strong> {{ errorTraslado() }}</div>
                </div>
                <div class="alert alert--success" *ngIf="exitoTraslado()">
                  <div class="alert__icon">‚úÖ</div>
                  <div class="alert__content"><strong>¬°Traslado registrado!</strong></div>
                </div>
                <div class="loading-state" *ngIf="procesandoTraslado()">
                  <div class="spinner"></div><p>Procesando traslado...</p>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn--outline" (click)="cerrarModalTraslado()" [disabled]="procesandoTraslado()">Cancelar</button>
          <button type="button" class="btn btn--primary"
                  (click)="procesarTraslado()"
                  [disabled]="!isSubmitEnabled() || procesandoTraslado() || exitoTraslado()">
            <span *ngIf="procesandoTraslado()">Procesando...</span>
            <span *ngIf="!procesandoTraslado()">üöö Registrar salida</span>
          </button>
        </div>
      </div>
    </div>
    <!-- /Modal -->

    <!-- ========== MODAL TRASLADO/RETIRO (XXL) ========== -->
    <div class="modal-overlay modal-overlay--xxl"
         *ngIf="modalTrasladoRetiroAbierto()"
         (click)="cerrarModalTrasladoRetiro()"
         role="dialog"
         aria-modal="true"
         aria-labelledby="traslado-retiro-title">
      <div class="modal-container modal-container--xxl"
           (click)="$event.stopPropagation()"
           tabindex="-1">

        <div class="modal-header modal-header--xxl">
          <h2 id="traslado-retiro-title">
            üöö Traslado / Retiro
            <span class="lote-badge" *ngIf="loteCompleto()">
              Lote #{{ loteCompleto()?.loteId }}
            </span>
          </h2>
          <button type="button"
                  class="modal-close"
                  (click)="cerrarModalTrasladoRetiro()"
                  aria-label="Cerrar modal">‚úï</button>
        </div>

        <div class="modal-body modal-body--xxl">
          <!-- Informaci√≥n del Lote - Mejorada -->
          <div class="lote-info-section" *ngIf="loteCompleto()">
            <div class="lote-info-card lote-info-card--enhanced">
              <div class="lote-info-header">
                <h3>üìç Informaci√≥n del Lote</h3>
                <span class="lote-id-badge">#{{ loteCompleto()?.loteId }}</span>
              </div>
              <div class="lote-info-grid lote-info-grid--enhanced">
                <div class="info-item info-item--enhanced">
                  <span class="info-icon">üè†</span>
                  <div class="info-content">
                    <span class="info-label">Granja</span>
                    <span class="info-value">{{ obtenerNombreGranja(loteCompleto()?.granjaId) }}</span>
                  </div>
                </div>
                <div class="info-item info-item--enhanced">
                  <span class="info-icon">üìã</span>
                  <div class="info-content">
                    <span class="info-label">Nombre del Lote</span>
                    <span class="info-value">{{ loteCompleto()?.loteNombre || 'Sin nombre' }}</span>
                  </div>
                </div>
                <div class="info-item info-item--enhanced" *ngIf="loteCompleto()?.fechaEncaset">
                  <span class="info-icon">üìÖ</span>
                  <div class="info-content">
                    <span class="info-label">Edad</span>
                    <span class="info-value">
                      {{ calcularEdadDias(loteCompleto()!.fechaEncaset) }} d√≠as
                      <span class="phase-badge phase-badge--enhanced"
                            [class.phase-levante]="calcularEdadDias(loteCompleto()!.fechaEncaset) < 175"
                            [class.phase-produccion]="calcularEdadDias(loteCompleto()!.fechaEncaset) >= 175">
                        {{ calcularEdadDias(loteCompleto()!.fechaEncaset) < 175 ? 'Levante' : 'Producci√≥n' }}
                      </span>
                    </span>
                  </div>
                </div>
                <div class="info-item info-item--enhanced" *ngIf="loteCompleto()?.nucleoId">
                  <span class="info-icon">üèóÔ∏è</span>
                  <div class="info-content">
                    <span class="info-label">N√∫cleo</span>
                    <span class="info-value">{{ nucleoMap[loteCompleto()!.nucleoId || ''] || '‚Äî' }}</span>
                  </div>
                </div>
                <div class="info-item info-item--enhanced" *ngIf="loteCompleto()?.galponId">
                  <span class="info-icon">üêî</span>
                  <div class="info-content">
                    <span class="info-label">Galp√≥n</span>
                    <span class="info-value">{{ galponMap[loteCompleto()!.galponId || ''] || '‚Äî' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabs Mejorados -->
          <div class="modal-tabs modal-tabs--enhanced">
            <input type="radio" id="tab-aves" name="modal-tab" [checked]="tabActivo() === 'aves'" (change)="tabActivo.set('aves')">
            <label for="tab-aves" class="tab-label tab-label--enhanced">
              <span class="tab-icon">üêî</span>
              <span class="tab-text">Aves</span>
              <span class="tab-badge" *ngIf="disponibilidadLote()?.aves">
                {{ disponibilidadLote()!.aves!.totalAves }}
              </span>
            </label>

            <input type="radio" id="tab-huevos" name="modal-tab" [checked]="tabActivo() === 'huevos'" (change)="tabActivo.set('huevos')">
            <label for="tab-huevos" class="tab-label tab-label--enhanced">
              <span class="tab-icon">ü•ö</span>
              <span class="tab-text">Huevos</span>
              <span class="tab-badge" *ngIf="disponibilidadLote()?.huevos">
                {{ disponibilidadLote()!.huevos!.totalHuevos }}
              </span>
            </label>

            <div class="tab-panels">
              <!-- TAB AVES -->
              <div class="tab-panel tab-panel--enhanced" *ngIf="tabActivo() === 'aves'">
                <!-- Disponibilidad de Aves - Mejorada -->
                <div class="disponibilidad-section disponibilidad-section--enhanced" *ngIf="disponibilidadLote() && disponibilidadLote()!.tipoLote === 'Levante'">
                  <div class="disponibilidad-header">
                    <h4>üìä Disponibilidad de Aves</h4>
                    <span class="disponibilidad-subtitle">Cantidades disponibles para traslado o venta</span>
                  </div>
                  <div class="disponibilidad-grid disponibilidad-grid--enhanced">
                    <div class="disponibilidad-card disponibilidad-card--hembras">
                      <div class="disponibilidad-icon">‚ôÄ</div>
                      <div class="disponibilidad-content">
                        <span class="disponibilidad-label">Hembras Vivas</span>
                        <span class="disponibilidad-value">{{ formatearNumero(disponibilidadLote()!.aves?.hembrasVivas || 0) }}</span>
                      </div>
                    </div>
                    <div class="disponibilidad-card disponibilidad-card--machos">
                      <div class="disponibilidad-icon">‚ôÇ</div>
                      <div class="disponibilidad-content">
                        <span class="disponibilidad-label">Machos Vivos</span>
                        <span class="disponibilidad-value">{{ formatearNumero(disponibilidadLote()!.aves?.machosVivos || 0) }}</span>
                      </div>
                    </div>
                    <div class="disponibilidad-card disponibilidad-card--total highlight">
                      <div class="disponibilidad-icon">üêî</div>
                      <div class="disponibilidad-content">
                        <span class="disponibilidad-label">Total Aves</span>
                        <span class="disponibilidad-value">{{ formatearNumero(disponibilidadLote()!.aves?.totalAves || 0) }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <form [formGroup]="trasladoRetiroForm" class="traslado-form" (ngSubmit)="procesarRetiroTraslado()">
                  <!-- Tipo de Operaci√≥n -->
                  <div class="form-section">
                    <h4>üìã Tipo de Operaci√≥n</h4>
                    <div class="tipo-operacion-selector">
                      <label class="operacion-option" [class.selected]="trasladoRetiroForm.get('tipoOperacion')?.value === 'Venta'">
                        <input type="radio" formControlName="tipoOperacion" value="Venta">
                        <span class="operacion-icon">üí∞</span>
                        <span class="operacion-text">Venta</span>
                      </label>
                      <label class="operacion-option" [class.selected]="trasladoRetiroForm.get('tipoOperacion')?.value === 'Traslado'">
                        <input type="radio" formControlName="tipoOperacion" value="Traslado">
                        <span class="operacion-icon">üöö</span>
                        <span class="operacion-text">Traslado</span>
                      </label>
                    </div>
                  </div>

                  <!-- Fecha -->
                  <div class="form-section">
                    <div class="form-field">
                      <label class="ux-label" for="aves-fecha">
                        üìÖ Fecha de Traslado <span class="required">*</span>
                      </label>
                      <input id="aves-fecha" type="date" class="ux-input" formControlName="fechaTraslado" />
                    </div>
                  </div>

                  <!-- Cantidades -->
                  <div class="form-section">
                    <h4>üî¢ Cantidades</h4>
                    <div class="cantidades-grid">
                      <div class="cantidad-field">
                        <label class="ux-label" for="aves-hembras">
                          ‚ôÄ Hembras
                          <span class="max-disponible" *ngIf="disponibilidadLote()?.aves">
                            (M√°x: {{ formatearNumero(disponibilidadLote()!.aves!.hembrasVivas) }})
                          </span>
                        </label>
                        <input id="aves-hembras" type="number" class="ux-input"
                               formControlName="cantidadHembras" min="0"
                               [attr.max]="disponibilidadLote()?.aves?.hembrasVivas" />
                      </div>
                      <div class="cantidad-field">
                        <label class="ux-label" for="aves-machos">
                          ‚ôÇ Machos
                          <span class="max-disponible" *ngIf="disponibilidadLote()?.aves">
                            (M√°x: {{ formatearNumero(disponibilidadLote()!.aves!.machosVivos) }})
                          </span>
                        </label>
                        <input id="aves-machos" type="number" class="ux-input"
                               formControlName="cantidadMachos" min="0"
                               [attr.max]="disponibilidadLote()?.aves?.machosVivos" />
                      </div>
                    </div>
                  </div>

                  <!-- Campos seg√∫n tipo de operaci√≥n -->
                  <div *ngIf="trasladoRetiroForm.get('tipoOperacion')?.value === 'Venta'">
                    <div class="form-section">
                      <div class="form-grid-2">
                        <div class="form-field">
                          <label class="ux-label" for="aves-motivo">
                            üìù Motivo <span class="required">*</span>
                          </label>
                          <input id="aves-motivo" type="text" class="ux-input"
                                 formControlName="motivo" placeholder="Ej: Venta directa, etc." />
                        </div>
                        <div class="form-field">
                          <label class="ux-label" for="aves-descripcion">
                            üìÑ Descripci√≥n <span class="required">*</span>
                          </label>
                          <input id="aves-descripcion" type="text" class="ux-input"
                                 formControlName="descripcion" placeholder="Descripci√≥n de la venta" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <div *ngIf="trasladoRetiroForm.get('tipoOperacion')?.value === 'Traslado'">
                    <div class="form-section">
                      <div class="form-grid-3">
                        <div class="form-field">
                          <label class="ux-label" for="aves-granja-destino">
                            üè† Granja Destino <span class="required">*</span>
                          </label>
                          <select id="aves-granja-destino" class="ux-select" formControlName="granjaDestinoId">
                            <option value="">Selecciona una granja</option>
                            <option *ngFor="let granja of farmsFiltered" [value]="granja.id">
                              {{ granja.name }}
                            </option>
                          </select>
                        </div>
                        <div class="form-field">
                          <label class="ux-label" for="aves-tipo-destino">
                            üìç Tipo de Destino <span class="required">*</span>
                          </label>
                          <select id="aves-tipo-destino" class="ux-select" formControlName="tipoDestino">
                            <option value="">Selecciona tipo</option>
                            <option value="Granja">Granja</option>
                            <option value="Planta">Planta</option>
                          </select>
                        </div>
                        <div class="form-field">
                          <label class="ux-label" for="aves-lote-destino">
                            üìã Lote Destino (Opcional)
                          </label>
                          <input id="aves-lote-destino" type="text" class="ux-input"
                                 formControlName="loteDestinoId" placeholder="ID del lote destino" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Observaciones -->
                  <div class="form-section">
                    <div class="form-field">
                      <label class="ux-label" for="aves-observaciones">üìù Observaciones</label>
                      <textarea id="aves-observaciones" class="ux-textarea" rows="3"
                                formControlName="observaciones" placeholder="Notas adicionales..."></textarea>
                    </div>
                  </div>
                </form>
              </div>

              <!-- TAB HUEVOS -->
              <div class="tab-panel tab-panel--enhanced" *ngIf="tabActivo() === 'huevos'">
                <!-- Disponibilidad de Huevos - Mejorada -->
                <div class="disponibilidad-section disponibilidad-section--enhanced" *ngIf="disponibilidadLote() && disponibilidadLote()!.tipoLote === 'Produccion'">
                  <div class="disponibilidad-header">
                    <h4>üìä Disponibilidad de Huevos</h4>
                    <span class="disponibilidad-subtitle">Cantidades disponibles para traslado o venta</span>
                  </div>
                  <div class="disponibilidad-grid disponibilidad-grid--enhanced">
                    <div class="disponibilidad-card disponibilidad-card--total highlight">
                      <div class="disponibilidad-icon">ü•ö</div>
                      <div class="disponibilidad-content">
                        <span class="disponibilidad-label">Total Huevos</span>
                        <span class="disponibilidad-value">{{ formatearNumero(disponibilidadLote()!.huevos?.totalHuevos || 0) }}</span>
                      </div>
                    </div>
                    <div class="disponibilidad-card disponibilidad-card--incubables">
                      <div class="disponibilidad-icon">‚ú®</div>
                      <div class="disponibilidad-content">
                        <span class="disponibilidad-label">Huevos Incubables</span>
                        <span class="disponibilidad-value">{{ formatearNumero(disponibilidadLote()!.huevos?.totalHuevosIncubables || 0) }}</span>
                      </div>
                    </div>
                  </div>
                  <div class="huevos-tipos-disponibles huevos-tipos-disponibles--enhanced">
                    <h5>üìã Disponibilidad por Tipo de Huevo</h5>
                    <div class="huevos-tipos-grid huevos-tipos-grid--enhanced">
                      <div class="huevo-tipo-item huevo-tipo-item--enhanced" *ngFor="let tipo of tiposHuevo">
                        <span class="tipo-icon">{{ tipo.key === 'limpio' ? '‚ú®' : tipo.key === 'tratado' ? 'üî¨' : 'ü•ö' }}</span>
                        <div class="tipo-content">
                          <span class="tipo-label">{{ tipo.label }}</span>
                          <span class="tipo-value">{{ formatearNumero(getCantidadHuevoDisponible(tipo.key)) }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <form [formGroup]="trasladoHuevosForm" class="traslado-form" (ngSubmit)="procesarTrasladoHuevos()">
                  <!-- Tipo de Operaci√≥n -->
                  <div class="form-section">
                    <h4>üìã Tipo de Operaci√≥n</h4>
                    <div class="tipo-operacion-selector">
                      <label class="operacion-option" [class.selected]="trasladoHuevosForm.get('tipoOperacion')?.value === 'Venta'">
                        <input type="radio" formControlName="tipoOperacion" value="Venta">
                        <span class="operacion-icon">üí∞</span>
                        <span class="operacion-text">Venta</span>
                      </label>
                      <label class="operacion-option" [class.selected]="trasladoHuevosForm.get('tipoOperacion')?.value === 'Traslado'">
                        <input type="radio" formControlName="tipoOperacion" value="Traslado">
                        <span class="operacion-icon">üöö</span>
                        <span class="operacion-text">Traslado</span>
                      </label>
                    </div>
                  </div>

                  <!-- Fecha -->
                  <div class="form-section">
                    <div class="form-field">
                      <label class="ux-label" for="huevos-fecha">
                        üìÖ Fecha de Traslado <span class="required">*</span>
                      </label>
                      <input id="huevos-fecha" type="date" class="ux-input" formControlName="fechaTraslado" />
                    </div>
                  </div>

                  <!-- Cantidades por Tipo de Huevo -->
                  <div class="form-section">
                    <h4>ü•ö Cantidades por Tipo de Huevo</h4>
                    <div class="huevos-cantidades-grid">
                      <div class="huevo-cantidad-field" *ngFor="let tipo of tiposHuevo">
                        <label class="ux-label" [for]="'huevo-' + tipo.key">
                          {{ tipo.label }}
                          <span class="max-disponible">
                            (M√°x: {{ getCantidadHuevoDisponible(tipo.key) }})
                          </span>
                        </label>
                        <input [id]="'huevo-' + tipo.key" type="number" class="ux-input"
                               [formControlName]="'cantidad' + (tipo.key.charAt(0).toUpperCase() + tipo.key.slice(1))"
                               min="0" [attr.max]="getCantidadHuevoDisponible(tipo.key)" />
                      </div>
                    </div>
                  </div>

                  <!-- Campos seg√∫n tipo de operaci√≥n -->
                  <div *ngIf="trasladoHuevosForm.get('tipoOperacion')?.value === 'Venta'">
                    <div class="form-section">
                      <div class="form-grid-2">
                        <div class="form-field">
                          <label class="ux-label" for="huevos-motivo">
                            üìù Motivo <span class="required">*</span>
                          </label>
                          <input id="huevos-motivo" type="text" class="ux-input"
                                 formControlName="motivo" placeholder="Ej: Venta directa, etc." />
                        </div>
                        <div class="form-field">
                          <label class="ux-label" for="huevos-descripcion">
                            üìÑ Descripci√≥n <span class="required">*</span>
                          </label>
                          <input id="huevos-descripcion" type="text" class="ux-input"
                                 formControlName="descripcion" placeholder="Descripci√≥n de la venta" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <div *ngIf="trasladoHuevosForm.get('tipoOperacion')?.value === 'Traslado'">
                    <div class="form-section">
                      <div class="form-grid-3">
                        <div class="form-field">
                          <label class="ux-label" for="huevos-granja-destino">
                            üè† Granja Destino <span class="required">*</span>
                          </label>
                          <select id="huevos-granja-destino" class="ux-select" formControlName="granjaDestinoId">
                            <option value="">Selecciona una granja</option>
                            <option *ngFor="let granja of farmsFiltered" [value]="granja.id">
                              {{ granja.name }}
                            </option>
                          </select>
                        </div>
                        <div class="form-field">
                          <label class="ux-label" for="huevos-tipo-destino">
                            üìç Tipo de Destino <span class="required">*</span>
                          </label>
                          <select id="huevos-tipo-destino" class="ux-select" formControlName="tipoDestino">
                            <option value="">Selecciona tipo</option>
                            <option value="Granja">Granja</option>
                            <option value="Planta">Planta</option>
                          </select>
                        </div>
                        <div class="form-field">
                          <label class="ux-label" for="huevos-lote-destino">
                            üìã Lote Destino (Opcional)
                          </label>
                          <input id="huevos-lote-destino" type="text" class="ux-input"
                                 formControlName="loteDestinoId" placeholder="ID del lote destino" />
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Observaciones -->
                  <div class="form-section">
                    <div class="form-field">
                      <label class="ux-label" for="huevos-observaciones">üìù Observaciones</label>
                      <textarea id="huevos-observaciones" class="ux-textarea" rows="3"
                                formControlName="observaciones" placeholder="Notas adicionales..."></textarea>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Estados (error/√©xito) -->
          <div class="modal-states">
            <div class="alert alert--danger alert-animated" *ngIf="errorRetiro()">
              <div class="alert__icon">‚ö†Ô∏è</div>
              <div class="alert__content">
                <strong>Error al procesar:</strong>
                <p>{{ errorRetiro() }}</p>
              </div>
            </div>

            <div class="success-modal success-modal--large" *ngIf="exitoRetiro()">
              <div class="success-modal__content">
                <div class="success-icon-animated">‚úÖ</div>
                <h3 class="success-title">¬°Operaci√≥n Exitosa!</h3>
                <p class="success-message">El traslado ha sido registrado correctamente.</p>
              </div>
            </div>

            <div class="loading-state loading-state--large" *ngIf="procesandoRetiro()">
              <div class="spinner spinner--large"></div>
              <p class="loading-text">Procesando...</p>
            </div>
          </div>
        </div>

        <div class="modal-footer modal-footer--xxl">
          <button type="button" class="btn btn--outline" (click)="cerrarModalTrasladoRetiro()"
                  [disabled]="procesandoRetiro()">Cancelar</button>
          <button type="button" class="btn btn--primary"
                  (click)="tabActivo() === 'aves' ? procesarRetiroTraslado() : procesarTrasladoHuevos()"
                  [disabled]="(tabActivo() === 'aves' ? !trasladoRetiroForm.valid : !trasladoHuevosForm.valid) || procesandoRetiro() || exitoRetiro()">
            <span *ngIf="procesandoRetiro()">Procesando...</span>
            <span *ngIf="!procesandoRetiro()">
              üöö {{ tabActivo() === 'aves' ? 'Registrar Traslado de Aves' : 'Registrar Traslado de Huevos' }}
            </span>
          </button>
        </div>
      </div>
    </div>
    <!-- /Modal Traslado/Retiro -->

    <!-- ========== MODAL TRASLADO DE LOTE ========== -->
    <app-modal-traslado-lote
      [isOpen]="modalTrasladoLoteAbierto()"
      [lote]="loteCompleto()"
      [farms]="farmsFiltered"
      [nucleos]="nucleos"
      [loading]="procesandoTrasladoLote()"
      (closed)="cerrarModalTrasladoLote()"
      (confirm)="procesarTrasladoLote($event)">
    </app-modal-traslado-lote>
    <!-- /Modal Traslado de Lote -->
  </div>
</div>
