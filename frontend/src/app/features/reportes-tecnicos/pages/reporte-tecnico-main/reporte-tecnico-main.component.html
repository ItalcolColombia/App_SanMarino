<div class="ux-page" [attr.aria-busy]="loading() ? 'true' : null">
  <app-sidebar class="ux-sidebar"></app-sidebar>

  <div class="ux-main">
    <header class="ux-header">
      <div class="ux-header__title">
        <h1>Reporte T茅cnico Levante SanMarino</h1>

        <div class="ux-header__meta">
          <ng-template #noGranjaChip>
            <span class="chip chip--warning">
              <span class="chip__dot" aria-hidden="true"></span>
              Selecciona una granja
            </span>
          </ng-template>

          <span class="chip chip--info" *ngIf="selectedGranjaId; else noGranjaChip">
            <span class="chip__dot" aria-hidden="true"></span>
            Granja: {{ selectedGranjaName || selectedGranjaId }}
          </span>

          <span class="chip chip--muted" *ngIf="selectedNucleoId">
            N煤cleo: {{ selectedNucleoNombre || selectedNucleoId }}
          </span>

          <span class="chip chip--muted" *ngIf="selectedGalponId">
            Galp贸n: {{ selectedGalponNombre }}
          </span>

          <span class="chip chip--info" *ngIf="selectedLoteId">
            <span class="chip__dot" aria-hidden="true"></span>
            Lote: {{ selectedLoteNombre }}
          </span>

          <span class="chip chip--muted" *ngIf="selectedLoteId && selectedLote">
            {{ calcularEdadDias(selectedLote.fechaEncaset) }} d铆as
          </span>
        </div>
      </div>

      <div class="ux-header__actions">
        <button
          type="button"
          class="btn btn--secondary"
          (click)="mostrarFormulas = !mostrarFormulas">
           F贸rmulas
        </button>

        <button
          type="button"
          class="btn btn--primary"
          (click)="generarReporte()"
          [disabled]="loading() || !puedeGenerarReporte()"
          [title]="!puedeGenerarReporte() ? 'Selecciona un lote y completa los filtros' : 'Generar reporte'">
          <fa-icon *ngIf="loading()" [icon]="faSpinner" class="spinning"></fa-icon>
          <fa-icon *ngIf="!loading()" [icon]="faSearch"></fa-icon>
          Generar Reporte
        </button>

        <button
          type="button"
          class="btn btn--outline"
          (click)="exportarExcel()"
          [disabled]="loading() || !reporteLevanteConTabs()"
          [title]="!reporteLevanteConTabs() ? 'Primero genera un reporte' : 'Exportar a Excel'">
          <fa-icon [icon]="faFileExcel"></fa-icon>
          Exportar Excel
        </button>
      </div>
    </header>

    <!-- Filtros de selecci贸n -->
    <app-filtro-select
      [selectedGranjaId]="selectedGranjaId"
      [selectedNucleoId]="selectedNucleoId"
      [selectedGalponId]="selectedGalponId"
      [selectedLoteId]="selectedLoteId"
      (granjaChange)="onGranjaChange($event)"
      (nucleoChange)="onNucleoChange($event)"
      (galponChange)="onGalponChange($event)"
      (loteChange)="onLoteChange($event)">
    </app-filtro-select>

    <!-- Filtros de Reporte -->
    <section class="ux-card" *ngIf="selectedLoteId">
      <h3 class="sr-only">Configuraci贸n del Reporte</h3>
      
      <div class="ux-form">
        <div class="grid grid-2">
          <!-- Tipo de Consolidaci贸n -->
          <div class="form-field">
            <label class="ux-label">Tipo de Consolidaci贸n</label>
            <div class="radio-group">
              <label class="radio-label">
                <input 
                  type="radio" 
                  name="tipoConsolidacion" 
                  value="sublote"
                  [(ngModel)]="tipoConsolidacion"
                  (change)="limpiarReporte()">
                Sublote
              </label>
              <label class="radio-label">
                <input 
                  type="radio" 
                  name="tipoConsolidacion" 
                  value="consolidado"
                  [(ngModel)]="tipoConsolidacion"
                  (change)="limpiarReporte()">
                Consolidado
              </label>
            </div>
          </div>

          <!-- Nombre Base del Lote (Consolidado) -->
          <div class="form-field" *ngIf="tipoConsolidacion === 'consolidado'">
            <label class="ux-label">Nombre del Lote Base</label>
            <input 
              type="text"
              class="ux-input"
              [(ngModel)]="loteNombreBase"
              placeholder="Ej: K326"
              (blur)="cargarSublotes(loteNombreBase)">
            <small class="ux-hint">Ingrese el nombre base del lote (sin sublote)</small>
          </div>

          <!-- Fechas para reportes diarios -->
          <div class="form-field">
            <label class="ux-label">Fecha Inicio</label>
            <input 
              type="date"
              class="ux-input"
              [(ngModel)]="fechaInicio">
          </div>

          <div class="form-field">
            <label class="ux-label">Fecha Fin</label>
            <input 
              type="date"
              class="ux-input"
              [(ngModel)]="fechaFin">
          </div>
        </div>
      </div>
    </section>

    <!-- Mensaje de Error -->
    <div class="ux-card" *ngIf="error" role="alert">
      <div class="alert alert-danger">
        <strong>Error:</strong> {{ error }}
      </div>
    </div>

    <!-- Tabs Internos: Diario Hembras, Diario Machos, Registro Semanal -->
    <section class="ux-card" *ngIf="reporteLevanteConTabs()">
      <!-- Tabs Navigation -->
      <div class="ux-tabs-internos">
        <input 
          type="radio" 
          id="tab-hembras" 
          name="tab-levante-interno" 
          [checked]="tabLevanteActivo === 'hembras'"
          (change)="tabLevanteActivo = 'hembras'">
        <label for="tab-hembras" class="ux-tab"> Diario Hembras</label>
        
        <input 
          type="radio" 
          id="tab-machos" 
          name="tab-levante-interno" 
          [checked]="tabLevanteActivo === 'machos'"
          (change)="tabLevanteActivo = 'machos'">
        <label for="tab-machos" class="ux-tab"> Diario Machos</label>
        
        <input 
          type="radio" 
          id="tab-semanal-hembras" 
          name="tab-levante-interno" 
          [checked]="tabLevanteActivo === 'semanal-hembras'"
          (change)="tabLevanteActivo = 'semanal-hembras'">
        <label for="tab-semanal-hembras" class="ux-tab"> Registro Semana Hembras</label>
        
        <input 
          type="radio" 
          id="tab-semanal-machos" 
          name="tab-levante-interno" 
          [checked]="tabLevanteActivo === 'semanal-machos'"
          (change)="tabLevanteActivo = 'semanal-machos'">
        <label for="tab-semanal-machos" class="ux-tab"> Registro Semana Machos</label>
      </div>

      <!-- Encabezado del Reporte -->
      <div class="reporte-header">
        <div class="reporte-info">
          <h2>
            Reporte T茅cnico Levante SanMarino - {{ reporteLevanteConTabs()!.informacionLote.loteNombre }}
            <span *ngIf="reporteLevanteConTabs()!.informacionLote.sublote" class="chip chip--info">
              {{ reporteLevanteConTabs()!.informacionLote.sublote }}
            </span>
            <span *ngIf="reporteLevanteConTabs()!.esConsolidado" class="chip chip--warning">
              Consolidado
            </span>
          </h2>
          <div class="reporte-metadata">
            <span><strong>L铆nea:</strong> {{ reporteLevanteConTabs()!.informacionLote.linea || 'N/A' }}</span>
            <span><strong>Raza:</strong> {{ reporteLevanteConTabs()!.informacionLote.raza || 'N/A' }}</span>
            <span><strong>Etapa:</strong> LEVANTE</span>
            <span *ngIf="reporteLevanteConTabs()!.informacionLote.fechaEncaset">
              <strong>Encaset:</strong> {{ formatDate(reporteLevanteConTabs()!.informacionLote.fechaEncaset) }}
            </span>
            <span *ngIf="reporteLevanteConTabs()!.informacionLote.granjaNombre">
              <strong>Granja:</strong> {{ reporteLevanteConTabs()!.informacionLote.granjaNombre }}
            </span>
            <span *ngIf="reporteLevanteConTabs()!.informacionLote.galpon">
              <strong>Galp贸n:</strong> {{ reporteLevanteConTabs()!.informacionLote.galpon }}
            </span>
            <span *ngIf="reporteLevanteConTabs()!.informacionLote.numeroHembras">
              <strong>N煤mero de Hembras:</strong> {{ reporteLevanteConTabs()!.informacionLote.numeroHembras }}
            </span>
          </div>
        </div>
      </div>

      <!-- Tab 1: Diario Hembras -->
      <div class="tab-content" *ngIf="tabLevanteActivo === 'hembras'">
        <div class="datos-section" *ngIf="reporteLevanteConTabs()!.datosDiariosHembras.length > 0">
          <h3>ETAPA DE LEVANTE DIARIO - HEMBRAS</h3>
          <app-tabla-datos-diarios-hembras 
            [datos]="reporteLevanteConTabs()!.datosDiariosHembras"
            [informacionLote]="reporteLevanteConTabs()!.informacionLote">
          </app-tabla-datos-diarios-hembras>
        </div>
        <div class="empty-state" *ngIf="reporteLevanteConTabs()!.datosDiariosHembras.length === 0">
          <p>No se encontraron datos diarios de hembras para el per铆odo seleccionado.</p>
        </div>
      </div>

      <!-- Tab 2: Diario Machos -->
      <div class="tab-content" *ngIf="tabLevanteActivo === 'machos'">
        <div class="datos-section" *ngIf="reporteLevanteConTabs()!.datosDiariosMachos.length > 0">
          <h3>ETAPA DE LEVANTE DIARIO - MACHOS</h3>
          <app-tabla-datos-diarios-machos 
            [datos]="reporteLevanteConTabs()!.datosDiariosMachos"
            [informacionLote]="reporteLevanteConTabs()!.informacionLote">
          </app-tabla-datos-diarios-machos>
        </div>
        <div class="empty-state" *ngIf="reporteLevanteConTabs()!.datosDiariosMachos.length === 0">
          <p>No se encontraron datos diarios de machos para el per铆odo seleccionado.</p>
        </div>
      </div>

      <!-- Tab 3: Registro Semana Hembras -->
      <div class="tab-content" *ngIf="tabLevanteActivo === 'semanal-hembras'">
        <div class="datos-section" *ngIf="reporteLevanteConTabs()!.datosSemanales.length > 0">
          <h3>REGISTRO SEMANA HEMBRAS</h3>
          <app-tabla-levante-semanal-hembras 
            [datos]="reporteLevanteConTabs()!.datosSemanales"
            [informacionLote]="reporteLevanteConTabs()!.informacionLote">
          </app-tabla-levante-semanal-hembras>
        </div>
        <div class="empty-state" *ngIf="reporteLevanteConTabs()!.datosSemanales.length === 0">
          <p>No se encontraron datos semanales de hembras para el lote seleccionado.</p>
        </div>
      </div>

      <!-- Tab 4: Registro Semana Machos -->
      <div class="tab-content" *ngIf="tabLevanteActivo === 'semanal-machos'">
        <div class="datos-section" *ngIf="reporteLevanteConTabs()!.datosSemanales.length > 0">
          <h3>REGISTRO SEMANA MACHOS</h3>
          <app-tabla-levante-semanal-machos 
            [datos]="reporteLevanteConTabs()!.datosSemanales"
            [informacionLote]="reporteLevanteConTabs()!.informacionLote">
          </app-tabla-levante-semanal-machos>
        </div>
        <div class="empty-state" *ngIf="reporteLevanteConTabs()!.datosSemanales.length === 0">
          <p>No se encontraron datos semanales de machos para el lote seleccionado.</p>
        </div>
      </div>
    </section>

    <!-- Modal de F贸rmulas -->
    <div class="formulas-modal" *ngIf="mostrarFormulas" (click)="mostrarFormulas = false">
      <div class="formulas-content" (click)="$event.stopPropagation()">
        <div class="formulas-header">
          <h4> F贸rmulas de Reportes T茅cnicos</h4>
          <button class="btn-close" (click)="mostrarFormulas = false"></button>
        </div>
        <div class="formulas-body">
          <div class="formula-group" *ngFor="let grupo of gruposFormulas">
            <h5 class="formula-group-title">{{ grupo.titulo }}</h5>
            <ul class="formula-list">
              <li *ngFor="let formula of grupo.formulas" class="formula-item">
                <strong>{{ formula.nombre }}:</strong>
                <span class="formula-text">{{ formula.formula }}</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
