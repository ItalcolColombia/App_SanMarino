<!-- Modal de Seguimiento Diario de Producci√≥n -->
<div *ngIf="isOpen" class="ux-modal" role="dialog" aria-modal="true" aria-labelledby="seguimiento-diario-modal-title">
  <div class="ux-modal__dialog">
    <header class="ux-modal__header">
      <h2 id="seguimiento-diario-modal-title">{{ editingSeguimiento ? 'Editar Seguimiento Diario' : 'Nuevo Seguimiento Diario' }}</h2>
      <button type="button" class="icon-btn" (click)="onClose()" aria-label="Cerrar">‚úï</button>
    </header>

    <form [formGroup]="form" (ngSubmit)="onSave()" class="ux-form" novalidate>
      <!-- INPUTS RADIO (ocultos, controlan los tabs) -->
      <input type="radio" name="regTab" id="tab-general" checked class="ux-tab-input" />
      <input type="radio" name="regTab" id="tab-hembras" class="ux-tab-input" />
      <input type="radio" name="regTab" id="tab-machos" class="ux-tab-input" />
      <input type="radio" name="regTab" id="tab-huevos" class="ux-tab-input" />
      <input type="radio" name="regTab" id="tab-pesaje" class="ux-tab-input" />

      <!-- TABS NAVEGACI√ìN - ARRIBA -->
      <div class="ux-tabs-wrapper">
      <div class="ux-tabs" role="tablist" aria-label="Secciones del seguimiento diario">
          <label class="ux-tab" id="lab-general" for="tab-general" role="tab" tabindex="0" aria-controls="panel-general" aria-selected="true">
            <span class="tab-icon">üìã</span>
            <span class="tab-label">General</span>
          </label>

          <label class="ux-tab" id="lab-hembras" for="tab-hembras" role="tab" tabindex="0" aria-controls="panel-hembras" aria-selected="false">
            <span class="tab-icon">‚ôÄÔ∏è</span>
            <span class="tab-label">Hembras</span>
          </label>

          <label class="ux-tab" id="lab-machos" for="tab-machos" role="tab" tabindex="0" aria-controls="panel-machos" aria-selected="false">
            <span class="tab-icon">‚ôÇÔ∏è</span>
            <span class="tab-label">Machos</span>
          </label>

          <label class="ux-tab" id="lab-huevos" for="tab-huevos" role="tab" tabindex="0" aria-controls="panel-huevos" aria-selected="false">
            <span class="tab-icon">ü•ö</span>
            <span class="tab-label">Huevos</span>
          </label>

          <label class="ux-tab" id="lab-pesaje" for="tab-pesaje" role="tab" tabindex="0" aria-controls="panel-pesaje" aria-selected="false">
            <span class="tab-icon">‚öñÔ∏è</span>
            <span class="tab-label">Pesaje Semanal</span>
          </label>
        </div>
      </div>

      <!-- CONTENIDO DE TABS - DEBAJO -->
        <div class="ux-tab-panels">
          <!-- GENERAL -->
          <section id="panel-general" class="ux-tab-panel" role="tabpanel" aria-labelledby="lab-general">
            <div class="tab-panel-header">
              <h3>Informaci√≥n General</h3>
              <p class="tab-description">Configuraci√≥n b√°sica del seguimiento diario</p>
            </div>
            <div class="grid grid-3">
              <div class="form-field">
                <label for="f-fecha-registro">
                  <span class="label-icon">üìÖ</span>
                  Fecha de Registro *
                </label>
                <input id="f-fecha-registro" type="date" formControlName="fechaRegistro" required />
                <small class="ux-hint">Fecha del seguimiento diario</small>
              </div>

              <div class="form-field">
                <label for="f-produccion-lote-id">
                  <span class="label-icon">üî¢</span>
                  Producci√≥n Lote ID
                </label>
                <input id="f-produccion-lote-id" type="number" formControlName="produccionLoteId" readonly class="ux-input--readonly" />
                <small class="ux-hint">ID del registro inicial</small>
              </div>

              <div class="form-field">
                <label for="f-etapa-general">
                  <span class="label-icon">üìä</span>
                  Etapa de Producci√≥n
                </label>
                <select id="f-etapa-general" formControlName="etapa" required>
                  <option [value]="1">Etapa 1 (Semana 25-33)</option>
                  <option [value]="2">Etapa 2 (Semana 34-50)</option>
                  <option [value]="3">Etapa 3 (Semana >50)</option>
                </select>
                <small class="ux-hint">{{ getEtapaLabel(form.get('etapa')?.value || 1) }}</small>
              </div>

              <div class="form-field form-field--full">
                <label for="f-obs">
                  <span class="label-icon">üìù</span>
                  Observaciones
                </label>
                <textarea id="f-obs" rows="4" formControlName="observaciones" placeholder="Ingrese observaciones adicionales sobre el seguimiento (opcional)"></textarea>
              </div>
            </div>
          </section>

          <!-- HEMBRAS -->
          <section id="panel-hembras" class="ux-tab-panel" role="tabpanel" aria-labelledby="lab-hembras">
            <div class="tab-panel-header">
              <h3>Informaci√≥n de Hembras ‚ôÄÔ∏è</h3>
              <p class="tab-description">Registro de mortalidad, retiros y consumo de hembras</p>
            </div>
            <div class="grid grid-3">
              <div class="form-field">
                <label for="f-mortalidad-h">
                  <span class="label-icon">üíÄ</span>
                  Mortalidad Hembras *
                </label>
                <input id="f-mortalidad-h" type="number" min="0" formControlName="mortalidadH" placeholder="0" required />
                <small class="ux-hint">N√∫mero de hembras que murieron</small>
              </div>

              <div class="form-field">
                <label for="f-sel-h">
                  <span class="label-icon">‚Ü©Ô∏è</span>
                  SelH (Retiradas) *
                </label>
                <input id="f-sel-h" type="number" min="0" formControlName="selH" placeholder="0" required />
                <small class="ux-hint">Hembras retiradas/seleccionadas</small>
              </div>

              <!-- Tipo de √≠tem y alimento para hembras -->
              <div class="form-field">
                <label for="f-tipo-item-h">
                  <span class="label-icon">üì¶</span>
                  Tipo de √çtem Hembras
                </label>
                <select id="f-tipo-item-h" formControlName="tipoItemHembras" [disabled]="editingSeguimiento && editingSeguimiento.metadata?.tipoItemHembras">
                  <option [value]="null">Seleccione...</option>
                  <option *ngFor="let tipo of tiposItem" [value]="tipo">{{ tipo }}</option>
                </select>
                <small class="ux-hint">Tipo de √≠tem (alimento, medicamento, etc.)</small>
              </div>

              <div class="form-field">
                <label for="f-alimento-h">
                  <span class="label-icon">üåæ</span>
                  Alimento Hembras
                </label>
                <select id="f-alimento-h" formControlName="tipoAlimentoHembras" [disabled]="!form.get('tipoItemHembras')?.value || (editingSeguimiento && editingSeguimiento.metadata?.tipoAlimentoHembras)">
                  <option [value]="null">Seleccione un alimento...</option>
                  <option *ngFor="let alimento of alimentosFiltradosHembras" [value]="alimento.id">
                    {{ alimento.codigo }} - {{ alimento.nombre }}
                  </option>
                </select>
                <small class="ux-hint" *ngIf="mensajeInventarioHembras">{{ mensajeInventarioHembras }}</small>
              </div>

              <!-- Consumo con unidad de medida -->
              <div class="form-field">
                <label for="f-consumo-h">Consumo Hembras *</label>
                <div class="flex gap-1" style="display: flex; gap: 0.5rem; align-items: flex-end;">
                  <div style="flex: 1;">
                    <input id="f-consumo-h" type="number" step="0.001" min="0" formControlName="consumoHembras" />
                  </div>
                  <div style="width: 100px;">
                    <select formControlName="unidadConsumoHembras" class="ux-select" style="width: 100%;">
                      <option value="kg">kg</option>
                      <option value="g">gramos</option>
                    </select>
                  </div>
                </div>
                <small class="ux-hint" *ngIf="form.get('unidadConsumoHembras')?.value === 'g' && inventarioDisponibleHembras !== null">
                  Equivale a {{ (form.get('consumoHembras')?.value || 0) / 1000 | number:'1.3-3' }} kg
                  <span *ngIf="inventarioUnidadHembras === 'kg'" class="text-info">
                    (se reducir√° del inventario en kilogramos)
                  </span>
                </small>
                <small class="ux-hint text-muted" *ngIf="form.get('unidadConsumoHembras')?.value === 'kg'">
                  El valor se guardar√° directamente en kilogramos.
                </small>
              </div>

              <div class="form-field form-field--full">
                <div class="resumen-card resumen-card--hembras">
                  <div class="resumen-icon">‚ôÄÔ∏è</div>
                  <div class="resumen-content">
                    <h4>Resumen Hembras</h4>
                    <div class="resumen-stats">
                      <div class="stat-item">
                        <span class="stat-label">Total Retiradas</span>
                        <span class="stat-value">{{ getTotalRetiradasHembras() }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Consumo</span>
                        <span class="stat-value">{{ getTotalConsumo() | number:'1.2-2' }} kg</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- MACHOS -->
          <section id="panel-machos" class="ux-tab-panel" role="tabpanel" aria-labelledby="lab-machos">
            <div class="tab-panel-header">
              <h3>Informaci√≥n de Machos ‚ôÇÔ∏è</h3>
              <p class="tab-description">Registro de mortalidad, retiros y consumo de machos</p>
            </div>
            <div class="grid grid-3">
              <div class="form-field">
                <label for="f-mortalidad-m">
                  <span class="label-icon">üíÄ</span>
                  Mortalidad Machos *
                </label>
                <input id="f-mortalidad-m" type="number" min="0" formControlName="mortalidadM" placeholder="0" required />
                <small class="ux-hint">N√∫mero de machos que murieron</small>
              </div>

              <div class="form-field">
                <label for="f-sel-m">
                  <span class="label-icon">‚Ü©Ô∏è</span>
                  SelM (Retiradas) *
                </label>
                <input id="f-sel-m" type="number" min="0" formControlName="selM" placeholder="0" required />
                <small class="ux-hint">Machos retirados/seleccionados</small>
              </div>

              <!-- Tipo de √≠tem y alimento para machos -->
              <div class="form-field">
                <label for="f-tipo-item-m">
                  <span class="label-icon">üì¶</span>
                  Tipo de √çtem Machos
                </label>
                <select id="f-tipo-item-m" formControlName="tipoItemMachos" [disabled]="editingSeguimiento && editingSeguimiento.metadata?.tipoItemMachos">
                  <option [value]="null">Seleccione...</option>
                  <option *ngFor="let tipo of tiposItem" [value]="tipo">{{ tipo }}</option>
                </select>
                <small class="ux-hint">Tipo de √≠tem (alimento, medicamento, etc.)</small>
              </div>

              <div class="form-field">
                <label for="f-alimento-m">
                  <span class="label-icon">üåæ</span>
                  Alimento Machos
                </label>
                <select id="f-alimento-m" formControlName="tipoAlimentoMachos" [disabled]="!form.get('tipoItemMachos')?.value || (editingSeguimiento && editingSeguimiento.metadata?.tipoAlimentoMachos)">
                  <option [value]="null">Seleccione un alimento...</option>
                  <option *ngFor="let alimento of alimentosFiltradosMachos" [value]="alimento.id">
                    {{ alimento.codigo }} - {{ alimento.nombre }}
                  </option>
                </select>
                <small class="ux-hint" *ngIf="mensajeInventarioMachos">{{ mensajeInventarioMachos }}</small>
              </div>

              <!-- Consumo con unidad de medida -->
              <div class="form-field">
                <label for="f-consumo-m">Consumo Machos *</label>
                <div class="flex gap-1" style="display: flex; gap: 0.5rem; align-items: flex-end;">
                  <div style="flex: 1;">
                    <input id="f-consumo-m" type="number" step="0.001" min="0" formControlName="consumoMachos" />
                  </div>
                  <div style="width: 100px;">
                    <select formControlName="unidadConsumoMachos" class="ux-select" style="width: 100%;">
                      <option value="kg">kg</option>
                      <option value="g">gramos</option>
                    </select>
                  </div>
                </div>
                <small class="ux-hint" *ngIf="form.get('unidadConsumoMachos')?.value === 'g' && inventarioDisponibleMachos !== null">
                  Equivale a {{ (form.get('consumoMachos')?.value || 0) / 1000 | number:'1.3-3' }} kg
                  <span *ngIf="inventarioUnidadMachos === 'kg'" class="text-info">
                    (se reducir√° del inventario en kilogramos)
                  </span>
                </small>
                <small class="ux-hint text-muted" *ngIf="form.get('unidadConsumoMachos')?.value === 'kg'">
                  El valor se guardar√° directamente en kilogramos.
                </small>
              </div>

              <div class="form-field form-field--empty">
                <!-- Espacio vac√≠o para mantener el grid -->
              </div>

              <div class="form-field form-field--full">
                <div class="resumen-card resumen-card--machos">
                  <div class="resumen-icon">‚ôÇÔ∏è</div>
                  <div class="resumen-content">
                    <h4>Resumen Machos</h4>
                    <div class="resumen-stats">
                      <div class="stat-item">
                        <span class="stat-label">Total Retiradas</span>
                        <span class="stat-value">{{ getTotalRetiradasMachos() }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Consumo</span>
                        <span class="stat-value">{{ (form.get('consumoMachos')?.value || 0) / (form.get('unidadConsumoMachos')?.value === 'g' ? 1000 : 1) | number:'1.2-2' }} kg</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- HUEVOS -->
          <section id="panel-huevos" class="ux-tab-panel" role="tabpanel" aria-labelledby="lab-huevos">
            <div class="tab-panel-header">
              <h3>Producci√≥n de Huevos ü•ö</h3>
              <p class="tab-description">Registro de producci√≥n, calidad y par√°metros de huevos</p>
            </div>
            <div class="grid grid-4">
              <div class="form-field">
                <label for="f-huevos-totales">
                  <span class="label-icon">ü•ö</span>
                  Huevos Totales (HuevoTot) *
                </label>
                <input id="f-huevos-totales" type="number" min="0" formControlName="huevosTotales" placeholder="0" required />
                <small class="ux-hint">Total de huevos producidos</small>
              </div>

              <div class="form-field">
                <label for="f-huevos-incubables">
                  <span class="label-icon">‚úÖ</span>
                  Huevos Incubables (HuevoInc) *
                </label>
                <input id="f-huevos-incubables" type="number" min="0" formControlName="huevosIncubables" placeholder="0" required />
                <small class="ux-hint">Huevos aptos para incubaci√≥n</small>
              </div>

              <div class="form-field">
                <label for="f-peso-huevo">
                  <span class="label-icon">‚öñÔ∏è</span>
                  Peso Promedio (g) *
                </label>
                <input id="f-peso-huevo" type="number" step="0.01" min="0" formControlName="pesoHuevo" placeholder="0.00" required />
                <small class="ux-hint">Peso promedio en gramos</small>
              </div>

              <div class="form-field">
                <label for="f-tipo-alimento">
                  <span class="label-icon">üåæ</span>
                  Tipo de Alimento *
                </label>
                <select id="f-tipo-alimento" formControlName="tipoAlimento" required>
                  <option value="Standard">Standard</option>
                  <option value="Premium">Premium</option>
                  <option value="Inicio">Inicio</option>
                  <option value="Postura">Postura</option>
                  <option value="Final">Final</option>
                </select>
                <small class="ux-hint">Tipo de alimento utilizado</small>
              </div>

              <!-- CLASIFICADORA DE HUEVOS - HUEVOS INCUBABLES (Se suman a HuevoInc) -->
              <div class="form-field form-field--full">
                <div class="clasificadora-section">
                  <h4 class="clasificadora-title">
                    <span class="label-icon">‚úÖ</span>
                    Clasificadora de Huevos - Incubables (Se suman a HuevoInc)
                  </h4>
                  <div class="grid grid-2">
                    <div class="form-field">
                      <label for="f-huevo-limpio">
                        <span class="label-icon">‚ú®</span>
                        Limpio
                      </label>
                      <input id="f-huevo-limpio" type="number" min="0" formControlName="huevoLimpio" placeholder="0" />
                      <small class="ux-hint">Huevos limpios</small>
                    </div>

                    <div class="form-field">
                      <label for="f-huevo-tratado">
                        <span class="label-icon">üß¥</span>
                        Tratado
                      </label>
                      <input id="f-huevo-tratado" type="number" min="0" formControlName="huevoTratado" placeholder="0" />
                      <small class="ux-hint">Huevos tratados</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- CLASIFICADORA DE HUEVOS - HUEVOS NO INCUBABLES (Se suman a Huevo Total) -->
              <div class="form-field form-field--full">
                <div class="clasificadora-section">
                  <h4 class="clasificadora-title">
                    <span class="label-icon">üìã</span>
                    Clasificadora de Huevos - No Incubables (Se suman a Huevo Total)
                  </h4>
                  <div class="grid grid-3">
                    <div class="form-field">
                      <label for="f-huevo-sucio">
                        <span class="label-icon">üßπ</span>
                        Sucio
                      </label>
                      <input id="f-huevo-sucio" type="number" min="0" formControlName="huevoSucio" placeholder="0" />
                    </div>

                    <div class="form-field">
                      <label for="f-huevo-deforme">
                        <span class="label-icon">üîÄ</span>
                        Deforme
                      </label>
                      <input id="f-huevo-deforme" type="number" min="0" formControlName="huevoDeforme" placeholder="0" />
                    </div>

                    <div class="form-field">
                      <label for="f-huevo-blanco">
                        <span class="label-icon">‚ö™</span>
                        Blanco
                      </label>
                      <input id="f-huevo-blanco" type="number" min="0" formControlName="huevoBlanco" placeholder="0" />
                    </div>

                    <div class="form-field">
                      <label for="f-huevo-doble-yema">
                        <span class="label-icon">ü•ö</span>
                        Doble Yema
                      </label>
                      <input id="f-huevo-doble-yema" type="number" min="0" formControlName="huevoDobleYema" placeholder="0" />
                    </div>

                    <div class="form-field">
                      <label for="f-huevo-piso">
                        <span class="label-icon">üì¶</span>
                        Piso
                      </label>
                      <input id="f-huevo-piso" type="number" min="0" formControlName="huevoPiso" placeholder="0" />
                    </div>

                    <div class="form-field">
                      <label for="f-huevo-pequeno">
                        <span class="label-icon">üî∏</span>
                        Peque√±o
                      </label>
                      <input id="f-huevo-pequeno" type="number" min="0" formControlName="huevoPequeno" placeholder="0" />
                    </div>

                    <div class="form-field">
                      <label for="f-huevo-roto">
                        <span class="label-icon">üíî</span>
                        Roto
                      </label>
                      <input id="f-huevo-roto" type="number" min="0" formControlName="huevoRoto" placeholder="0" />
                    </div>

                    <div class="form-field">
                      <label for="f-huevo-desecho">
                        <span class="label-icon">üóëÔ∏è</span>
                        Desecho
                      </label>
                      <input id="f-huevo-desecho" type="number" min="0" formControlName="huevoDesecho" placeholder="0" />
                    </div>

                    <div class="form-field">
                      <label for="f-huevo-otro">
                        <span class="label-icon">üìå</span>
                        Otro
                      </label>
                      <input id="f-huevo-otro" type="number" min="0" formControlName="huevoOtro" placeholder="0" />
                    </div>
                  </div>
                </div>
              </div>

              <!-- RESUMEN -->
              <div class="form-field form-field--full">
                <div class="resumen-card resumen-card--huevos">
                  <div class="resumen-icon">ü•ö</div>
                  <div class="resumen-content">
                    <h4>Eficiencia de Producci√≥n</h4>
                    <div class="resumen-stats">
                      <div class="stat-item stat-item--highlight">
                        <span class="stat-label">Eficiencia</span>
                        <span class="stat-value">{{ getEficienciaProduccion() }}%</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Totales</span>
                        <span class="stat-value">{{ form.get('huevosTotales')?.value || 0 }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Incubables</span>
                        <span class="stat-value">{{ form.get('huevosIncubables')?.value || 0 }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Limpio + Tratado</span>
                        <span class="stat-value">{{ (form.get('huevoLimpio')?.value || 0) + (form.get('huevoTratado')?.value || 0) }}</span>
                      </div>
                    </div>
                    <small class="ux-hint">Porcentaje de huevos incubables sobre el total</small>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- PESAJE SEMANAL -->
          <section id="panel-pesaje" class="ux-tab-panel" role="tabpanel" aria-labelledby="lab-pesaje">
            <div class="tab-panel-header">
              <h3>Pesaje Semanal ‚öñÔ∏è</h3>
              <p class="tab-description">Registro de informaci√≥n de pesaje semanal (una vez por semana)</p>
            </div>
            <div class="grid grid-4">
              <div class="form-field">
                <label for="f-peso-h">
                  <span class="label-icon">‚ôÄÔ∏è</span>
                  Peso Hembras (kg) - pesoH
                </label>
                <input id="f-peso-h" type="number" step="0.01" min="0" formControlName="pesoH" placeholder="0.00" />
                <small class="ux-hint">Peso promedio de hembras en kilogramos</small>
              </div>

              <div class="form-field">
                <label for="f-peso-m">
                  <span class="label-icon">‚ôÇÔ∏è</span>
                  Peso Machos (kg) - pesoM
                </label>
                <input id="f-peso-m" type="number" step="0.01" min="0" formControlName="pesoM" placeholder="0.00" />
                <small class="ux-hint">Peso promedio de machos en kilogramos</small>
              </div>

              <div class="form-field">
                <label for="f-uniformidad">
                  <span class="label-icon">üìä</span>
                  Uniformidad (%)
                </label>
                <input id="f-uniformidad" type="number" step="0.01" min="0" max="100" formControlName="uniformidad" placeholder="0.00" />
                <small class="ux-hint">Uniformidad del lote (porcentaje)</small>
              </div>

              <div class="form-field">
                <label for="f-coeficiente-variacion">
                  <span class="label-icon">üìà</span>
                  Coeficiente de Variaci√≥n (CV)
                </label>
                <input id="f-coeficiente-variacion" type="number" step="0.01" min="0" max="100" formControlName="coeficienteVariacion" placeholder="0.00" />
                <small class="ux-hint">Coeficiente de variaci√≥n del lote</small>
              </div>

              <div class="form-field form-field--full">
                <label for="f-obs-pesaje">
                  <span class="label-icon">üìù</span>
                  Observaciones del Pesaje
                </label>
                <textarea id="f-obs-pesaje" rows="4" formControlName="observacionesPesaje" placeholder="Ingrese observaciones espec√≠ficas sobre el pesaje semanal (opcional)"></textarea>
              </div>
            </div>
          </section>
      </div>

      <footer class="ux-modal__footer">
        <button type="button" class="btn btn--ghost" (click)="onClose()">Cancelar</button>
        <button type="submit" class="btn btn--primary" [disabled]="loading || form.invalid">
          {{ loading ? 'Guardando‚Ä¶' : (editingSeguimiento ? 'Actualizar' : 'Guardar Seguimiento') }}
        </button>
      </footer>
    </form>

    <div *ngIf="loading" class="modal-loading" role="status" aria-live="polite">
      <div class="spinner"></div> Guardando‚Ä¶
    </div>
  </div>
</div>



