<!-- ================= GR√ÅFICAS PRINCIPAL PRODUCCI√ìN ================= -->
<div class="graficas-container">
  <div class="graficas-header">
    <h3>üìä An√°lisis Gr√°fico de Producci√≥n</h3>
    <p class="graficas-subtitle" *ngIf="selectedLote">
      {{ selectedLote.loteNombre || ('Lote #' + selectedLote.loteId) }} - Semanas {{ SEMANA_INICIO_PRODUCCION }}-{{ SEMANA_MAX_PRODUCCION }} ({{ indicadoresSemanales.length }} semanas registradas)
    </p>
  </div>

  <!-- Estado de carga -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>Cargando datos para gr√°ficas...</p>
  </div>

  <!-- Estado sin datos -->
  <div class="empty-state" *ngIf="!loading && indicadoresSemanales.length === 0">
    <div class="empty-icon">üìä</div>
    <h4>No hay datos para mostrar</h4>
    <p>Se necesitan registros de seguimiento diario de producci√≥n para generar las gr√°ficas.</p>
    <p class="empty-hint">Las semanas de producci√≥n comienzan desde la semana {{ SEMANA_INICIO_PRODUCCION }}.</p>
  </div>

  <!-- Contenido principal de gr√°ficas -->
  <div *ngIf="!loading && indicadoresSemanales.length > 0" class="graficas-content-wrapper">

    <!-- ========== CONTROLES ========== -->
    <div class="graficas-controls">
      <!-- Selector de tipo de gr√°fica -->
      <div class="control-group">
        <label class="control-label">üìà Tipo de Indicador:</label>
        <select class="control-select"
                [(ngModel)]="tipoGraficaSeleccionada"
                (ngModelChange)="onTipoGraficaChange()">
          <option value="huevos">Huevos</option>
          <option value="mortalidad">Mortalidad</option>
          <option value="consumo">Consumo</option>
          <option value="eficiencia">Eficiencia</option>
          <option value="aves">Aves Vivas</option>
        </select>
      </div>

      <!-- Selector de visualizaci√≥n -->
      <div class="control-group">
        <label class="control-label">üé® Visualizaci√≥n:</label>
        <div class="visualization-toggle">
          <button type="button"
                  class="toggle-btn"
                  [class.active]="tipoVisualizacion === 'barra'"
                  (click)="tipoVisualizacion = 'barra'; onVisualizacionChange()">
            üìä Barras
          </button>
          <button type="button"
                  class="toggle-btn"
                  [class.active]="tipoVisualizacion === 'linea'"
                  (click)="tipoVisualizacion = 'linea'; onVisualizacionChange()">
            üìà L√≠neas
          </button>
          <button type="button"
                  class="toggle-btn"
                  [class.active]="tipoVisualizacion === 'torta'"
                  (click)="tipoVisualizacion = 'torta'; onVisualizacionChange()">
            ü•ß Torta
          </button>
        </div>
      </div>

      <!-- Selector comparativo -->
      <div class="control-group control-group--comparativo">
        <label class="control-label">
          <input type="checkbox"
                 [(ngModel)]="mostrarComparativo"
                 (change)="toggleComparativo()">
          Comparar Semanas
        </label>
        <div class="comparativo-selectors" *ngIf="mostrarComparativo">
          <select class="control-select"
                  [(ngModel)]="semanaComparacion1"
                  (ngModelChange)="onSemanaComparacionChange()">
            <option [ngValue]="null">Seleccione semana 1</option>
            <option *ngFor="let semana of semanasDisponibles" [ngValue]="semana">
              Semana {{ semana }}
            </option>
          </select>
          <span class="vs-badge">VS</span>
          <select class="control-select"
                  [(ngModel)]="semanaComparacion2"
                  (ngModelChange)="onSemanaComparacionChange()">
            <option [ngValue]="null">Seleccione semana 2</option>
            <option *ngFor="let semana of semanasDisponibles" [ngValue]="semana">
              Semana {{ semana }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- ========== GR√ÅFICA PRINCIPAL ========== -->
    <div class="grafica-principal-section">
      <div class="grafica-card">
        <div class="grafica-card-header">
          <h4>{{ getTituloGrafica() }}</h4>
          <span class="grafica-badge">{{ indicadoresSemanales.length }} semanas</span>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container" *ngIf="mostrarComparativo && semanaComparacion1 && semanaComparacion2">
            <canvas baseChart
                    [type]="barChartType"
                    [data]="comparativoChartData"
                    [options]="comparativoChartOptions">
            </canvas>
            <div class="chart-info">
              <p class="info-text">
                Comparando <strong>Semana {{ semanaComparacion1 }}</strong> vs
                <strong>Semana {{ semanaComparacion2 }}</strong>
              </p>
            </div>
          </div>

          <div class="chart-container" *ngIf="!mostrarComparativo || !semanaComparacion1 || !semanaComparacion2">
            <!-- Gr√°fica de Huevos -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'huevos' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="huevosChartData"
                    [options]="huevosChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'huevos' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="huevosChartData"
                    [options]="huevosChartOptions">
            </canvas>

            <!-- Gr√°fica de Mortalidad -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'mortalidad' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="mortalidadChartData"
                    [options]="mortalidadChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'mortalidad' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="mortalidadChartData"
                    [options]="mortalidadChartOptions">
            </canvas>

            <!-- Gr√°fica de Consumo -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'consumo' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="consumoChartData"
                    [options]="consumoChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'consumo' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="consumoChartData"
                    [options]="consumoChartOptions">
            </canvas>

            <!-- Gr√°fica de Eficiencia -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'eficiencia' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="eficienciaChartData"
                    [options]="eficienciaChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'eficiencia' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="eficienciaChartData"
                    [options]="eficienciaChartOptions">
            </canvas>

            <!-- Gr√°fica de Aves -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'aves' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="avesChartData"
                    [options]="avesChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'aves' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="avesChartData"
                    [options]="avesChartOptions">
            </canvas>

            <!-- Gr√°fica de Torta (distribuci√≥n huevos) -->
            <canvas *ngIf="tipoVisualizacion === 'torta'"
                    baseChart
                    [type]="pieChartType"
                    [data]="tortaChartData"
                    [options]="tortaChartOptions">
            </canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== GR√ÅFICAS ADICIONALES (GRID) ========== -->
    <div class="graficas-grid" *ngIf="indicadoresSemanales.length > 0">
      <!-- Gr√°fica de Huevos -->
      <div class="grafica-card grafica-card--small">
        <div class="grafica-card-header">
          <h5>ü•ö Producci√≥n de Huevos</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small">
            <canvas baseChart
                    [type]="barChartType"
                    [data]="huevosChartData"
                    [options]="huevosChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats">
            <div class="stat-item">
              <span class="stat-label">Promedio Totales:</span>
              <span class="stat-value">{{ calcularPromedioIndicadores('huevosTotales') | number:'1.0-0' }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Promedio Incubables:</span>
              <span class="stat-value">{{ calcularPromedioIndicadores('huevosIncubables') | number:'1.0-0' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica de Mortalidad -->
      <div class="grafica-card grafica-card--small">
        <div class="grafica-card-header">
          <h5>üíÄ Mortalidad por Semana</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small">
            <canvas baseChart
                    [type]="barChartType"
                    [data]="mortalidadChartData"
                    [options]="mortalidadChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats">
            <div class="stat-item">
              <span class="stat-label">Promedio:</span>
              <span class="stat-value">{{ calcularPromedioIndicadores('mortalidadTotal') | number:'1.2-2' }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica de Consumo -->
      <div class="grafica-card grafica-card--small">
        <div class="grafica-card-header">
          <h5>üçΩÔ∏è Consumo de Alimento</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small">
            <canvas baseChart
                    [type]="barChartType"
                    [data]="consumoChartData"
                    [options]="consumoChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats">
            <div class="stat-item">
              <span class="stat-label">Promedio Real:</span>
              <span class="stat-value">{{ calcularPromedioIndicadores('consumoReal') | number:'1.0-0' }}kg</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Promedio Tabla:</span>
              <span class="stat-value">{{ calcularPromedioIndicadores('consumoTabla') | number:'1.0-0' }}kg</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica de Eficiencia -->
      <div class="grafica-card grafica-card--small">
        <div class="grafica-card-header">
          <h5>üìä Eficiencia de Producci√≥n</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small">
            <canvas baseChart
                    [type]="lineChartType"
                    [data]="eficienciaChartData"
                    [options]="eficienciaChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats">
            <div class="stat-item">
              <span class="stat-label">Promedio:</span>
              <span class="stat-value">{{ calcularPromedioIndicadores('porcentajeIncubables') | number:'1.2-2' }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica de Distribuci√≥n (Torta) -->
      <div class="grafica-card grafica-card--small" *ngIf="indicadoresSemanales.length > 0">
        <div class="grafica-card-header">
          <h5>ü•ß Distribuci√≥n √öltima Semana</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small chart-container--torta">
            <canvas baseChart
                    [type]="pieChartType"
                    [data]="tortaChartData"
                    [options]="tortaChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats" *ngIf="indicadoresSemanales.length > 0">
            <div class="stat-item">
              <span class="stat-label">Incubables:</span>
              <span class="stat-value">{{ indicadoresSemanales[indicadoresSemanales.length - 1].porcentajeIncubables | number:'1.2-2' }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica de Aves Vivas -->
      <div class="grafica-card grafica-card--small">
        <div class="grafica-card-header">
          <h5>üêî Aves Vivas por Semana</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small">
            <canvas baseChart
                    [type]="barChartType"
                    [data]="avesChartData"
                    [options]="avesChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats" *ngIf="indicadoresSemanales.length > 0">
            <div class="stat-item">
              <span class="stat-label">Aves Actuales:</span>
              <span class="stat-value">{{ indicadoresSemanales[indicadoresSemanales.length - 1].avesFinSemana | number:'1.0-0' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== RESUMEN DE M√âTRICAS ========== -->
    <div class="metricas-resumen" *ngIf="indicadoresSemanales.length > 0">
      <h4>üìä Resumen de M√©tricas Generales</h4>
      <div class="metricas-grid">
        <div class="metrica-card">
          <div class="metrica-icon">ü•ö</div>
          <div class="metrica-content">
            <h5>Huevos Totales</h5>
            <p>{{ calcularPromedioIndicadores('huevosTotales') | number:'1.0-0' }}/semana</p>
          </div>
        </div>

        <div class="metrica-card">
          <div class="metrica-icon">‚úÖ</div>
          <div class="metrica-content">
            <h5>Eficiencia</h5>
            <p>{{ calcularPromedioIndicadores('porcentajeIncubables') | number:'1.2-2' }}%</p>
          </div>
        </div>

        <div class="metrica-card">
          <div class="metrica-icon">üíÄ</div>
          <div class="metrica-content">
            <h5>Mort. Promedio</h5>
            <p>{{ calcularPromedioIndicadores('mortalidadTotal') | number:'1.2-2' }}%</p>
          </div>
        </div>

        <div class="metrica-card">
          <div class="metrica-icon">üêî</div>
          <div class="metrica-content">
            <h5>Aves Actuales</h5>
            <p>{{ indicadoresSemanales[indicadoresSemanales.length - 1].avesFinSemana | number:'1.0-0' }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
