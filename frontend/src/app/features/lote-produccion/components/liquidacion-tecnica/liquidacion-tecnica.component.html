<section class="liquidacion-container" [attr.aria-busy]="loading() ? 'true' : null">
  <!-- Header -->
  <header class="liquidacion-header">
    <div class="liquidacion-title">
      <h3>üìä Liquidaci√≥n T√©cnica de Producci√≥n</h3>
      <div class="liquidacion-meta" *ngIf="loteId">
        <span class="chip chip--info">
          <span class="chip__dot" aria-hidden="true"></span>
          {{ loteNombre || loteId }}
        </span>
        <span *ngIf="liquidacion()" class="chip chip--success">
          Semana Actual: {{ liquidacion()!.semanaActual }}
        </span>
      </div>
    </div>

    <div class="liquidacion-controls">
          <button
            type="button"
            class="btn btn--outline"
            (click)="actualizar()"
            [disabled]="loading() || !loteId">
        <span *ngIf="loading()">üîÑ Calculando...</span>
        <span *ngIf="!loading()">üîÑ Actualizar</span>
          </button>
    </div>
  </header>

  <!-- Loading -->
  <div *ngIf="loading()" class="loading-overlay" aria-live="polite" role="status">
    <div class="spinner"></div>
    <p>Calculando liquidaci√≥n t√©cnica de producci√≥n...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error() && !loading()" class="error-state">
    <div class="error-icon" aria-hidden="true">‚ö†Ô∏è</div>
    <p>{{ error() }}</p>
    <button type="button" class="btn btn--outline" (click)="actualizar()">
      Reintentar
    </button>
  </div>

  <!-- Sin lote seleccionado -->
  <div *ngIf="!loteId && !loading()" class="empty-state">
    <div class="empty-illustration" aria-hidden="true">üìä</div>
    <p>Selecciona un lote para ver su liquidaci√≥n t√©cnica de producci√≥n.</p>
  </div>

  <!-- Contenido principal -->
  <ng-container *ngIf="liquidacion() && !loading() && !error()">
    <!-- Informaci√≥n del lote -->
    <section class="ux-card liquidacion-info">
      <h4>üìã Informaci√≥n del Lote</h4>
      <div class="info-grid">
        <div class="info-item">
          <label>üìã Lote</label>
          <div><strong>{{ liquidacion()!.loteNombre }}</strong></div>
        </div>
        <div class="info-item">
          <label>üß¨ Raza</label>
          <div><strong>{{ liquidacion()!.raza || '‚Äî' }}</strong></div>
        </div>
        <div class="info-item">
          <label>üìÖ A√±o Gu√≠a</label>
          <div><strong>{{ liquidacion()!.anoTablaGenetica || '‚Äî' }}</strong></div>
        </div>
        <div class="info-item">
          <label>üìÖ Fecha Encaset</label>
          <div><strong>{{ liquidacion()!.fechaEncaset | date:'dd/MM/yyyy' }}</strong></div>
        </div>
        <div class="info-item">
          <label>üêî Hembras Iniciales</label>
          <div><strong>{{ liquidacion()!.hembrasIniciales | number:'1.0-0' }}</strong></div>
        </div>
        <div class="info-item">
          <label>üêì Machos Iniciales</label>
          <div><strong>{{ liquidacion()!.machosIniciales | number:'1.0-0' }}</strong></div>
        </div>
        <div class="info-item">
          <label>ü•ö Huevos Iniciales</label>
          <div><strong>{{ liquidacion()!.huevosIniciales | number:'1.0-0' }}</strong></div>
        </div>
        <div class="info-item">
          <label>üìä Semana Actual</label>
          <div><strong>{{ liquidacion()!.semanaActual }}</strong></div>
        </div>
        <div class="info-item">
          <label>üìù Total Registros</label>
          <div><strong>{{ liquidacion()!.totalRegistrosSeguimiento }}</strong></div>
        </div>
      </div>
    </section>

    <!-- Tabs de navegaci√≥n mejorados -->
    <div class="liquidacion-tabs">
      <button
        type="button"
        class="tab-btn"
        [class.active]="vistaActiva === 'resumen'"
        (click)="cambiarVista('resumen')">
        <span>üìä</span>
        <span>Resumen General</span>
      </button>
      <button
        type="button"
        class="tab-btn"
        [class.active]="vistaActiva === 'etapas'"
        (click)="cambiarVista('etapas')">
        <span>üìà</span>
        <span>Por Etapas</span>
      </button>
      <button
        type="button"
        class="tab-btn"
        [class.active]="vistaActiva === 'comparacion'"
        [disabled]="!liquidacion()?.comparacionGuia"
        (click)="cambiarVista('comparacion')">
        <span>‚öñÔ∏è</span>
        <span>Comparaci√≥n Gu√≠a</span>
      </button>
    </div>

    <!-- Vista Resumen -->
    <section *ngIf="vistaActiva === 'resumen'" class="ux-card liquidacion-resumen">
      <h4>üìä Resumen General (Desde Semana 26)</h4>

      <!-- Tabla de Resumen General -->
      <div class="comparacion-table-container">
        <table class="comparacion-table">
          <thead>
            <tr>
              <th>Indicador</th>
              <th>Hembras</th>
              <th>Machos</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>üêî Aves Iniciales</strong></td>
              <td>{{ liquidacion()!.hembrasIniciales | number:'1.0-0' }}</td>
              <td>{{ liquidacion()!.machosIniciales | number:'1.0-0' }}</td>
              <td><strong>{{ liquidacion()!.hembrasIniciales + liquidacion()!.machosIniciales | number:'1.0-0' }}</strong></td>
            </tr>
            <tr>
              <td><strong>üíÄ Mortalidad</strong></td>
              <td>
                {{ liquidacion()!.totales.totalMortalidadHembras | number:'1.0-0' }}
                <small>({{ liquidacion()!.totales.porcentajeMortalidadAcumuladaHembras | number:'1.2-2' }}%)</small>
              </td>
              <td>
                {{ liquidacion()!.totales.totalMortalidadMachos | number:'1.0-0' }}
                <small>({{ liquidacion()!.totales.porcentajeMortalidadAcumuladaMachos | number:'1.2-2' }}%)</small>
              </td>
              <td><strong>{{ liquidacion()!.totales.totalMortalidadHembras + liquidacion()!.totales.totalMortalidadMachos | number:'1.0-0' }}</strong></td>
            </tr>
            <tr>
              <td><strong>üëã Selecci√≥n (Retiradas)</strong></td>
              <td>
                {{ liquidacion()!.totales.totalSeleccionHembras | number:'1.0-0' }}
                <small>({{ liquidacion()!.totales.porcentajeSeleccionAcumuladaHembras | number:'1.2-2' }}%)</small>
              </td>
              <td>‚Äî</td>
              <td><strong>{{ liquidacion()!.totales.totalSeleccionHembras | number:'1.0-0' }}</strong></td>
            </tr>
            <tr>
              <td><strong>üåæ Consumo Alimento (kg)</strong></td>
              <td>{{ liquidacion()!.totales.consumoTotalKgHembras | number:'1.2-2' }}</td>
              <td>{{ liquidacion()!.totales.consumoTotalKgMachos | number:'1.2-2' }}</td>
              <td><strong>{{ liquidacion()!.totales.consumoTotalKg | number:'1.2-2' }}</strong></td>
            </tr>
            <tr>
              <td><strong>ü•ö Producci√≥n Huevos</strong></td>
              <td colspan="3">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 0.5rem;">
                  <div>
                    <small>Totales:</small><br>
                    <strong>{{ liquidacion()!.totales.totalHuevosTotales | number:'1.0-0' }}</strong>
                  </div>
                  <div>
                    <small>Incubables:</small><br>
                    <strong>{{ liquidacion()!.totales.totalHuevosIncubables | number:'1.0-0' }}</strong>
                  </div>
                  <div>
                    <small>Promedio/D√≠a:</small><br>
                    <strong>{{ liquidacion()!.totales.promedioHuevosPorDia | number:'1.0-0' }}</strong>
                  </div>
                  <div>
                    <small>Eficiencia:</small><br>
                    <strong [class]="liquidacion()!.totales.eficienciaProduccionTotal >= 80 ? 'text-success' : 'text-warning'">
                      {{ liquidacion()!.totales.eficienciaProduccionTotal | number:'1.2-2' }}%
                    </strong>
                  </div>
                </div>
              </td>
            </tr>
            <tr>
              <td><strong>üêî Aves Actuales</strong></td>
              <td>{{ liquidacion()!.totales.avesHembrasActuales | number:'1.0-0' }}</td>
              <td>{{ liquidacion()!.totales.avesMachosActuales | number:'1.0-0' }}</td>
              <td><strong>{{ liquidacion()!.totales.totalAvesActuales | number:'1.0-0' }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- M√©tricas Acumuladas en Tarjetas -->
      <div class="metricas-grid">
        <div class="metrica-card">
          <div class="metrica-header">
            <span class="metrica-icon">üíÄ</span>
            <span class="metrica-titulo">Mortalidad</span>
          </div>
          <div class="metrica-valor">
            <div class="metrica-item">
              <span class="metrica-label">Hembras:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.porcentajeMortalidadAcumuladaHembras | number:'1.2-2' }}%</span>
              <span class="metrica-cant">({{ liquidacion()!.totales.totalMortalidadHembras | number:'1.0-0' }} aves)</span>
            </div>
            <div class="metrica-item">
              <span class="metrica-label">Machos:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.porcentajeMortalidadAcumuladaMachos | number:'1.2-2' }}%</span>
              <span class="metrica-cant">({{ liquidacion()!.totales.totalMortalidadMachos | number:'1.0-0' }} aves)</span>
            </div>
          </div>
        </div>

        <div class="metrica-card">
          <div class="metrica-header">
            <span class="metrica-icon">üëã</span>
            <span class="metrica-titulo">Selecci√≥n (Retiradas)</span>
          </div>
          <div class="metrica-valor">
            <div class="metrica-item">
              <span class="metrica-label">Hembras:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.porcentajeSeleccionAcumuladaHembras | number:'1.2-2' }}%</span>
              <span class="metrica-cant">({{ liquidacion()!.totales.totalSeleccionHembras | number:'1.0-0' }} aves)</span>
            </div>
          </div>
        </div>

        <div class="metrica-card">
          <div class="metrica-header">
            <span class="metrica-icon">üåæ</span>
            <span class="metrica-titulo">Consumo Alimento</span>
          </div>
          <div class="metrica-valor">
            <div class="metrica-item">
              <span class="metrica-label">Total:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.consumoTotalKg | number:'1.2-2' }} kg</span>
            </div>
            <div class="metrica-item">
              <span class="metrica-label">Promedio Diario:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.consumoPromedioDiarioKg | number:'1.2-2' }} kg/d√≠a</span>
            </div>
          </div>
      </div>

        <div class="metrica-card">
          <div class="metrica-header">
            <span class="metrica-icon">ü•ö</span>
            <span class="metrica-titulo">Producci√≥n Huevos</span>
          </div>
          <div class="metrica-valor">
            <div class="metrica-item">
              <span class="metrica-label">Totales:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.totalHuevosTotales | number:'1.0-0' }}</span>
            </div>
            <div class="metrica-item">
              <span class="metrica-label">Incubables:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.totalHuevosIncubables | number:'1.0-0' }}</span>
            </div>
            <div class="metrica-item">
              <span class="metrica-label">Promedio/D√≠a:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.promedioHuevosPorDia | number:'1.0-0' }}</span>
            </div>
            <div class="metrica-item">
              <span class="metrica-label">Eficiencia:</span>
              <span class="metrica-num" [class]="liquidacion()!.totales.eficienciaProduccionTotal >= 80 ? 'text-success' : 'text-warning'">
                {{ liquidacion()!.totales.eficienciaProduccionTotal | number:'1.2-2' }}%
              </span>
            </div>
            </div>
          </div>

        <div class="metrica-card">
          <div class="metrica-header">
            <span class="metrica-icon">üêî</span>
            <span class="metrica-titulo">Aves Actuales</span>
          </div>
          <div class="metrica-valor">
            <div class="metrica-item">
              <span class="metrica-label">Hembras:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.avesHembrasActuales | number:'1.0-0' }}</span>
            </div>
            <div class="metrica-item">
              <span class="metrica-label">Machos:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.avesMachosActuales | number:'1.0-0' }}</span>
            </div>
            <div class="metrica-item">
              <span class="metrica-label">Total:</span>
              <span class="metrica-num">{{ liquidacion()!.totales.totalAvesActuales | number:'1.0-0' }}</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Vista Etapas -->
    <section *ngIf="vistaActiva === 'etapas'" class="ux-card liquidacion-etapas">
      <h4>üìà An√°lisis por Etapas</h4>

      <!-- Selector de etapas -->
      <div class="etapas-selector">
        <button
          type="button"
          class="etapa-btn"
          [class.active]="etapaSeleccionada === 1"
          (click)="seleccionarEtapa(1)">
          <span class="etapa-num">1</span>
          <span class="etapa-info">Semana 25-33</span>
        </button>
        <button
          type="button"
          class="etapa-btn"
          [class.active]="etapaSeleccionada === 2"
          (click)="seleccionarEtapa(2)">
          <span class="etapa-num">2</span>
          <span class="etapa-info">Semana 34-50</span>
        </button>
        <button
          type="button"
          class="etapa-btn"
          [class.active]="etapaSeleccionada === 3"
          (click)="seleccionarEtapa(3)">
          <span class="etapa-num">3</span>
          <span class="etapa-info">Semana >50</span>
        </button>
          </div>

      <!-- Vista general de todas las etapas -->
      <div *ngIf="!etapaSeleccionada" class="etapas-overview">
        <!-- Gr√°fico de comparaci√≥n de etapas -->
        <div class="chart-container" *ngIf="liquidacion()">
            <canvas
              baseChart
              [type]="'bar'"
            [data]="getEtapasChartData()"
            [options]="barChartOptions">
            </canvas>
        </div>

        <!-- Resumen de cada etapa -->
        <div class="etapas-grid">
          <div *ngFor="let etapaNum of [1, 2, 3]" class="etapa-summary-card" (click)="seleccionarEtapa(etapaNum)">
            <div class="etapa-summary-header">
              <h5>{{ getEtapa(etapaNum)?.nombre }}</h5>
              <span class="etapa-badge">Registros: {{ getEtapa(etapaNum)?.totalRegistros || 0 }}</span>
            </div>
            <div class="etapa-summary-body" *ngIf="getEtapa(etapaNum) as etapa">
              <div class="summary-item">
                <span>ü•ö Huevos Totales:</span>
                <strong>{{ etapa.huevosTotales | number:'1.0-0' }}</strong>
              </div>
              <div class="summary-item">
                <span>üíÄ Mortalidad H:</span>
                <strong>{{ etapa.mortalidadHembras }} ({{ etapa.porcentajeMortalidadHembras | number:'1.2-2' }}%)</strong>
              </div>
              <div class="summary-item">
                <span>üåæ Consumo Total:</span>
                <strong>{{ etapa.consumoTotalKg | number:'1.2-2' }} kg</strong>
              </div>
              <div class="summary-item">
                <span>‚úÖ Eficiencia:</span>
                <strong>{{ etapa.eficienciaProduccion | number:'1.2-2' }}%</strong>
              </div>
            </div>
            <div *ngIf="!getEtapa(etapaNum)" class="etapa-empty">
              Sin datos registrados
          </div>
          </div>
        </div>
          </div>

      <!-- Detalle de etapa seleccionada en formato tabla -->
      <div *ngIf="etapaSeleccionada && getEtapa(etapaSeleccionada)" class="etapa-detalle">
        <div class="etapa-detalle-header">
          <h5>{{ getEtapa(etapaSeleccionada)!.nombre }}</h5>
          <button type="button" class="btn btn--ghost btn--sm" (click)="etapaSeleccionada = null">
            ‚Üê Volver
          </button>
        </div>

        <div class="etapa-detalle-body" *ngIf="getEtapa(etapaSeleccionada) as etapa">
          <!-- Tabla de M√©tricas Principales -->
          <div class="comparacion-table-container">
            <table class="comparacion-table">
              <thead>
                <tr>
                  <th>M√©trica</th>
                  <th>Hembras</th>
                  <th>Machos</th>
                  <th>Total / Promedio</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>üìä Registros</strong></td>
                  <td colspan="3" style="text-align: center;"><strong>{{ etapa.totalRegistros }}</strong></td>
                </tr>
                <tr>
                  <td><strong>üíÄ Mortalidad</strong></td>
                  <td>
                    {{ etapa.mortalidadHembras }}
                    <small>({{ etapa.porcentajeMortalidadHembras | number:'1.2-2' }}%)</small>
                  </td>
                  <td>
                    {{ etapa.mortalidadMachos }}
                    <small>({{ etapa.porcentajeMortalidadMachos | number:'1.2-2' }}%)</small>
                  </td>
                  <td><strong>{{ etapa.mortalidadHembras + etapa.mortalidadMachos }}</strong></td>
                </tr>
                <tr>
                  <td><strong>üëã Selecci√≥n (Retiradas)</strong></td>
                  <td>
                    {{ etapa.seleccionHembras }}
                    <small>({{ etapa.porcentajeSeleccionHembras | number:'1.2-2' }}%)</small>
                  </td>
                  <td>‚Äî</td>
                  <td><strong>{{ etapa.seleccionHembras }}</strong></td>
                </tr>
                <tr>
                  <td><strong>üåæ Consumo Alimento (kg)</strong></td>
                  <td>{{ etapa.consumoKgHembras | number:'1.2-2' }}</td>
                  <td>{{ etapa.consumoKgMachos | number:'1.2-2' }}</td>
                  <td><strong>{{ etapa.consumoTotalKg | number:'1.2-2' }}</strong></td>
                </tr>
                <tr>
                  <td><strong>ü•ö Producci√≥n Huevos</strong></td>
                  <td colspan="3">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 0.5rem;">
                      <div>
                        <small>Totales:</small><br>
                        <strong>{{ etapa.huevosTotales | number:'1.0-0' }}</strong>
                      </div>
                      <div>
                        <small>Incubables:</small><br>
                        <strong>{{ etapa.huevosIncubables | number:'1.0-0' }}</strong>
                      </div>
                      <div>
                        <small>Promedio/D√≠a:</small><br>
                        <strong>{{ etapa.promedioHuevosPorDia | number:'1.0-0' }}</strong>
                      </div>
                      <div>
                        <small>Eficiencia:</small><br>
                        <strong [class]="etapa.eficienciaProduccion >= 80 ? 'text-success' : 'text-warning'">
                          {{ etapa.eficienciaProduccion | number:'1.2-2' }}%
                        </strong>
                      </div>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="etapa.pesoPromedioHembras || etapa.pesoPromedioMachos">
                  <td><strong>‚öñÔ∏è Pesaje Semanal (Promedio)</strong></td>
                  <td>
                    <span *ngIf="etapa.pesoPromedioHembras">{{ etapa.pesoPromedioHembras | number:'1.2-2' }} kg</span>
                    <span *ngIf="!etapa.pesoPromedioHembras">‚Äî</span>
                  </td>
                  <td>
                    <span *ngIf="etapa.pesoPromedioMachos">{{ etapa.pesoPromedioMachos | number:'1.2-2' }} kg</span>
                    <span *ngIf="!etapa.pesoPromedioMachos">‚Äî</span>
                  </td>
                  <td>
                    <span *ngIf="etapa.uniformidadPromedio">Uniformidad: {{ etapa.uniformidadPromedio | number:'1.2-2' }}%</span>
                    <span *ngIf="!etapa.uniformidadPromedio">‚Äî</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Tabla de Clasificadora de Huevos -->
          <div class="comparacion-table-container" style="margin-top: var(--space-6);">
            <table class="comparacion-table">
              <thead>
                <tr>
                  <th colspan="4">üîç Clasificadora de Huevos</th>
                </tr>
                <tr>
                  <th>Categor√≠a</th>
                  <th>Cantidad</th>
                  <th>Categor√≠a</th>
                  <th>Cantidad</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Limpio</strong></td>
                  <td>{{ etapa.huevosLimpios | number:'1.0-0' }}</td>
                  <td><strong>Sucio</strong></td>
                  <td>{{ etapa.huevosSucios | number:'1.0-0' }}</td>
                </tr>
                <tr>
                  <td><strong>Tratado</strong></td>
                  <td>{{ etapa.huevosTratados | number:'1.0-0' }}</td>
                  <td><strong>Deforme</strong></td>
                  <td>{{ etapa.huevosDeformes | number:'1.0-0' }}</td>
                </tr>
                <tr>
                  <td><strong>Blanco</strong></td>
                  <td>{{ etapa.huevosBlancos | number:'1.0-0' }}</td>
                  <td><strong>Doble Yema</strong></td>
                  <td>{{ etapa.huevosDobleYema | number:'1.0-0' }}</td>
                </tr>
                <tr>
                  <td><strong>Piso</strong></td>
                  <td>{{ etapa.huevosPiso | number:'1.0-0' }}</td>
                  <td><strong>Peque√±o</strong></td>
                  <td>{{ etapa.huevosPequenos | number:'1.0-0' }}</td>
                </tr>
                <tr>
                  <td><strong>Roto</strong></td>
                  <td>{{ etapa.huevosRotos | number:'1.0-0' }}</td>
                  <td><strong>Desecho</strong></td>
                  <td>{{ etapa.huevosDesecho | number:'1.0-0' }}</td>
                </tr>
                <tr>
                  <td><strong>Otro</strong></td>
                  <td>{{ etapa.huevosOtro | number:'1.0-0' }}</td>
                  <td><strong>Total Incubables (Limpio + Tratado)</strong></td>
                  <td><strong>{{ etapa.huevosLimpios + etapa.huevosTratados | number:'1.0-0' }}</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Vista Comparaci√≥n -->
    <section *ngIf="vistaActiva === 'comparacion' && liquidacion()?.comparacionGuia" class="ux-card liquidacion-comparacion">
      <h4>‚öñÔ∏è Comparaci√≥n con Gu√≠a Gen√©tica</h4>

      <div class="comparacion-container" *ngIf="liquidacion()!.comparacionGuia as comp" style="padding: var(--space-6);">
        <!-- Gr√°fico de comparaci√≥n -->
        <div class="chart-container" *ngIf="getComparacionChartData()" style="margin-bottom: var(--space-6);">
          <canvas
            baseChart
            [type]="'bar'"
            [data]="getComparacionChartData()!"
            [options]="barChartOptions">
          </canvas>
        </div>

        <!-- Tabla Principal de Comparaci√≥n -->
        <div class="comparacion-table-container">
          <table class="comparacion-table">
            <thead>
              <tr>
                <th>Par√°metro</th>
                <th>Real</th>
                <th>Gu√≠a Gen√©tica</th>
                <th>Diferencia</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              <!-- Consumo -->
              <tr *ngIf="comp.consumoGuiaHembras">
                <td><strong>Consumo Hembras (g/ave/d√≠a)</strong></td>
                <td>{{ liquidacion()!.totales.consumoPromedioDiarioKg * 1000 / liquidacion()!.totales.avesHembrasActuales | number:'1.0-0' }}</td>
                <td>{{ comp.consumoGuiaHembras | number:'1.0-0' }}</td>
                <td [class]="getDiferenciaClass(comp.diferenciaConsumoHembras)">
                  {{ formatearPorcentaje(comp.diferenciaConsumoHembras) }}
                </td>
                <td>
                  <span [class]="getEstadoCumplimiento(comp.diferenciaConsumoHembras).clase">
                    {{ getEstadoCumplimiento(comp.diferenciaConsumoHembras).texto }}
                  </span>
                </td>
              </tr>
              <tr *ngIf="comp.consumoGuiaMachos">
                <td><strong>Consumo Machos (g/ave/d√≠a)</strong></td>
                <td>{{ liquidacion()!.totales.consumoPromedioDiarioKg * 1000 / liquidacion()!.totales.avesMachosActuales | number:'1.0-0' }}</td>
                <td>{{ comp.consumoGuiaMachos | number:'1.0-0' }}</td>
                <td [class]="getDiferenciaClass(comp.diferenciaConsumoMachos)">
                  {{ formatearPorcentaje(comp.diferenciaConsumoMachos) }}
                </td>
                <td>
                  <span [class]="getEstadoCumplimiento(comp.diferenciaConsumoMachos).clase">
                    {{ getEstadoCumplimiento(comp.diferenciaConsumoMachos).texto }}
                  </span>
                </td>
              </tr>

              <!-- Peso -->
              <tr *ngIf="comp.pesoGuiaHembras">
                <td><strong>Peso Hembras (kg)</strong></td>
                <td>{{ liquidacion()!.etapa1.pesoHembras || liquidacion()!.etapa2.pesoHembras || liquidacion()!.etapa3.pesoHembras | number:'1.2-2' }}</td>
                <td>{{ comp.pesoGuiaHembras | number:'1.2-2' }}</td>
                <td [class]="getDiferenciaClass(comp.diferenciaPesoHembras)">
                  {{ formatearPorcentaje(comp.diferenciaPesoHembras) }}
                </td>
                <td>
                  <span [class]="getEstadoCumplimiento(comp.diferenciaPesoHembras).clase">
                    {{ getEstadoCumplimiento(comp.diferenciaPesoHembras).texto }}
                  </span>
                </td>
              </tr>
              <tr *ngIf="comp.pesoGuiaMachos">
                <td><strong>Peso Machos (kg)</strong></td>
                <td>{{ liquidacion()!.etapa1.pesoMachos || liquidacion()!.etapa2.pesoMachos || liquidacion()!.etapa3.pesoMachos | number:'1.2-2' }}</td>
                <td>{{ comp.pesoGuiaMachos | number:'1.2-2' }}</td>
                <td [class]="getDiferenciaClass(comp.diferenciaPesoMachos)">
                  {{ formatearPorcentaje(comp.diferenciaPesoMachos) }}
                </td>
                <td>
                  <span [class]="getEstadoCumplimiento(comp.diferenciaPesoMachos).clase">
                    {{ getEstadoCumplimiento(comp.diferenciaPesoMachos).texto }}
                  </span>
                </td>
              </tr>

              <!-- Mortalidad -->
              <tr *ngIf="comp.mortalidadGuiaHembras">
                <td><strong>% Mortalidad Hembras</strong></td>
                <td>{{ liquidacion()!.totales.porcentajeMortalidadAcumuladaHembras | number:'1.2-2' }}%</td>
                <td>{{ comp.mortalidadGuiaHembras | number:'1.2-2' }}%</td>
                <td [class]="getDiferenciaClass(comp.diferenciaMortalidadHembras)">
                  {{ formatearPorcentaje(comp.diferenciaMortalidadHembras) }}
                </td>
                <td>
                  <span [class]="getEstadoCumplimiento(comp.diferenciaMortalidadHembras).clase">
                    {{ getEstadoCumplimiento(comp.diferenciaMortalidadHembras).texto }}
                  </span>
                </td>
              </tr>
              <tr *ngIf="comp.mortalidadGuiaMachos">
                <td><strong>% Mortalidad Machos</strong></td>
                <td>{{ liquidacion()!.totales.porcentajeMortalidadAcumuladaMachos | number:'1.2-2' }}%</td>
                <td>{{ comp.mortalidadGuiaMachos | number:'1.2-2' }}%</td>
                <td [class]="getDiferenciaClass(comp.diferenciaMortalidadMachos)">
                  {{ formatearPorcentaje(comp.diferenciaMortalidadMachos) }}
                </td>
                <td>
                  <span [class]="getEstadoCumplimiento(comp.diferenciaMortalidadMachos).clase">
                    {{ getEstadoCumplimiento(comp.diferenciaMortalidadMachos).texto }}
                  </span>
                </td>
              </tr>

              <!-- Uniformidad -->
              <tr *ngIf="comp.uniformidadGuia">
                <td><strong>Uniformidad (%)</strong></td>
                <td>{{ comp.uniformidadReal | number:'1.2-2' }}%</td>
                <td>{{ comp.uniformidadGuia | number:'1.2-2' }}%</td>
                <td [class]="getDiferenciaClass(comp.diferenciaUniformidad)">
                  {{ formatearPorcentaje(comp.diferenciaUniformidad) }}
                </td>
                <td>
                  <span [class]="getEstadoCumplimiento(comp.diferenciaUniformidad).clase">
                    {{ getEstadoCumplimiento(comp.diferenciaUniformidad).texto }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Secci√≥n de Comparaci√≥n de Producci√≥n de Huevos -->
        <div class="comparacion-huevos-section">
          <h5>ü•ö Comparaci√≥n de Producci√≥n de Huevos</h5>

          <div class="comparacion-table-container">
            <table class="comparacion-table">
            <thead>
              <tr>
                  <th>Par√°metro</th>
                  <th>Real</th>
                  <th>Gu√≠a Gen√©tica</th>
                  <th>Diferencia</th>
                  <th>Estado</th>
              </tr>
            </thead>
            <tbody>
                <!-- Huevos Totales -->
                <tr *ngIf="comp.huevosTotalesGuia !== null && comp.huevosTotalesGuia !== undefined">
                  <td><strong>Huevos Totales (promedio/d√≠a)</strong></td>
                  <td>{{ comp.huevosTotalesReal | number:'1.0-0' }}</td>
                  <td>{{ comp.huevosTotalesGuia | number:'1.0-0' }}</td>
                  <td [class]="getDiferenciaClass(comp.diferenciaHuevosTotales)">
                    {{ formatearPorcentaje(comp.diferenciaHuevosTotales) }}
                  </td>
                  <td>
                    <span [class]="getEstadoCumplimiento(comp.diferenciaHuevosTotales).clase">
                      {{ getEstadoCumplimiento(comp.diferenciaHuevosTotales).texto }}
                    </span>
                  </td>
                </tr>

                <!-- Porcentaje de Producci√≥n -->
                <tr *ngIf="comp.porcentajeProduccionGuia !== null && comp.porcentajeProduccionGuia !== undefined">
                  <td><strong>% Producci√≥n</strong></td>
                  <td>{{ comp.porcentajeProduccionReal | number:'1.2-2' }}%</td>
                  <td>{{ comp.porcentajeProduccionGuia | number:'1.2-2' }}%</td>
                  <td [class]="getDiferenciaClass(comp.diferenciaPorcentajeProduccion)">
                    {{ formatearPorcentaje(comp.diferenciaPorcentajeProduccion) }}
                  </td>
                  <td>
                    <span [class]="getEstadoCumplimiento(comp.diferenciaPorcentajeProduccion).clase">
                      {{ getEstadoCumplimiento(comp.diferenciaPorcentajeProduccion).texto }}
                    </span>
                  </td>
                </tr>

                <!-- Huevos Incubables -->
                <tr *ngIf="comp.huevosIncubablesGuia !== null && comp.huevosIncubablesGuia !== undefined">
                  <td><strong>Huevos Incubables (promedio/d√≠a)</strong></td>
                  <td>{{ comp.huevosIncubablesReal | number:'1.0-0' }}</td>
                  <td>{{ comp.huevosIncubablesGuia | number:'1.0-0' }}</td>
                  <td [class]="getDiferenciaClass(comp.diferenciaHuevosIncubables)">
                    {{ formatearPorcentaje(comp.diferenciaHuevosIncubables) }}
                  </td>
                  <td>
                    <span [class]="getEstadoCumplimiento(comp.diferenciaHuevosIncubables).clase">
                      {{ getEstadoCumplimiento(comp.diferenciaHuevosIncubables).texto }}
                    </span>
                  </td>
                </tr>

                <!-- Peso Huevo -->
                <tr *ngIf="comp.pesoHuevoGuia !== null && comp.pesoHuevoGuia !== undefined">
                  <td><strong>Peso Huevo (g)</strong></td>
                  <td>{{ comp.pesoHuevoReal | number:'1.2-2' }}</td>
                  <td>{{ comp.pesoHuevoGuia | number:'1.2-2' }}</td>
                  <td [class]="getDiferenciaClass(comp.diferenciaPesoHuevo)">
                    {{ formatearPorcentaje(comp.diferenciaPesoHuevo) }}
                  </td>
                  <td>
                    <span [class]="getEstadoCumplimiento(comp.diferenciaPesoHuevo).clase">
                      {{ getEstadoCumplimiento(comp.diferenciaPesoHuevo).texto }}
                    </span>
                  </td>
                </tr>

                <!-- Masa Huevo -->
                <tr *ngIf="comp.masaHuevoGuia !== null && comp.masaHuevoGuia !== undefined">
                  <td><strong>Masa Huevo (g)</strong></td>
                  <td>{{ (comp.pesoHuevoReal && comp.huevosTotalesReal ? comp.pesoHuevoReal * comp.huevosTotalesReal : null) | number:'1.2-2' }}</td>
                  <td>{{ comp.masaHuevoGuia | number:'1.2-2' }}</td>
                  <td [class]="getDiferenciaClass(comp.diferenciaMasaHuevo)">
                    {{ formatearPorcentaje(comp.diferenciaMasaHuevo) }}
                  </td>
                  <td>
                    <span [class]="getEstadoCumplimiento(comp.diferenciaMasaHuevo).clase">
                      {{ getEstadoCumplimiento(comp.diferenciaMasaHuevo).texto }}
                    </span>
                  </td>
                </tr>

                <!-- Gramos/Huevo Total -->
                <tr *ngIf="comp.gramosHuevoTotalGuia !== null && comp.gramosHuevoTotalGuia !== undefined">
                  <td><strong>Gramos/Huevo Total</strong></td>
                  <td>{{ comp.pesoHuevoReal | number:'1.2-2' }}</td>
                  <td>{{ comp.gramosHuevoTotalGuia | number:'1.2-2' }}</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                </tr>

                <!-- Gramos/Huevo Incubable -->
                <tr *ngIf="comp.gramosHuevoIncubableGuia !== null && comp.gramosHuevoIncubableGuia !== undefined">
                  <td><strong>Gramos/Huevo Incubable</strong></td>
                  <td>‚Äî</td>
                  <td>{{ comp.gramosHuevoIncubableGuia | number:'1.2-2' }}</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                </tr>

                <!-- Aprovechamiento Semanal -->
                <tr *ngIf="comp.aprovechamientoSemanalGuia !== null && comp.aprovechamientoSemanalGuia !== undefined">
                  <td><strong>% Aprovechamiento Semanal</strong></td>
                  <td>‚Äî</td>
                  <td>{{ comp.aprovechamientoSemanalGuia | number:'1.2-2' }}%</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                </tr>

                <!-- Aprovechamiento Acumulado -->
                <tr *ngIf="comp.aprovechamientoAcumuladoGuia !== null && comp.aprovechamientoAcumuladoGuia !== undefined">
                  <td><strong>% Aprovechamiento Acumulado</strong></td>
                  <td>‚Äî</td>
                  <td>{{ comp.aprovechamientoAcumuladoGuia | number:'1.2-2' }}%</td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                </tr>

                <!-- Eficiencia Real -->
                <tr *ngIf="comp.eficienciaReal !== null && comp.eficienciaReal !== undefined">
                  <td><strong>Eficiencia Real (%)</strong></td>
                  <td><strong>{{ comp.eficienciaReal | number:'1.2-2' }}%</strong></td>
                  <td>‚Äî</td>
                  <td>‚Äî</td>
                  <td>
                    <span [class]="comp.eficienciaReal >= 80 ? 'estado-ok' : comp.eficienciaReal >= 70 ? 'estado-warning' : 'estado-danger'">
                      {{ comp.eficienciaReal >= 80 ? '√ìptimo' : comp.eficienciaReal >= 70 ? 'Aceptable' : 'Requiere atenci√≥n' }}
                    </span>
                  </td>
              </tr>
            </tbody>
          </table>
          </div>

          <!-- Datos adicionales de la gu√≠a gen√©tica -->
          <div class="guia-datos-adicionales" *ngIf="comp.nacimientoPorcentajeGuia || comp.pollitosAveAlojadaGuia || comp.gramosPollitoGuia || comp.apareoGuia || comp.kcalAveDiaHGuia">
            <h6>üìä Datos Adicionales de la Gu√≠a Gen√©tica</h6>
            <div class="datos-adicionales-grid">
              <div class="dato-item" *ngIf="comp.nacimientoPorcentajeGuia">
                <label>% Nacimiento:</label>
                <span>{{ comp.nacimientoPorcentajeGuia | number:'1.2-2' }}%</span>
              </div>
              <div class="dato-item" *ngIf="comp.pollitosAveAlojadaGuia">
                <label>Pollitos/Ave Alojada:</label>
                <span>{{ comp.pollitosAveAlojadaGuia | number:'1.2-2' }}</span>
              </div>
              <div class="dato-item" *ngIf="comp.gramosPollitoGuia">
                <label>Gramos/Pollito:</label>
                <span>{{ comp.gramosPollitoGuia | number:'1.2-2' }}g</span>
              </div>
              <div class="dato-item" *ngIf="comp.apareoGuia">
                <label>% Apareo:</label>
                <span>{{ comp.apareoGuia | number:'1.2-2' }}%</span>
              </div>
              <div class="dato-item" *ngIf="comp.kcalAveDiaHGuia">
                <label>Kcal/Ave/D√≠a (Hembras):</label>
                <span>{{ comp.kcalAveDiaHGuia | number:'1.0-0' }} kcal</span>
              </div>
              <div class="dato-item" *ngIf="comp.kcalAveDiaMGuia">
                <label>Kcal/Ave/D√≠a (Machos):</label>
                <span>{{ comp.kcalAveDiaMGuia | number:'1.0-0' }} kcal</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje si no hay comparaci√≥n -->
      <div *ngIf="!liquidacion()?.comparacionGuia" class="missing-data-alert">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-content">
          <h5>Datos de Gu√≠a Gen√©tica No Disponibles</h5>
          <p>No se encontraron datos de gu√≠a gen√©tica para comparar. Verifica que el lote tenga asignados:</p>
          <ul>
            <li><strong>Raza:</strong> {{ liquidacion()!.raza || 'No asignada' }}</li>
            <li><strong>A√±o de Tabla Gen√©tica:</strong> {{ liquidacion()!.anoTablaGenetica || 'No asignado' }}</li>
          </ul>
        </div>
      </div>
    </section>
  </ng-container>
</section>
