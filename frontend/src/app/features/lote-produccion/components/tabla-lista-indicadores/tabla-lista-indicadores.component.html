<div class="indicadores-container">
  <div class="indicadores-header">
    <h3>ğŸ“ˆ Indicadores Semanales de ProducciÃ³n</h3>
    <p class="indicadores-subtitle">
      Resumen de mÃ©tricas clave por semana de producciÃ³n
      <span *ngIf="tieneDatosGuiaGenetica" class="badge-guia">âœ“ ComparaciÃ³n con GuÃ­a GenÃ©tica disponible</span>
    </p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loadingIndicadores" class="loading-state">
    <div class="spinner"></div>
    <p>Calculando indicadores semanales...</p>
      </div>

  <!-- Error State -->
  <div *ngIf="error && !loadingIndicadores" class="error-state">
    <div class="error-icon">âš ï¸</div>
    <p>{{ error }}</p>
    <button type="button" class="btn btn--outline" (click)="cargarIndicadores()">
      Reintentar
    </button>
        </div>

  <!-- Tabla de Indicadores -->
  <div *ngIf="!loadingIndicadores && !error && indicadoresSemanales.length > 0" class="indicadores-table-container">
    <table class="indicadores-table">
      <thead>
        <tr>
          <th rowspan="2">Semana</th>
          <th rowspan="2">PerÃ­odo</th>
          <th rowspan="2">Etapa</th>
          <th rowspan="2">Registros</th>
          <th colspan="3">ğŸ’€ Mortalidad</th>
          <th colspan="3">ğŸŒ¾ Consumo (g/ave/dÃ­a)</th>
          <th colspan="4">ğŸ¥š ProducciÃ³n Huevos</th>
          <th colspan="3">âš–ï¸ Peso Aves (kg)</th>
          <th colspan="2">ğŸ“Š Uniformidad</th>
        </tr>
        <tr>
          <!-- Mortalidad -->
          <th>H</th>
          <th>M</th>
          <th>Dif. GuÃ­a</th>
          <!-- Consumo -->
          <th>H</th>
          <th>M</th>
          <th>Dif. GuÃ­a</th>
          <!-- ProducciÃ³n -->
          <th>Totales</th>
          <th>Incubables</th>
          <th>Prom/DÃ­a</th>
          <th>Dif. GuÃ­a</th>
          <!-- Peso -->
          <th>H</th>
          <th>M</th>
          <th>Dif. GuÃ­a</th>
          <!-- Uniformidad -->
          <th>Real</th>
          <th>Dif. GuÃ­a</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ind of indicadoresSemanales" class="indicador-row">
          <td><strong>{{ ind.semana }}</strong></td>
          <td class="periodo-cell">
            <span *ngIf="ind.fechaInicioSemana && ind.fechaFinSemana">
              {{ formatearFecha(ind.fechaInicioSemana) }} - {{ formatearFecha(ind.fechaFinSemana) }}
            </span>
            <span *ngIf="!ind.fechaInicioSemana || !ind.fechaFinSemana">â€”</span>
          </td>
          <td><span class="etapa-badge" [class]="'etapa-' + calcularEtapa(ind.semana).toLowerCase().replace(' ', '-')">
            {{ calcularEtapa(ind.semana) }}
          </span></td>
          <td>{{ ind.totalRegistros }}</td>

          <!-- Mortalidad -->
          <td>{{ ind.mortalidadHembras }}</td>
          <td>{{ ind.mortalidadMachos }}</td>
          <td [class]="getDiferenciaClass(ind.diferenciaMortalidadHembras)" *ngIf="ind.diferenciaMortalidadHembras !== null && ind.diferenciaMortalidadHembras !== undefined">
            {{ formatearPorcentaje(ind.diferenciaMortalidadHembras) }}
          </td>
          <td *ngIf="ind.diferenciaMortalidadHembras === null || ind.diferenciaMortalidadHembras === undefined">â€”</td>

          <!-- Consumo (g/ave/dÃ­a) - El backend ya calculÃ³ estos valores -->
          <td>
            <span *ngIf="ind.consumoGuiaHembras !== null && ind.consumoGuiaHembras !== undefined">
              {{ (ind.consumoKgHembras * 1000) / (ind.totalRegistros * (ind.avesHembrasInicioSemana || 1)) | number:'1.0-0' }}
            </span>
            <span *ngIf="ind.consumoGuiaHembras === null || ind.consumoGuiaHembras === undefined">â€”</span>
          </td>
          <td>
            <span *ngIf="ind.consumoGuiaMachos !== null && ind.consumoGuiaMachos !== undefined">
              {{ (ind.consumoKgMachos * 1000) / (ind.totalRegistros * (ind.avesMachosInicioSemana || 1)) | number:'1.0-0' }}
            </span>
            <span *ngIf="ind.consumoGuiaMachos === null || ind.consumoGuiaMachos === undefined">â€”</span>
          </td>
          <td [class]="getDiferenciaClass(ind.diferenciaConsumoHembras)" *ngIf="ind.diferenciaConsumoHembras !== null && ind.diferenciaConsumoHembras !== undefined">
            {{ formatearPorcentaje(ind.diferenciaConsumoHembras) }}
          </td>
          <td *ngIf="ind.diferenciaConsumoHembras === null || ind.diferenciaConsumoHembras === undefined">â€”</td>

          <!-- ProducciÃ³n -->
          <td>{{ ind.huevosTotales | number:'1.0-0' }}</td>
          <td>{{ ind.huevosIncubables | number:'1.0-0' }}</td>
          <td>{{ ind.promedioHuevosPorDia | number:'1.0-0' }}</td>
          <td [class]="getDiferenciaClass(ind.diferenciaPorcentajeProduccion)" *ngIf="ind.diferenciaPorcentajeProduccion !== null && ind.diferenciaPorcentajeProduccion !== undefined">
            {{ formatearPorcentaje(ind.diferenciaPorcentajeProduccion) }}
          </td>
          <td *ngIf="ind.diferenciaPorcentajeProduccion === null || ind.diferenciaPorcentajeProduccion === undefined">â€”</td>

          <!-- Peso -->
          <td>{{ ind.pesoPromedioHembras ? (ind.pesoPromedioHembras | number:'1.2-2') : 'â€”' }}</td>
          <td>{{ ind.pesoPromedioMachos ? (ind.pesoPromedioMachos | number:'1.2-2') : 'â€”' }}</td>
          <td [class]="getDiferenciaClass(ind.diferenciaPesoHembras)" *ngIf="ind.diferenciaPesoHembras !== null && ind.diferenciaPesoHembras !== undefined">
            {{ formatearPorcentaje(ind.diferenciaPesoHembras) }}
          </td>
          <td *ngIf="ind.diferenciaPesoHembras === null || ind.diferenciaPesoHembras === undefined">â€”</td>

          <!-- Uniformidad -->
          <td>{{ ind.uniformidadPromedio ? (ind.uniformidadPromedio | number:'1.2-2') : 'â€”' }}</td>
          <td [class]="getDiferenciaClass(ind.diferenciaUniformidad)" *ngIf="ind.diferenciaUniformidad !== null && ind.diferenciaUniformidad !== undefined">
            {{ formatearPorcentaje(ind.diferenciaUniformidad) }}
          </td>
          <td *ngIf="ind.diferenciaUniformidad === null || ind.diferenciaUniformidad === undefined">â€”</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loadingIndicadores && !error && indicadoresSemanales.length === 0" class="empty-state">
    <div class="empty-icon">ğŸ“Š</div>
    <p>No hay datos suficientes para calcular indicadores semanales.</p>
    <p class="empty-hint">Agrega registros de producciÃ³n desde la semana 26 para ver los indicadores.</p>
  </div>
</div>
