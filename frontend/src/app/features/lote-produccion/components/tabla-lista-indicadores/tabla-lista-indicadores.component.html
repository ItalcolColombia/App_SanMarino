<div class="indicadores-container">
  <div class="indicadores-header">
    <h3>üìà Indicadores Semanales de Producci√≥n</h3>
    <p class="indicadores-subtitle">
      Resumen de m√©tricas clave por semana de producci√≥n
      <span *ngIf="tieneDatosGuiaGenetica" class="badge-guia">‚úì Comparaci√≥n con Gu√≠a Gen√©tica disponible</span>
    </p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loadingIndicadores" class="loading-state">
    <div class="spinner"></div>
    <p>Calculando indicadores semanales...</p>
      </div>

  <!-- Error State -->
  <div *ngIf="error && !loadingIndicadores" class="error-state">
    <div class="error-icon">‚ö†Ô∏è</div>
    <p>{{ error }}</p>
    <button type="button" class="btn btn--outline" (click)="cargarIndicadores()">
      Reintentar
    </button>
        </div>

  <!-- Tabla de Indicadores -->
  <div *ngIf="!loadingIndicadores && !error && indicadoresSemanales.length > 0" class="indicadores-table-container">
    <table class="indicadores-table">
      <thead>
        <tr>
          <th rowspan="2">Semana</th>
          <th rowspan="2">Per√≠odo</th>
          <th rowspan="2">Etapa</th>
          <th rowspan="2">Registros</th>
          <th rowspan="2">Detalle</th>
          <th colspan="3">üíÄ Mortalidad</th>
          <th colspan="4">üåæ Consumo (g/ave/d√≠a)</th>
          <th colspan="7">ü•ö Producci√≥n Huevos</th>
          <th colspan="5">‚öñÔ∏è Peso / Uniformidad</th>
        </tr>
        <tr>
          <!-- Mortalidad -->
          <th>H</th>
          <th>M</th>
          <th>Dif. Gu√≠a</th>
          <!-- Consumo -->
          <th>H Real</th>
          <th>H Gu√≠a</th>
          <th>M Real</th>
          <th>M Gu√≠a</th>
          <!-- Producci√≥n -->
          <th>Totales</th>
          <th>Tot. Gu√≠a</th>
          <th>Incubables</th>
          <th>Inc. Gu√≠a</th>
          <th>Prom/D√≠a</th>
          <th>%Prod Real</th>
          <th>%Prod Gu√≠a</th>
          <!-- Peso / Uniformidad -->
          <th>Peso H (kg)</th>
          <th>Peso M (kg)</th>
          <th>Peso Huevo (g)</th>
          <th>Huevo Gu√≠a (g)</th>
          <th>Unif Real</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let ind of indicadoresSemanales">
        <tr class="indicador-row">
          <td><strong>{{ ind.semana }}</strong></td>
          <td class="periodo-cell">
            <span *ngIf="ind.fechaInicioSemana && ind.fechaFinSemana">
              {{ formatearFecha(ind.fechaInicioSemana) }} - {{ formatearFecha(ind.fechaFinSemana) }}
            </span>
            <span *ngIf="!ind.fechaInicioSemana || !ind.fechaFinSemana">‚Äî</span>
          </td>
          <td><span class="etapa-badge" [class]="'etapa-' + calcularEtapa(ind.semana).toLowerCase().replace(' ', '-')">
            {{ calcularEtapa(ind.semana) }}
          </span></td>
          <td>{{ ind.totalRegistros }}</td>
          <td>
            <button type="button" class="btn btn--outline" (click)="toggleExpanded(ind.semana)">
              {{ isExpanded(ind.semana) ? '‚àí' : '+' }}
            </button>
          </td>

          <!-- Mortalidad -->
          <td>{{ ind.mortalidadHembras }}</td>
          <td>{{ ind.mortalidadMachos }}</td>
          <td [class]="getDiferenciaClass(ind.diferenciaMortalidadHembras)" *ngIf="ind.diferenciaMortalidadHembras !== null && ind.diferenciaMortalidadHembras !== undefined">
            {{ formatearPorcentaje(ind.diferenciaMortalidadHembras) }}
          </td>
          <td *ngIf="ind.diferenciaMortalidadHembras === null || ind.diferenciaMortalidadHembras === undefined">‚Äî</td>

          <!-- Consumo (g/ave/d√≠a) -->
          <td>
            {{ consumoRealGrAveDiaH(ind) !== null ? (consumoRealGrAveDiaH(ind) | number:'1.0-0') : '‚Äî' }}
          </td>
          <td>
            {{ ind.consumoGuiaHembras !== null && ind.consumoGuiaHembras !== undefined ? (ind.consumoGuiaHembras | number:'1.0-0') : '‚Äî' }}
          </td>
          <td>
            {{ consumoRealGrAveDiaM(ind) !== null ? (consumoRealGrAveDiaM(ind) | number:'1.0-0') : '‚Äî' }}
          </td>
          <td>
            {{ ind.consumoGuiaMachos !== null && ind.consumoGuiaMachos !== undefined ? (ind.consumoGuiaMachos | number:'1.0-0') : '‚Äî' }}
          </td>

          <!-- Producci√≥n -->
          <td>{{ ind.huevosTotales | number:'1.0-0' }}</td>
          <td>{{ ind.huevosTotalesGuia !== null && ind.huevosTotalesGuia !== undefined ? (ind.huevosTotalesGuia | number:'1.0-0') : '‚Äî' }}</td>
          <td>{{ ind.huevosIncubables | number:'1.0-0' }}</td>
          <td>{{ ind.huevosIncubablesGuia !== null && ind.huevosIncubablesGuia !== undefined ? (ind.huevosIncubablesGuia | number:'1.0-0') : '‚Äî' }}</td>
          <td>{{ ind.promedioHuevosPorDia | number:'1.0-0' }}</td>
          <td>{{ ind.eficienciaProduccion | number:'1.2-2' }}</td>
          <td>{{ ind.porcentajeProduccionGuia !== null && ind.porcentajeProduccionGuia !== undefined ? (ind.porcentajeProduccionGuia | number:'1.2-2') : '‚Äî' }}</td>

          <!-- Peso / Uniformidad -->
          <td>{{ ind.pesoPromedioHembras ? (ind.pesoPromedioHembras | number:'1.2-2') : '‚Äî' }}</td>
          <td>{{ ind.pesoPromedioMachos ? (ind.pesoPromedioMachos | number:'1.2-2') : '‚Äî' }}</td>
          <td>{{ ind.pesoHuevoPromedio !== null && ind.pesoHuevoPromedio !== undefined ? (ind.pesoHuevoPromedio | number:'1.2-2') : '‚Äî' }}</td>
          <td>{{ ind.pesoHuevoGuia !== null && ind.pesoHuevoGuia !== undefined ? (ind.pesoHuevoGuia | number:'1.2-2') : '‚Äî' }}</td>
          <td>{{ ind.uniformidadPromedio !== null && ind.uniformidadPromedio !== undefined ? (ind.uniformidadPromedio | number:'1.2-2') : '‚Äî' }}</td>
        </tr>

        <!-- Detalle clasificadora (expandible) -->
        <tr *ngIf="isExpanded(ind.semana)" class="detalle-row">
          <td colspan="21">
            <div>
              <strong>Clasificadora semana {{ ind.semana }}:</strong>
              Limpio: {{ ind.huevosLimpios }} |
              Tratado: {{ ind.huevosTratados }} |
              Sucio: {{ ind.huevosSucios }} |
              Deforme: {{ ind.huevosDeformes }} |
              Blanco: {{ ind.huevosBlancos }} |
              Doble yema: {{ ind.huevosDobleYema }} |
              Piso: {{ ind.huevosPiso }} |
              Peque√±o: {{ ind.huevosPequenos }} |
              Roto: {{ ind.huevosRotos }} |
              Desecho: {{ ind.huevosDesecho }} |
              Otro: {{ ind.huevosOtro }}
            </div>
          </td>
        </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loadingIndicadores && !error && indicadoresSemanales.length === 0" class="empty-state">
    <div class="empty-icon">üìä</div>
    <p>No hay datos suficientes para calcular indicadores semanales.</p>
    <p class="empty-hint">Agrega registros de producci√≥n desde la semana 26 para ver los indicadores.</p>
  </div>
</div>
