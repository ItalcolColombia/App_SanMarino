<!-- src/app/features/db-studio/pages/query-console/query-console.page.html -->
<div class="ux-page" [attr.aria-busy]="loading() ? 'true' : null">
  <header class="ux-header">
    <div class="ux-header__title">
      <h1>üíª DB Studio ‚Äî Consola SQL</h1>
      <p class="ux-header__subtitle">Ejecuta consultas SQL y visualiza resultados</p>
    </div>
    <div class="ux-header__actions">
      <a routerLink="explorer" class="btn btn--outline">üîç Explorador</a>
      <a routerLink="" class="btn btn--ghost">üìä Dashboard</a>
    </div>
  </header>

  <div class="query-console-container">
    <!-- Panel de Consulta SQL -->
    <div class="ux-card query-panel">
      <div class="query-header">
        <h2>üìù Consulta SQL</h2>
        <div class="query-actions">
          <button
            class="btn btn--primary"
            (click)="run()"
            [disabled]="loading()">
            <span *ngIf="!loading()">‚ñ∂Ô∏è Ejecutar</span>
            <span *ngIf="loading()">‚è≥ Ejecutando...</span>
          </button>
        </div>
      </div>

      <div class="query-editor">
        <label class="query-label">SQL Query (SELECT/WITH)</label>
        <textarea
          [ngModel]="sql()"
          (ngModelChange)="sql.set($event)"
          rows="10"
          class="sql-editor"
          placeholder="SELECT * FROM tabla LIMIT 100;">
        </textarea>
      </div>

      <div class="query-options">
        <div class="options-grid">
          <div class="option-group">
            <label class="query-label">Par√°metros (JSON opcional)</label>
            <textarea
              [ngModel]="paramsText()"
              (ngModelChange)="paramsText.set($event)"
              rows="4"
              class="params-editor"
              placeholder='{"param1": "value1"}'>
            </textarea>
          </div>
          <div class="option-group">
            <label class="query-label">L√≠mite de filas</label>
            <input
              type="number"
              [ngModel]="limit()"
              (ngModelChange)="limit.set($event)"
              min="1"
              max="10000"
              class="number-input">
          </div>
          <div class="option-group">
            <label class="query-label">Offset</label>
            <input
              type="number"
              [ngModel]="offset()"
              (ngModelChange)="offset.set($event)"
              min="0"
              class="number-input">
          </div>
        </div>
      </div>
    </div>

    <!-- Panel de Resultados -->
    <div class="ux-card results-panel" *ngIf="page() as p">
      <div class="results-header">
        <h2>üìä Resultados</h2>
        <div class="results-info">
          <span class="badge badge--info">{{ p.rows.length }} filas</span>
          <span class="badge badge--success" *ngIf="p.executionTime">
            {{ p.executionTime }}ms
          </span>
        </div>
      </div>

      <div class="table-container" *ngIf="p.rows.length; else noData">
        <div class="table-scroll">
          <table class="ux-table">
            <thead>
              <tr>
                <th *ngFor="let k of keys(p.rows[0])">{{ k }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of p.rows">
                <td *ngFor="let k of keys(p.rows[0])">
                  <code class="cell-value">{{ formatValue(r[k]) }}</code>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pager">
          <button
            class="btn btn--outline"
            (click)="prev()"
            [disabled]="offset() === 0">
            ‚Üê Anterior
          </button>
          <span class="pager-info">
            Mostrando {{ offset() + 1 }} - {{ offset() + p.rows.length }} de {{ p.count || '?' }} registros
          </span>
          <button
            class="btn btn--outline"
            (click)="next()"
            [disabled]="p.rows.length < limit()">
            Siguiente ‚Üí
          </button>
        </div>
      </div>

      <ng-template #noData>
        <div class="no-data">
          <p class="muted">No se encontraron resultados para esta consulta.</p>
        </div>
      </ng-template>
    </div>

    <!-- Mensaje de Error -->
    <div class="ux-card error-card" *ngIf="error()">
      <div class="error-content">
        <span class="error-icon">‚ö†Ô∏è</span>
        <div class="error-message">
          <strong>Error al ejecutar la consulta:</strong>
          <p>{{ error() }}</p>
        </div>
      </div>
    </div>
  </div>
</div>
