<!-- ================= GR√ÅFICAS PRINCIPAL ================= -->
<div class="graficas-container">
  <div class="graficas-header">
    <h3>üìä An√°lisis Gr√°fico del Lote</h3>
    <p class="graficas-subtitle" *ngIf="selectedLote">
      {{ selectedLote.loteNombre || ('Lote #' + selectedLote.loteId) }} - {{ indicadoresSemanales.length }} semanas registradas
    </p>
  </div>

  <!-- Estado de carga -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>Cargando datos para gr√°ficas...</p>
  </div>

  <!-- Estado sin datos -->
  <div class="empty-state" *ngIf="!loading && indicadoresSemanales.length === 0">
    <div class="empty-icon">üìä</div>
    <h4>No hay datos para mostrar</h4>
    <p>Se necesitan registros de seguimiento diario para generar las gr√°ficas.</p>
  </div>

  <!-- Contenido principal de gr√°ficas -->
  <div *ngIf="!loading && indicadoresSemanales.length > 0" class="graficas-content-wrapper">

    <!-- ========== CONTROLES ========== -->
    <div class="graficas-controls">
      <!-- Selector de tipo de gr√°fica (M√∫ltiple) -->
      <div class="control-group">
        <label class="control-label">üìà Tipo de Indicador:</label>
        <div class="tipos-indicador-selector">
          <p class="tipos-hint">Selecciona uno o m√°s indicadores para comparar en una sola gr√°fica:</p>
          <div class="tipos-checkboxes">
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('mortalidad')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('mortalidad')"
                     (change)="toggleTipoGrafica('mortalidad')">
              <span class="tipo-icon">üíÄ</span>
              <span class="tipo-nombre">Mortalidad</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('consumo')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('consumo')"
                     (change)="toggleTipoGrafica('consumo')">
              <span class="tipo-icon">üçΩÔ∏è</span>
              <span class="tipo-nombre">Consumo</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('peso')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('peso')"
                     (change)="toggleTipoGrafica('peso')">
              <span class="tipo-icon">‚öñÔ∏è</span>
              <span class="tipo-nombre">Peso</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('conversion')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('conversion')"
                     (change)="toggleTipoGrafica('conversion')">
              <span class="tipo-icon">üîÑ</span>
              <span class="tipo-nombre">Conversi√≥n</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('seleccion')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('seleccion')"
                     (change)="toggleTipoGrafica('seleccion')">
              <span class="tipo-icon">üìã</span>
              <span class="tipo-nombre">Selecci√≥n</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('aves')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('aves')"
                     (change)="toggleTipoGrafica('aves')">
              <span class="tipo-icon">üêî</span>
              <span class="tipo-nombre">Aves Vivas</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('consumoTabla')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('consumoTabla')"
                     (change)="toggleTipoGrafica('consumoTabla')">
              <span class="tipo-icon">üìä</span>
              <span class="tipo-nombre">Consumo Tabla</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('retiro')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('retiro')"
                     (change)="toggleTipoGrafica('retiro')">
              <span class="tipo-icon">üìâ</span>
              <span class="tipo-nombre">Retiro</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('uniformidad')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('uniformidad')"
                     (change)="toggleTipoGrafica('uniformidad')">
              <span class="tipo-icon">üìê</span>
              <span class="tipo-nombre">Uniformidad</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('cv')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('cv')"
                     (change)="toggleTipoGrafica('cv')">
              <span class="tipo-icon">üìà</span>
              <span class="tipo-nombre">CV</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('difConsumo')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('difConsumo')"
                     (change)="toggleTipoGrafica('difConsumo')">
              <span class="tipo-icon">üîÄ</span>
              <span class="tipo-nombre">Dif. Consumo</span>
            </label>
            <label class="tipo-checkbox-label"
                   [class.selected]="isTipoGraficaSeleccionado('incrConsumo')">
              <input type="checkbox"
                     [checked]="isTipoGraficaSeleccionado('incrConsumo')"
                     (change)="toggleTipoGrafica('incrConsumo')">
              <span class="tipo-icon">üìä</span>
              <span class="tipo-nombre">Incr. Consumo</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Selector de visualizaci√≥n -->
      <div class="control-group">
        <label class="control-label">üé® Visualizaci√≥n:</label>
        <div class="visualization-toggle">
          <button type="button"
                  class="toggle-btn"
                  [class.active]="tipoVisualizacion === 'barra'"
                  (click)="tipoVisualizacion = 'barra'; onVisualizacionChange()">
            üìä Barras
          </button>
          <button type="button"
                  class="toggle-btn"
                  [class.active]="tipoVisualizacion === 'linea'"
                  (click)="tipoVisualizacion = 'linea'; onVisualizacionChange()">
            üìà L√≠neas
          </button>
          <button type="button"
                  class="toggle-btn"
                  [class.active]="tipoVisualizacion === 'torta'"
                  (click)="tipoVisualizacion = 'torta'; onVisualizacionChange()">
            ü•ß Torta
          </button>
        </div>
      </div>

      <!-- Selector comparativo -->
      <div class="control-group control-group--comparativo">
        <label class="control-label">
          <input type="checkbox"
                 [(ngModel)]="mostrarComparativo"
                 (change)="toggleComparativo()">
          Comparar Semanas
        </label>
        <div class="comparativo-selectors" *ngIf="mostrarComparativo">
          <select class="control-select"
                  [(ngModel)]="semanaComparacion1"
                  (ngModelChange)="onSemanaComparacionChange()">
            <option [ngValue]="null">Seleccione semana 1</option>
            <option *ngFor="let semana of semanasDisponibles" [ngValue]="semana">
              Semana {{ semana }}
            </option>
          </select>
          <span class="vs-badge">VS</span>
          <select class="control-select"
                  [(ngModel)]="semanaComparacion2"
                  (ngModelChange)="onSemanaComparacionChange()">
            <option [ngValue]="null">Seleccione semana 2</option>
            <option *ngFor="let semana of semanasDisponibles" [ngValue]="semana">
              Semana {{ semana }}
            </option>
          </select>
        </div>
      </div>

      <!-- Comparaci√≥n Personalizada de M√©tricas -->
      <div class="control-group control-group--comparativo">
        <label class="control-label">
          <input type="checkbox"
                 [(ngModel)]="mostrarComparacionPersonalizada"
                 (change)="toggleComparacionPersonalizada()">
          üîÄ Comparaci√≥n Personalizada
        </label>
        <div class="metricas-selector" *ngIf="mostrarComparacionPersonalizada">
          <p class="metricas-hint">Selecciona las m√©tricas que deseas comparar:</p>
          <div class="metricas-checkboxes">
            <label *ngFor="let metrica of metricasDisponibles"
                   class="metrica-checkbox-label"
                   [class.selected]="isMetricaSeleccionada(metrica.id)">
              <input type="checkbox"
                     [checked]="isMetricaSeleccionada(metrica.id)"
                     (change)="toggleMetrica(metrica.id)">
              <span class="metrica-icon">{{ metrica.icono }}</span>
              <span class="metrica-nombre">{{ metrica.nombre }}</span>
              <span class="metrica-indicator"
                    [style.background-color]="metrica.color"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== GR√ÅFICA PRINCIPAL ========== -->
    <div class="grafica-principal-section">
      <div class="grafica-card">
        <div class="grafica-card-header">
          <h4>{{ getTituloGrafica() }}</h4>
          <span class="grafica-badge">{{ indicadoresSemanales.length }} semanas</span>
        </div>
        <div class="grafica-card-body">
          <!-- Gr√°fica de Comparaci√≥n Personalizada -->
          <div class="chart-container" *ngIf="mostrarComparacionPersonalizada && metricasSeleccionadas.length > 0">
            <canvas baseChart
                    [type]="tipoVisualizacion === 'linea' ? lineChartType : (tipoVisualizacion === 'torta' ? barChartType : barChartType)"
                    [data]="comparacionPersonalizadaChartData"
                    [options]="comparacionPersonalizadaChartOptions">
            </canvas>
            <div class="chart-info">
              <p class="info-text">
                Comparando <strong>{{ metricasSeleccionadas.length }}</strong> m√©trica(s):
                <strong *ngFor="let metricaId of metricasSeleccionadas; let last = last">
                  <ng-container *ngIf="getMetricaInfo(metricaId) as metrica">
                    {{ metrica.icono }} {{ metrica.nombre }}<span *ngIf="!last">, </span>
                  </ng-container>
                </strong>
              </p>
            </div>
          </div>

          <!-- Mensaje cuando no hay m√©tricas seleccionadas -->
          <div class="empty-state" *ngIf="mostrarComparacionPersonalizada && metricasSeleccionadas.length === 0">
            <div class="empty-icon">üìä</div>
            <h4>Selecciona m√©tricas para comparar</h4>
            <p>Marca al menos una m√©trica en el selector de arriba para ver la comparaci√≥n.</p>
          </div>

          <!-- Gr√°fica Comparativa de Semanas -->
          <div class="chart-container" *ngIf="mostrarComparativo && !mostrarComparacionPersonalizada && semanaComparacion1 && semanaComparacion2">
            <canvas baseChart
                    [type]="barChartType"
                    [data]="comparativoChartData"
                    [options]="comparativoChartOptions">
            </canvas>
            <div class="chart-info">
              <p class="info-text">
                Comparando <strong>Semana {{ semanaComparacion1 }}</strong> vs
                <strong>Semana {{ semanaComparacion2 }}</strong>
              </p>
            </div>
          </div>

          <!-- Gr√°fica Combinada de Tipos de Indicadores -->
          <div class="chart-container" *ngIf="mostrarGraficaCombinada && tiposGraficaSeleccionados.length > 1 && !mostrarComparativo && !mostrarComparacionPersonalizada">
            <canvas baseChart
                    [type]="tipoVisualizacion === 'linea' ? lineChartType : (tipoVisualizacion === 'torta' ? barChartType : barChartType)"
                    [data]="tiposCombinadosChartData"
                    [options]="tiposCombinadosChartOptions">
            </canvas>
            <div class="chart-info">
              <p class="info-text">
                Comparando <strong>{{ tiposGraficaSeleccionados.length }}</strong> tipo(s) de indicador(es) seleccionado(s)
              </p>
            </div>
          </div>

          <!-- Gr√°ficas Individuales (cuando solo hay un tipo seleccionado) -->
          <div class="chart-container" *ngIf="!mostrarGraficaCombinada && !mostrarComparativo && !mostrarComparacionPersonalizada">
            <!-- Gr√°fica de Mortalidad -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'mortalidad' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="mortalidadChartData"
                    [options]="mortalidadChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'mortalidad' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="mortalidadChartData"
                    [options]="mortalidadChartOptions">
            </canvas>

            <!-- Gr√°fica de Consumo -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'consumo' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="consumoChartData"
                    [options]="consumoChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'consumo' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="consumoChartData"
                    [options]="consumoChartOptions">
            </canvas>

            <!-- Gr√°fica de Peso -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'peso' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="pesoChartData"
                    [options]="pesoChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'peso' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="pesoChartData"
                    [options]="pesoChartOptions">
            </canvas>

            <!-- Gr√°fica de Conversi√≥n -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'conversion' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="conversionChartData"
                    [options]="conversionChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'conversion' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="conversionChartData"
                    [options]="conversionChartOptions">
            </canvas>

            <!-- Gr√°fica de Selecci√≥n -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'seleccion' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="seleccionChartData"
                    [options]="seleccionChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'seleccion' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="seleccionChartData"
                    [options]="seleccionChartOptions">
            </canvas>

            <!-- Gr√°fica de Aves -->
            <canvas *ngIf="tipoGraficaSeleccionada === 'aves' && tipoVisualizacion === 'barra'"
                    baseChart
                    [type]="barChartType"
                    [data]="avesChartData"
                    [options]="avesChartOptions">
            </canvas>
            <canvas *ngIf="tipoGraficaSeleccionada === 'aves' && tipoVisualizacion === 'linea'"
                    baseChart
                    [type]="lineChartType"
                    [data]="avesChartData"
                    [options]="avesChartOptions">
            </canvas>

            <!-- Gr√°fica de Torta (solo para mortalidad vs selecci√≥n) -->
            <canvas *ngIf="tipoVisualizacion === 'torta'"
                    baseChart
                    [type]="pieChartType"
                    [data]="tortaChartData"
                    [options]="tortaChartOptions">
            </canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== GR√ÅFICAS ADICIONALES (GRID) ========== -->
    <div class="graficas-grid" *ngIf="indicadoresSemanales.length > 0">
      <!-- Gr√°fica de Mortalidad por Semana -->
      <div class="grafica-card grafica-card--small">
        <div class="grafica-card-header">
          <h5>üíÄ Mortalidad por Semana</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small">
            <canvas baseChart
                    [type]="barChartType"
                    [data]="mortalidadChartData"
                    [options]="mortalidadChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats">
            <div class="stat-item">
              <span class="stat-label">Promedio:</span>
              <span class="stat-value">{{ calcularPromedioIndicadores('mortalidadSem') | number:'1.2-2' }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica de Consumo -->
      <div class="grafica-card grafica-card--small">
        <div class="grafica-card-header">
          <h5>üçΩÔ∏è Consumo de Alimento</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small">
            <canvas baseChart
                    [type]="barChartType"
                    [data]="consumoChartData"
                    [options]="consumoChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats">
            <div class="stat-item">
              <span class="stat-label">Promedio Real:</span>
              <span class="stat-value">{{ calcularPromedioIndicadores('consumoReal') | number:'1.0-0' }}g</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Promedio Tabla:</span>
              <span class="stat-value">{{ calcularPromedioIndicadores('consumoTabla') | number:'1.0-0' }}g</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica de Peso -->
      <div class="grafica-card grafica-card--small">
        <div class="grafica-card-header">
          <h5>‚öñÔ∏è Evoluci√≥n de Peso</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small">
            <canvas baseChart
                    [type]="lineChartType"
                    [data]="pesoChartData"
                    [options]="pesoChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats">
            <div class="stat-item">
              <span class="stat-label">Peso Actual:</span>
              <span class="stat-value">{{ indicadoresSemanales[indicadoresSemanales.length - 1]?.pesoCierre | number:'1.2-2' }}g</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ganancia:</span>
              <span class="stat-value">{{ calcularGananciaTotal() | number:'1.2-2' }}g</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica de Conversi√≥n -->
      <div class="grafica-card grafica-card--small">
        <div class="grafica-card-header">
          <h5>üîÑ Conversi√≥n Alimenticia</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small">
            <canvas baseChart
                    [type]="lineChartType"
                    [data]="conversionChartData"
                    [options]="conversionChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats">
            <div class="stat-item">
              <span class="stat-label">Promedio:</span>
              <span class="stat-value">{{ calcularPromedioIndicadores('conversionAlimenticia') | number:'1.2-2' }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Mejor:</span>
              <span class="stat-value">{{ getMejorSemanaConversion() }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica de Distribuci√≥n (Torta) -->
      <div class="grafica-card grafica-card--small" *ngIf="indicadoresSemanales.length > 0">
        <div class="grafica-card-header">
          <h5>ü•ß Distribuci√≥n √öltima Semana</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small chart-container--torta">
            <canvas baseChart
                    [type]="pieChartType"
                    [data]="tortaChartData"
                    [options]="tortaChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats" *ngIf="indicadoresSemanales.length > 0">
            <div class="stat-item">
              <span class="stat-label">Mortalidad:</span>
              <span class="stat-value">{{ indicadoresSemanales[indicadoresSemanales.length - 1]?.mortalidadSem | number:'1.2-2' }}%</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Selecci√≥n:</span>
              <span class="stat-value">{{ indicadoresSemanales[indicadoresSemanales.length - 1]?.seleccionSem | number:'1.2-2' }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica de Aves Vivas -->
      <div class="grafica-card grafica-card--small">
        <div class="grafica-card-header">
          <h5>üêî Aves Vivas por Semana</h5>
        </div>
        <div class="grafica-card-body">
          <div class="chart-container chart-container--small">
            <canvas baseChart
                    [type]="barChartType"
                    [data]="avesChartData"
                    [options]="avesChartOptions">
            </canvas>
          </div>
          <div class="grafica-stats">
            <div class="stat-item">
              <span class="stat-label">Aves Actuales:</span>
              <span class="stat-value">{{ indicadoresSemanales[indicadoresSemanales.length - 1]?.avesFinSemana | number:'1.0-0' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== RESUMEN DE M√âTRICAS ========== -->
    <div class="metricas-resumen" *ngIf="indicadoresSemanales.length > 0">
      <h4>üìä Resumen de M√©tricas Generales</h4>
      <div class="metricas-grid">
        <div class="metrica-card">
          <div class="metrica-icon">‚öñÔ∏è</div>
          <div class="metrica-content">
            <h5>Peso Actual</h5>
            <p>{{ indicadoresSemanales[indicadoresSemanales.length - 1]?.pesoCierre | number:'1.2-2' }}g</p>
          </div>
        </div>

        <div class="metrica-card">
          <div class="metrica-icon">üçΩÔ∏è</div>
          <div class="metrica-content">
            <h5>Conv. Promedio</h5>
            <p>{{ calcularPromedioIndicadores('conversionAlimenticia') | number:'1.2-2' }}</p>
          </div>
        </div>

        <div class="metrica-card">
          <div class="metrica-icon">üíÄ</div>
          <div class="metrica-content">
            <h5>Mort. Promedio</h5>
            <p>{{ calcularPromedioIndicadores('mortalidadSem') | number:'1.2-2' }}%</p>
          </div>
        </div>

        <div class="metrica-card">
          <div class="metrica-icon">üêî</div>
          <div class="metrica-content">
            <h5>Aves Actuales</h5>
            <p>{{ indicadoresSemanales[indicadoresSemanales.length - 1]?.avesFinSemana | number:'1.0-0' }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
