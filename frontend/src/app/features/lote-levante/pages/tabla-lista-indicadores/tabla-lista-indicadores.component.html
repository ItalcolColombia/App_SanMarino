<!-- ================= TABLA DE INDICADORES SEMANALES ================= -->
<div class="indicadores-container">
  <div class="indicadores-header">
    <h3>Indicadores Semanales</h3>
    <button 
      (click)="mostrarFormulas = !mostrarFormulas" 
      class="btn-formulas">
       F贸rmulas
    </button>
  </div>

  <!-- Modal de F贸rmulas -->
  <div class="formulas-modal" *ngIf="mostrarFormulas" (click)="mostrarFormulas = false">
    <div class="formulas-content" (click)="$event.stopPropagation()">
      <div class="formulas-header">
        <h4> F贸rmulas de Indicadores</h4>
        <button class="btn-close" (click)="mostrarFormulas = false"></button>
      </div>
      <div class="formulas-body">
        <div class="formula-group" *ngFor="let grupo of gruposFormulas">
          <h5 class="formula-group-title">{{ grupo.titulo }}</h5>
          <ul class="formula-list">
            <li *ngFor="let formula of grupo.formulas" class="formula-item">
              <strong>{{ formula.nombre }}:</strong>
              <span class="formula-text">{{ formula.formula }}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <div class="ux-scroll">
    <table class="ux-table indicadores-table">
      <thead>
        <tr>
          <th rowspan="2" class="header-group-basic">Semana</th>
          <th rowspan="2" class="header-group-basic">Per铆odo</th>
          <th colspan="2" class="header-group-info header-group-region">Regi贸n y Granja</th>
          <th colspan="2" class="header-group-info header-group-nave">Nave y Sub Lote</th>
          <th rowspan="2" class="header-group-aves">Aves Inicio</th>
          <th rowspan="2" class="header-group-aves">Aves Fin</th>
          <th colspan="3" class="header-group-main">Consumo</th>
          <th rowspan="2" class="header-group-main">Conv. Alimenticia</th>
          <th colspan="2" class="header-group-main">Ganancia</th>
          <th colspan="3" class="header-group-main">Peso (Real vs Tabla)</th>
          <th colspan="2" class="header-group-main">Uniformidad (Real vs Tabla)</th>
          <th colspan="4" class="header-group-main">Mortalidad & Selecci贸n</th>
          <th rowspan="2" class="header-group-indicadores">Eficiencia</th>
          <th rowspan="2" class="header-group-indicadores">IP</th>
          <th rowspan="2" class="header-group-indicadores">VPI</th>
          <th rowspan="2" class="header-group-otros">Piso T茅rmico</th>
          <th rowspan="2" class="header-group-otros">Observaciones</th>
        </tr>
        <tr>
          <th class="header-sub header-sub-region">Regi贸n</th>
          <th class="header-sub header-sub-region">Granja</th>
          <th class="header-sub header-sub-nave">Nave</th>
          <th class="header-sub header-sub-nave">Sub Lote</th>
          <th class="header-sub">Diario (g)</th>
          <th class="header-sub">Tabla (g)</th>
          <th class="header-sub">Real Total Semana (g)</th>
          <th class="header-sub">Semana (g)</th>
          <th class="header-sub">Diaria (g/d铆a)</th>
          <th class="header-sub">Real (g)</th>
          <th class="header-sub">Tabla (g)</th>
          <th class="header-sub">Dif (%)</th>
          <th class="header-sub">Real (%)</th>
          <th class="header-sub">Tabla (%)</th>
          <th class="header-sub">Mortalidad (%)</th>
          <th class="header-sub">Tabla (%)</th>
          <th class="header-sub">Selecci贸n (%)</th>
          <th class="header-sub">Error Sexaje (%)</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="!indicadoresSemanales || indicadoresSemanales.length === 0">
          <td colspan="28" class="empty-state">
            <div class="empty-illustration" aria-hidden="true"></div>
            <p>No hay datos de indicadores disponibles.</p>
          </td>
        </tr>

        <tr *ngFor="let ind of indicadoresSemanales" class="indicador-row">
          <td class="semana-cell">{{ ind.semana }}</td>
          <td class="periodo-cell">
            {{ formatDate(ind.fechaInicio) }} - {{ formatDate(ind.fechaFin) }}
          </td>
          <td>{{ ind.region || '-' }}</td>
          <td>{{ ind.granja || '-' }}</td>
          <td>{{ ind.nave || '-' }}</td>
          <td>{{ ind.sublote || '-' }}</td>
          <td>{{ ind.avesInicioSemana | number:'1.0-0' }}</td>
          <td>{{ ind.avesFinSemana | number:'1.0-0' }}</td>
          <td class="consumo-diario" 
              [class]="'consumo-' + validarConsumo(ind.consumoDiario, ind.consumoTabla).tipo">
            {{ formatNumber(ind.consumoDiario, 1) }}
            <span class="alert-icon" 
                  [title]="validarConsumo(ind.consumoDiario, ind.consumoTabla).mensaje"
                  *ngIf="!validarConsumo(ind.consumoDiario, ind.consumoTabla).esValido">
              锔
            </span>
          </td>
          <td>{{ formatNumber(ind.consumoTabla, 1) }}</td>
          <td class="consumo-total-semana">
            {{ ind.consumoTotalSemana | number:'1.0-0' }}
          </td>
          <td>{{ formatNumber(ind.conversionAlimenticia, 2) }}</td>
          <td class="ganancia-semana" 
              [class]="'ganancia-' + validarGanancia(ind.gananciaSemana, ind.semana, ind.gananciaTabla).tipo">
            {{ formatNumber(ind.gananciaSemana, 2) }}
            <span class="alert-icon" 
                  [title]="validarGanancia(ind.gananciaSemana, ind.semana, ind.gananciaTabla).mensaje"
                  *ngIf="!validarGanancia(ind.gananciaSemana, ind.semana, ind.gananciaTabla).esValido">
              锔
            </span>
          </td>
          <td>{{ formatNumber(ind.gananciaDiariaAcumulada, 2) }}</td>
          <td class="mortalidad-semana" 
              [class]="'mortalidad-' + validarMortalidad(ind.mortalidadSem, ind.semana, ind.mortTabla).tipo">
            {{ formatPercentage(ind.mortalidadSem) }}
            <span class="alert-icon" 
                  [title]="validarMortalidad(ind.mortalidadSem, ind.semana, ind.mortTabla).mensaje"
                  *ngIf="!validarMortalidad(ind.mortalidadSem, ind.semana, ind.mortTabla).esValido">
              锔
            </span>
          </td>
          <td>{{ formatPercentage(ind.mortTabla) }}</td>
          <td>{{ formatPercentage(ind.seleccionSem) }}</td>
          <td>{{ formatPercentage(ind.errorSexajeSem) }}</td>
          <td>{{ formatNumber(ind.pesoCierre, 0) }}</td>
          <td>{{ formatNumber(ind.pesoTabla, 0) }}</td>
          <td>{{ formatPercentage(ind.difPesoPct, 1) }}</td>
          <td>{{ formatPercentage(ind.unifReal, 1) }}</td>
          <td>{{ formatPercentage(ind.unifTabla, 1) }}</td>
          <td>{{ formatNumber(ind.eficiencia, 2) }}</td>
          <td>{{ formatNumber(ind.ip, 2) }}</td>
          <td>{{ formatNumber(ind.vpi, 2) }}</td>
          <td class="piso-termico">
            <span class="badge" [class.visible]="ind.pisoTermicoVisible">
              {{ ind.pisoTermicoVisible ? 'S铆' : 'No' }}
            </span>
          </td>
          <td class="observaciones-cell">{{ ind.observaciones || '-' }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Resumen de Acumulados -->
  <div class="acumulados-section" *ngIf="indicadoresSemanales.length > 0">
    <h4>Resumen Acumulado</h4>
    <div class="acumulados-grid">
      <div class="acumulado-card">
        <h5>Mortalidad Acumulada</h5>
        <p>{{ formatPercentage(indicadoresSemanales[indicadoresSemanales.length - 1].mortalidadAcum || 0) }}</p>
      </div>
      <div class="acumulado-card">
        <h5>Selecci贸n Acumulada</h5>
        <p>{{ formatPercentage(indicadoresSemanales[indicadoresSemanales.length - 1].seleccionAcum || 0) }}</p>
      </div>
      <div class="acumulado-card">
        <h5>Total Mort. + Sel.</h5>
        <p>{{ formatPercentage(indicadoresSemanales[indicadoresSemanales.length - 1].mortalidadMasSeleccionAcum || 0) }}</p>
      </div>
    </div>
  </div>
</div>
