<!-- featrures/catalogo-alimentos/pages/catalogo-alimentos-list/catalogo-alimentos-list.html -->
<div class="ux-page" [attr.aria-busy]="loading ? 'true' : null">


  <div class="ux-main">
    <!-- Header -->
    <header class="ux-header">
      <div class="ux-header__title">

        <div class="ux-header__meta">
          <span class="chip chip--muted" aria-live="polite">{{ total }} registro(s)</span>
          <span class="chip" *ngIf="q">Filtro: ‚Äú{{ q }}‚Äù</span>
          <span class="chip" *ngIf="typeFilter">Tipo: {{ typeFilter | titlecase }}</span>
          <span class="chip" *ngIf="statusFilter !== 'all'">
            Estado: {{ statusFilter === 'active' ? 'Activos' : 'Inactivos' }}
          </span>
        </div>
      </div>

      <div class="ux-header__actions">
        <button type="button" class="btn btn--primary" (click)="create()">
          <fa-icon [icon]="faPlus" class="mr-2" aria-hidden="true"></fa-icon>
          Nuevo
        </button>
      </div>
    </header>

    <!-- Filtros r√°pidos -->
    <section class="ux-toolbar" role="group" aria-label="Filtros del cat√°logo">
      <div class="ux-input-icon">
        <fa-icon [icon]="faSearch" aria-hidden="true"></fa-icon>
        <input
          type="search"
          [(ngModel)]="q"
          (ngModelChange)="page = 1; load()"
          placeholder="Buscar por c√≥digo o nombre‚Ä¶"
          aria-label="Buscar en el cat√°logo"
        />
      </div>

      <div class="ux-toolbar__filters">
        <!-- Tipo -->
        <label class="sr-only" for="f-type">Tipo</label>
        <select id="f-type" [(ngModel)]="typeFilter" (ngModelChange)="page=1; load()" title="Filtrar por tipo">
          <option [ngValue]="''">Todos los tipos</option>
          <option *ngFor="let t of tiposItem" [ngValue]="t">{{ t | titlecase }}</option>
        </select>

        <!-- Estado -->
        <label class="sr-only" for="f-status">Estado</label>
        <select id="f-status" [(ngModel)]="statusFilter" (ngModelChange)="page=1; load()" title="Filtrar por estado">
          <option value="all">Todos</option>
          <option value="active">Activos</option>
          <option value="inactive">Inactivos</option>
        </select>

        <!-- Tama√±o p√°gina -->
        <label class="sr-only" for="f-size">Tama√±o de p√°gina</label>
        <select id="f-size" [(ngModel)]="pageSize" (ngModelChange)="page=1; load()" title="Tama√±o de p√°gina">
          <option *ngFor="let s of pageSizes" [ngValue]="s">{{ s }}/p√°g.</option>
        </select>
      </div>

      <div class="spacer"></div>

      <div class="pager" role="navigation" aria-label="Paginaci√≥n">
        <button class="icon-btn" [disabled]="page<=1" (click)="prev()" title="Anterior">
          <fa-icon [icon]="faChevronLeft" aria-hidden="true"></fa-icon>
        </button>
        <span class="pager__info">P√°gina {{ page }} de {{ totalPages }}</span>
        <button class="icon-btn" [disabled]="page * pageSize >= total" (click)="next()" title="Siguiente">
          <fa-icon [icon]="faChevronRight" aria-hidden="true"></fa-icon>
        </button>
      </div>
    </section>

    <!-- Tabla -->
    <section class="ux-card">
      <div class="ux-scroll">
        <table class="ux-table">
          <caption class="sr-only">Tabla de cat√°logo de √≠tems</caption>
          <thead>
            <tr>
              <th scope="col">C√≥digo</th>
              <th scope="col">Nombre</th>
              <th scope="col">Tipo</th>
              <th scope="col">Metadatos</th>
              <th scope="col">Activo</th>
              <th scope="col" class="text-right">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let it of items; trackBy: trackById">
              <td><code>{{ it.codigo }}</code></td>
              <td>
                <div class="cell-title">
                  <span class="title-text">{{ it.nombre }}</span>
                  <span class="subtitle-text" *ngIf="it.metadata?.fabricante">de {{ it.metadata.fabricante }}</span>
                </div>
              </td>

              <!-- Tipo -->
              <td>
                <span class="chip chip--info">
                  {{ typeOf(it.metadata) || '‚Äî' }}
                </span>
              </td>

              <!-- Metadatos clave como chips -->
              <td class="meta-col">
                <ng-container *ngIf="metaChips(it.metadata)?.length; else noMeta">
                  <span class="meta-chip" *ngFor="let c of metaChips(it.metadata)">
                    {{ c.key }}: {{ c.value }}
                  </span>
                </ng-container>
                <ng-template #noMeta>‚Äî</ng-template>
              </td>

              <td>
                <span class="chip" [class.chip--success]="it.activo" [class.chip--danger]="!it.activo">
                  {{ it.activo ? 'S√≠' : 'No' }}
                </span>
              </td>

              <td class="text-right">
                <div class="btn-group">
                  <button type="button" class="icon-btn" (click)="edit(it)" title="Editar">‚úé</button>
                  <button type="button" class="icon-btn icon-btn--danger" (click)="delete(it.id!)" title="Eliminar">üóë</button>
                </div>
              </td>
            </tr>

            <tr *ngIf="!loading && items.length === 0">
              <td colspan="6" class="empty-state">
                <div class="empty-illustration" aria-hidden="true">üì¶</div>
                <p>No hay √≠tems que coincidan con los filtros.</p>
                <div class="empty-actions">
                  <button type="button" class="btn btn--outline" (click)="clearFilters()">Limpiar filtros</button>
                  <button type="button" class="btn btn--primary" (click)="create()">Crear el primero</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="loading" class="loading-overlay" aria-live="polite" role="status">
        <div class="spinner"></div> Cargando‚Ä¶
      </div>
    </section>
  </div>
</div>

<!-- Modal Crear/Editar -->
<div *ngIf="modalOpen" class="ux-modal" role="dialog" aria-modal="true" aria-labelledby="cat-item-modal-title">
  <div class="ux-modal__dialog">
    <header class="ux-modal__header">
      <h2 id="cat-item-modal-title">{{ editing ? 'Editar √çtem' : 'Nuevo √çtem' }}</h2>
      <button type="button" class="icon-btn" (click)="cancel()" aria-label="Cerrar">‚úï</button>
    </header>

    <form [formGroup]="form" (ngSubmit)="save()" class="ux-form" novalidate>
      <!-- Paso 1: Informaci√≥n B√°sica -->
      <div class="form-section">
        <h3 class="form-section__title">1. Informaci√≥n B√°sica</h3>
        <div class="grid grid-2">
          <div class="form-field">
            <label for="f-cod">C√≥digo *</label>
            <input id="f-cod" type="text" formControlName="codigo" [readonly]="editing" 
                   placeholder="Ej: ALI001" maxlength="10" />
            <small class="help" *ngIf="!editing">C√≥digo √∫nico del √≠tem (m√°x. 10 caracteres)</small>
            <small class="help" *ngIf="editing">El c√≥digo no se puede modificar</small>
          </div>

          <div class="form-field">
            <label for="f-nom">Nombre *</label>
            <input id="f-nom" type="text" formControlName="nombre" 
                   placeholder="Ej: Alimento Iniciador Pollos" maxlength="150" />
            <small class="help">Nombre descriptivo del √≠tem (m√°x. 150 caracteres)</small>
          </div>

          <div class="form-field">
            <label for="f-type">Tipo de √≠tem *</label>
            <select id="f-type" formControlName="type_item">
              <option [ngValue]="null" disabled>Seleccione un tipo...</option>
              <option *ngFor="let t of tiposItem" [ngValue]="t">{{ t | titlecase }}</option>
            </select>
            <small class="help">Se guardar√° como <code>type_item</code> en la metadata.</small>
          </div>

          <div class="form-field">
            <label for="f-act">Estado</label>
            <select id="f-act" formControlName="activo">
              <option [ngValue]="true">Activo</option>
              <option [ngValue]="false">Inactivo</option>
            </select>
            <small class="help">Los √≠tems inactivos no aparecer√°n en los movimientos</small>
          </div>
        </div>
      </div>

      <!-- Paso 2: Configuraci√≥n Espec√≠fica seg√∫n Tipo de Item -->
      
      <!-- Configuraci√≥n para ALIMENTO -->
      <div class="form-section" *ngIf="isAlimento">
        <h3 class="form-section__title">2. Configuraci√≥n de Alimento</h3>
        <div class="ux-card ux-card--sub">
          <div class="grid grid-3">
            <div class="form-field">
              <label for="f-especie">Especie *</label>
              <select id="f-especie" formControlName="especie">
                <option *ngFor="let e of especies" [ngValue]="e">{{ e | titlecase }}</option>
              </select>
              <small class="help">Tipo de animal para este alimento</small>
            </div>

            <div class="form-field">
              <label for="f-raza">Raza *</label>
              <select id="f-raza" formControlName="raza">
                <option *ngFor="let r of razas" [ngValue]="r">{{ r }}</option>
              </select>
              <small class="help">Raza para este alimento</small>
            </div>

            <div class="form-field">
              <label for="f-genero">G√©nero *</label>
              <select id="f-genero" formControlName="genero">
                <option *ngFor="let g of generos" [ngValue]="g">{{ g }}</option>
              </select>
              <small class="help">G√©nero objetivo del alimento</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuraci√≥n para MEDICAMENTO -->
      <div class="form-section" *ngIf="isMedicamento">
        <h3 class="form-section__title">2. Configuraci√≥n de Medicamento</h3>
        <div class="ux-card ux-card--sub">
          <div class="grid grid-3">
            <div class="form-field">
              <label for="f-tipo-medicamento">Tipo de Medicamento</label>
              <input id="f-tipo-medicamento" type="text" formControlName="tipo_medicamento" 
                     placeholder="Ej: Antibi√≥tico, Antiparasitario" maxlength="100" />
              <small class="help">Clasificaci√≥n del medicamento</small>
            </div>

            <div class="form-field">
              <label for="f-via-admin">V√≠a de Administraci√≥n</label>
              <input id="f-via-admin" type="text" formControlName="via_administracion" 
                     placeholder="Ej: Oral, Intramuscular" maxlength="100" />
              <small class="help">Forma de aplicaci√≥n del medicamento</small>
            </div>

            <div class="form-field">
              <label for="f-presentacion">Presentaci√≥n</label>
              <input id="f-presentacion" type="text" formControlName="presentacion" 
                     placeholder="Ej: Inyectable, Polvo" maxlength="100" />
              <small class="help">Forma f√≠sica del medicamento</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuraci√≥n para BIOL√ìGICO -->
      <div class="form-section" *ngIf="isBiologico">
        <h3 class="form-section__title">2. Configuraci√≥n de Biol√≥gico</h3>
        <div class="ux-card ux-card--sub">
          <div class="grid grid-3">
            <div class="form-field">
              <label for="f-tipo-biologico">Tipo de Biol√≥gico</label>
              <input id="f-tipo-biologico" type="text" formControlName="tipo_biologico" 
                     placeholder="Ej: Vacuna, Suero" maxlength="100" />
              <small class="help">Clasificaci√≥n del biol√≥gico</small>
            </div>

            <div class="form-field">
              <label for="f-via-aplicacion">V√≠a de Aplicaci√≥n</label>
              <input id="f-via-aplicacion" type="text" formControlName="via_aplicacion" 
                     placeholder="Ej: Subcut√°nea, Intramuscular" maxlength="100" />
              <small class="help">Forma de aplicaci√≥n del biol√≥gico</small>
            </div>

            <div class="form-field">
              <label for="f-temp-almacenamiento">Temperatura de Almacenamiento</label>
              <input id="f-temp-almacenamiento" type="text" formControlName="temperatura_almacenamiento" 
                     placeholder="Ej: 2-8¬∞C, Congelado" maxlength="50" />
              <small class="help">Condiciones de almacenamiento requeridas</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuraci√≥n para ACCESORIO -->
      <div class="form-section" *ngIf="isAccesorio">
        <h3 class="form-section__title">2. Configuraci√≥n de Accesorio</h3>
        <div class="ux-card ux-card--sub">
          <div class="grid grid-3">
            <div class="form-field">
              <label for="f-tipo-accesorio">Tipo de Accesorio</label>
              <input id="f-tipo-accesorio" type="text" formControlName="tipo_accesorio" 
                     placeholder="Ej: Bebedero, Comedero" maxlength="100" />
              <small class="help">Categor√≠a del accesorio</small>
            </div>

            <div class="form-field">
              <label for="f-material">Material</label>
              <input id="f-material" type="text" formControlName="material" 
                     placeholder="Ej: Pl√°stico, Acero" maxlength="100" />
              <small class="help">Material de fabricaci√≥n</small>
            </div>

            <div class="form-field">
              <label for="f-dimensiones">Dimensiones</label>
              <input id="f-dimensiones" type="text" formControlName="dimensiones" 
                     placeholder="Ej: 50x30x20 cm" maxlength="100" />
              <small class="help">Tama√±o o dimensiones del accesorio</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuraci√≥n para CONSUMIBLE -->
      <div class="form-section" *ngIf="isConsumible">
        <h3 class="form-section__title">2. Configuraci√≥n de Consumible</h3>
        <div class="ux-card ux-card--sub">
          <div class="grid grid-2">
            <div class="form-field">
              <label for="f-tipo-consumible">Tipo de Consumible</label>
              <input id="f-tipo-consumible" type="text" formControlName="tipo_consumible" 
                     placeholder="Ej: Desinfectante, Limpiador" maxlength="100" />
              <small class="help">Categor√≠a del consumible</small>
            </div>

            <div class="form-field">
              <label for="f-unidad-medida">Unidad de Medida</label>
              <input id="f-unidad-medida" type="text" formControlName="unidad_medida" 
                     placeholder="Ej: Litro, Kilogramo" maxlength="50" />
              <small class="help">Unidad est√°ndar de medida</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Paso 3: Metadata Adicional (Opcional) -->
      <div class="form-section">
        <h3 class="form-section__title">3. Metadata Adicional (Opcional)</h3>
        <div class="meta-editor">
          <div class="meta-header">
            <span>Informaci√≥n adicional personalizada</span>
            <button type="button" class="btn btn--ghost btn--sm" (click)="addMetaRow()">
              <fa-icon [icon]="faPlus" class="mr-1"></fa-icon>
              Agregar campo
            </button>
          </div>

          <div class="meta-rows" formArrayName="metadata">
            <div class="meta-row" *ngFor="let row of metadataArray.controls; index as i" [formGroupName]="i">
              <input type="text" placeholder="Clave (ej: fabricante, unidad)" formControlName="key" 
                     class="meta-key" maxlength="50" />
              <input type="text" placeholder="Valor (ej: SanMarino, kg)" formControlName="value" 
                     class="meta-value" maxlength="500" />
              <button type="button" class="icon-btn icon-btn--danger" (click)="removeMetaRow(i)" 
                      title="Eliminar campo" aria-label="Eliminar">
                <fa-icon [icon]="faTrash"></fa-icon>
              </button>
            </div>
            <div class="meta-empty" *ngIf="metadataArray.length === 0">
              <p class="meta-empty-text">No hay campos adicionales. Haga clic en "Agregar campo" para a√±adir informaci√≥n personalizada.</p>
            </div>
          </div>
          <small class="help">
            <strong>Claves reservadas:</strong> <code>type_item</code>, <code>especie</code>, <code>raza</code>, <code>genero</code>.
            Estas se gestionan autom√°ticamente seg√∫n el tipo seleccionado.
          </small>
        </div>
      </div>

      <!-- Vista previa JSON (colapsable) -->
      <div class="form-section">
        <details class="json-preview-section">
          <summary class="json-preview-toggle">Vista previa de metadata (JSON)</summary>
          <pre class="json-preview">{{ jsonPreview() }}</pre>
        </details>
      </div>

      <footer class="ux-modal__footer">
        <button type="button" class="btn btn--ghost" (click)="cancel()">Cancelar</button>
        <button type="submit" class="btn btn--primary" [disabled]="loading || form.invalid">Guardar</button>
      </footer>
    </form>

    <div *ngIf="loading" class="modal-loading" role="status" aria-live="polite">
      <div class="spinner"></div> Guardando‚Ä¶
    </div>
  </div>
</div>
